{"version":3,"file":"index-lnH6CvBX.js","sources":["../../src/components/empty/EmptyState.ts","../../src/components/filters/types.ts","../../src/components/filters/FilterPanel.ts","../../src/components/forms/types.ts","../../src/components/forms/BehaviourForm.ts","../../src/components/forms/OutcomeForm.ts","../../src/components/forms/ValueForm.ts","../../src/components/forms/LinkForm.ts","../../src/components/forms/NodeDetailPanel.ts","../../src/components/graph/data.ts","../../src/components/graph/nodes.ts","../../src/components/graph/theme.ts","../../src/components/graph/edges.ts","../../src/components/graph/layout.ts","../../src/components/graph/legend.ts","../../src/components/graph/NetworkGraph.ts","../../src/metrics/mappings.ts","../../src/metrics/paths.ts","../../src/metrics/metrics.ts","../../src/components/insights/InsightsPanel.ts","../../src/components/ladder/types.ts","../../src/components/ladder/WhyLadder.ts","../../src/validation/types.ts","../../src/validation/validate.ts","../../src/components/validation/ValidationPanel.ts","../../src/components/welcome/WelcomeScreen.ts","../../src/utils/id.ts","../../src/data/behaviours.ts","../../src/data/network.ts","../../src/data/storage.ts","../../src/data/export.ts","../../src/data/links.ts","../../src/data/outcomes.ts","../../src/data/values.ts","../../src/main.ts"],"sourcesContent":["/**\r\n * Empty State Component\r\n * Displayed when the network has no nodes\r\n */\r\n\r\nexport interface EmptyStateCallbacks {\r\n  onAddBehaviour: () => void;\r\n  onStartWhyLadder: () => void;\r\n  onImportData: () => void;\r\n}\r\n\r\nexport class EmptyState {\r\n  private container: HTMLElement;\r\n  private element: HTMLElement | null = null;\r\n  private callbacks: EmptyStateCallbacks;\r\n\r\n  constructor(container: HTMLElement, callbacks: EmptyStateCallbacks) {\r\n    this.container = container;\r\n    this.callbacks = callbacks;\r\n  }\r\n\r\n  show(): void {\r\n    if (this.element !== null) {\r\n      this.element.classList.remove('hidden');\r\n      const existingAddButton = this.element.querySelector<HTMLButtonElement>('#btn-empty-add-behaviour');\r\n      existingAddButton?.focus();\r\n      return;\r\n    }\r\n\r\n    this.element = document.createElement('div');\r\n    this.element.className = 'empty-state';\r\n    this.element.setAttribute('role', 'status');\r\n    this.element.setAttribute('aria-live', 'polite');\r\n    this.element.innerHTML = `\r\n      <div class=\"empty-state-content\">\r\n        <svg class=\"empty-state-icon\" width=\"120\" height=\"120\" viewBox=\"0 0 120 120\" aria-hidden=\"true\">\r\n          <circle cx=\"30\" cy=\"60\" r=\"8\" fill=\"var(--color-behaviour)\" opacity=\"0.3\" />\r\n          <circle cx=\"60\" cy=\"60\" r=\"8\" fill=\"var(--color-outcome)\" opacity=\"0.3\" />\r\n          <circle cx=\"90\" cy=\"60\" r=\"8\" fill=\"var(--color-value)\" opacity=\"0.3\" />\r\n          <path d=\"M 38 60 L 52 60\" stroke=\"var(--color-text-secondary)\" stroke-width=\"2\" opacity=\"0.3\" stroke-dasharray=\"3,3\" />\r\n          <path d=\"M 68 60 L 82 60\" stroke=\"var(--color-text-secondary)\" stroke-width=\"2\" opacity=\"0.3\" stroke-dasharray=\"3,3\" />\r\n        </svg>\r\n        \r\n        <h2 class=\"empty-state-title\">Your network is empty</h2>\r\n        <p class=\"empty-state-description\">\r\n          Start building your means-ends network by adding your first behaviour.\r\n        </p>\r\n\r\n        <div class=\"empty-state-actions\">\r\n          <button id=\"btn-empty-add-behaviour\" class=\"btn btn-primary\" aria-label=\"Add your first behaviour\">\r\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"currentColor\" aria-hidden=\"true\">\r\n              <path d=\"M8 2v12M2 8h12\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\"/>\r\n            </svg>\r\n            Add First Behaviour\r\n          </button>\r\n          <button id=\"btn-empty-why-ladder\" class=\"btn btn-secondary\" aria-label=\"Start Why Ladder guided mode\">\r\n            Start Why Ladder\r\n          </button>\r\n          <button id=\"btn-empty-import\" class=\"btn btn-secondary\" aria-label=\"Import existing data\">\r\n            Import Data\r\n          </button>\r\n        </div>\r\n\r\n        <div class=\"empty-state-tips\">\r\n          <h3 class=\"empty-state-tips-title\">Quick Start Tips:</h3>\r\n          <ul class=\"empty-state-tips-list\">\r\n            <li>Think of a daily habit or action you perform regularly</li>\r\n            <li>Use the Why Ladder mode to quickly map outcomes and values</li>\r\n            <li>The sidebar helps you add nodes and view insights as you build</li>\r\n          </ul>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    this.container.appendChild(this.element);\r\n\r\n    // Wire event handlers\r\n    const addBehaviourBtn = this.element.querySelector<HTMLButtonElement>('#btn-empty-add-behaviour');\r\n    const whyLadderBtn = this.element.querySelector<HTMLButtonElement>('#btn-empty-why-ladder');\r\n    const importBtn = this.element.querySelector<HTMLButtonElement>('#btn-empty-import');\r\n\r\n    if (addBehaviourBtn !== null) {\r\n      addBehaviourBtn.addEventListener('click', () => {\r\n        this.callbacks.onAddBehaviour();\r\n      });\r\n    }\r\n\r\n    if (whyLadderBtn !== null) {\r\n      whyLadderBtn.addEventListener('click', () => {\r\n        this.callbacks.onStartWhyLadder();\r\n      });\r\n    }\r\n\r\n    if (importBtn !== null) {\r\n      importBtn.addEventListener('click', () => {\r\n        this.callbacks.onImportData();\r\n      });\r\n    }\r\n\r\n    // Focus the primary action\r\n    addBehaviourBtn?.focus();\r\n  }\r\n\r\n  hide(): void {\r\n    if (this.element !== null) {\r\n      this.element.classList.add('hidden');\r\n    }\r\n  }\r\n\r\n  destroy(): void {\r\n    if (this.element !== null) {\r\n      this.element.remove();\r\n      this.element = null;\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Filter & Search Types\r\n *\r\n * Types for filtering and searching the network visualization.\r\n * See docs/visual-design.md §5.4, §5.5, §5.6\r\n */\r\n\r\nimport type { NodeType } from '@/types';\r\n\r\n// ============================================================================\r\n// Filter State\r\n// ============================================================================\r\n\r\n/**\r\n * Node type visibility filter.\r\n * When true, nodes of that type are visible.\r\n */\r\nexport interface NodeTypeFilter {\r\n  behaviour: boolean;\r\n  outcome: boolean;\r\n  value: boolean;\r\n}\r\n\r\n/**\r\n * Edge valence visibility filter.\r\n * When true, edges of that valence are visible.\r\n */\r\nexport interface ValenceFilter {\r\n  positive: boolean;\r\n  negative: boolean;\r\n}\r\n\r\n/**\r\n * Highlight modes - only one can be active at a time.\r\n */\r\nexport type HighlightMode = 'none' | 'leverage' | 'fragile' | 'conflicts';\r\n\r\n/**\r\n * Complete filter state.\r\n */\r\nexport interface FilterState {\r\n  /** Node type visibility */\r\n  nodeTypes: NodeTypeFilter;\r\n\r\n  /** Edge valence visibility */\r\n  valence: ValenceFilter;\r\n\r\n  /** Search query (case-insensitive substring match) */\r\n  searchQuery: string;\r\n\r\n  /** Active highlight mode */\r\n  highlightMode: HighlightMode;\r\n}\r\n\r\n// ============================================================================\r\n// Factory Functions\r\n// ============================================================================\r\n\r\n/**\r\n * Create default filter state (everything visible, no search, no highlight).\r\n */\r\nexport function createDefaultFilterState(): FilterState {\r\n  return {\r\n    nodeTypes: {\r\n      behaviour: true,\r\n      outcome: true,\r\n      value: true,\r\n    },\r\n    valence: {\r\n      positive: true,\r\n      negative: true,\r\n    },\r\n    searchQuery: '',\r\n    highlightMode: 'none',\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Filter Logic\r\n// ============================================================================\r\n\r\n/**\r\n * Check if a node should be visible based on filter state.\r\n */\r\nexport function isNodeVisible(nodeType: NodeType, filter: FilterState): boolean {\r\n  return filter.nodeTypes[nodeType];\r\n}\r\n\r\n/**\r\n * Check if a node matches the search query.\r\n * Returns true if search is empty or label contains query (case-insensitive).\r\n */\r\nexport function nodeMatchesSearch(label: string, query: string): boolean {\r\n  if (query.trim() === '') {\r\n    return true;\r\n  }\r\n  return label.toLowerCase().includes(query.toLowerCase().trim());\r\n}\r\n\r\n/**\r\n * Check if an edge should be visible based on filter state.\r\n * An edge is visible if:\r\n * - Its valence is enabled in the filter\r\n * - Both source and target nodes are visible\r\n */\r\nexport function isEdgeVisible(\r\n  valence: 'positive' | 'negative',\r\n  sourceType: NodeType,\r\n  targetType: NodeType,\r\n  filter: FilterState\r\n): boolean {\r\n  // Check valence filter\r\n  if (!filter.valence[valence]) {\r\n    return false;\r\n  }\r\n\r\n  // Check if both endpoints are visible\r\n  if (!isNodeVisible(sourceType, filter) || !isNodeVisible(targetType, filter)) {\r\n    return false;\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\n/**\r\n * Determine if a node should be dimmed.\r\n * A node is dimmed when:\r\n * - Search is active and node doesn't match\r\n * - Highlight mode is active and node is not in highlighted set\r\n */\r\nexport function shouldDimNode(\r\n  label: string,\r\n  nodeId: string,\r\n  filter: FilterState,\r\n  highlightedNodeIds: Set<string>\r\n): boolean {\r\n  // If search is active, dim non-matching nodes\r\n  if (filter.searchQuery.trim() !== '') {\r\n    if (!nodeMatchesSearch(label, filter.searchQuery)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  // If highlight mode is active, dim non-highlighted nodes\r\n  if (filter.highlightMode !== 'none' && highlightedNodeIds.size > 0) {\r\n    if (!highlightedNodeIds.has(nodeId)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n","/**\r\n * FilterPanel Component\r\n *\r\n * UI component for filtering and searching the network visualization.\r\n * Per visual-design.md §5.4, §5.5, §5.6 specification.\r\n */\r\n\r\nimport type { Network } from '@/types';\r\n\r\nimport {\r\n  createDefaultFilterState,\r\n  type FilterState,\r\n  type HighlightMode,\r\n} from './types';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface FilterPanelCallbacks {\r\n  /** Called when filter state changes */\r\n  onFilterChange: (filter: FilterState) => void;\r\n}\r\n\r\nexport interface FilterPanelOptions {\r\n  network: Network;\r\n  callbacks: FilterPanelCallbacks;\r\n}\r\n\r\n// ============================================================================\r\n// FilterPanel Component\r\n// ============================================================================\r\n\r\nexport class FilterPanel {\r\n  private container: HTMLElement;\r\n  private network: Network;\r\n  private callbacks: FilterPanelCallbacks;\r\n  private filterState: FilterState;\r\n\r\n  constructor(container: HTMLElement, options: FilterPanelOptions) {\r\n    this.container = container;\r\n    this.network = options.network;\r\n    this.callbacks = options.callbacks;\r\n    this.filterState = createDefaultFilterState();\r\n\r\n    this.render();\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Public API\r\n  // ==========================================================================\r\n\r\n  /**\r\n   * Update the network data.\r\n   */\r\n  public setNetwork(network: Network): void {\r\n    this.network = network;\r\n    // Re-render to update counts\r\n    this.render();\r\n  }\r\n\r\n  /**\r\n   * Get current filter state.\r\n   */\r\n  public getFilterState(): FilterState {\r\n    return { ...this.filterState };\r\n  }\r\n\r\n  /**\r\n   * Reset all filters to default.\r\n   */\r\n  public reset(): void {\r\n    this.filterState = createDefaultFilterState();\r\n    this.render();\r\n    this.emitChange();\r\n  }\r\n\r\n  /**\r\n   * Clear search query.\r\n   */\r\n  public clearSearch(): void {\r\n    this.filterState.searchQuery = '';\r\n    this.render();\r\n    this.emitChange();\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Private Methods\r\n  // ==========================================================================\r\n\r\n  private render(): void {\r\n    const { nodeTypes, valence, searchQuery, highlightMode } = this.filterState;\r\n\r\n    // Count nodes by type\r\n    const behaviourCount = this.network.behaviours.length;\r\n    const outcomeCount = this.network.outcomes.length;\r\n    const valueCount = this.network.values.length;\r\n\r\n    // Count edges by valence\r\n    const positiveCount = this.network.links.filter((l) => l.valence === 'positive').length;\r\n    const negativeCount = this.network.links.filter((l) => l.valence === 'negative').length;\r\n\r\n    this.container.innerHTML = `\r\n      <div class=\"filter-panel\">\r\n        <!-- Search Box -->\r\n        <div class=\"filter-section search-section\">\r\n          <label class=\"filter-label\" for=\"filter-search\">Search</label>\r\n          <div class=\"search-input-wrapper\">\r\n            <input\r\n              type=\"text\"\r\n              id=\"filter-search\"\r\n              class=\"filter-search-input\"\r\n              placeholder=\"Search nodes...\"\r\n              value=\"${this.escapeHtml(searchQuery)}\"\r\n              aria-label=\"Search nodes by label\"\r\n            />\r\n            <button\r\n              class=\"search-clear-btn ${searchQuery === '' ? 'hidden' : ''}\"\r\n              aria-label=\"Clear search\"\r\n              title=\"Clear search\"\r\n            >\r\n              ✕\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Node Type Filters -->\r\n        <div class=\"filter-section\">\r\n          <span class=\"filter-label\">Show Nodes</span>\r\n          <div class=\"filter-checkboxes\">\r\n            <label class=\"filter-checkbox\">\r\n              <input\r\n                type=\"checkbox\"\r\n                id=\"filter-behaviour\"\r\n                ${nodeTypes.behaviour ? 'checked' : ''}\r\n              />\r\n              <span class=\"checkbox-label behaviour\">Behaviours (${behaviourCount})</span>\r\n            </label>\r\n            <label class=\"filter-checkbox\">\r\n              <input\r\n                type=\"checkbox\"\r\n                id=\"filter-outcome\"\r\n                ${nodeTypes.outcome ? 'checked' : ''}\r\n              />\r\n              <span class=\"checkbox-label outcome\">Outcomes (${outcomeCount})</span>\r\n            </label>\r\n            <label class=\"filter-checkbox\">\r\n              <input\r\n                type=\"checkbox\"\r\n                id=\"filter-value\"\r\n                ${nodeTypes.value ? 'checked' : ''}\r\n              />\r\n              <span class=\"checkbox-label value\">Values (${valueCount})</span>\r\n            </label>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Valence Filters -->\r\n        <div class=\"filter-section\">\r\n          <span class=\"filter-label\">Show Edges</span>\r\n          <div class=\"filter-checkboxes\">\r\n            <label class=\"filter-checkbox\">\r\n              <input\r\n                type=\"checkbox\"\r\n                id=\"filter-positive\"\r\n                ${valence.positive ? 'checked' : ''}\r\n              />\r\n              <span class=\"checkbox-label positive\">Positive (${positiveCount})</span>\r\n            </label>\r\n            <label class=\"filter-checkbox\">\r\n              <input\r\n                type=\"checkbox\"\r\n                id=\"filter-negative\"\r\n                ${valence.negative ? 'checked' : ''}\r\n              />\r\n              <span class=\"checkbox-label negative\">Negative (${negativeCount})</span>\r\n            </label>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Highlight Modes -->\r\n        <div class=\"filter-section\">\r\n          <span class=\"filter-label\">Highlight</span>\r\n          <div class=\"filter-radio-group\">\r\n            <label class=\"filter-radio\">\r\n              <input\r\n                type=\"radio\"\r\n                name=\"highlight-mode\"\r\n                value=\"none\"\r\n                ${highlightMode === 'none' ? 'checked' : ''}\r\n              />\r\n              <span class=\"radio-label\">None</span>\r\n            </label>\r\n            <label class=\"filter-radio\">\r\n              <input\r\n                type=\"radio\"\r\n                name=\"highlight-mode\"\r\n                value=\"leverage\"\r\n                ${highlightMode === 'leverage' ? 'checked' : ''}\r\n              />\r\n              <span class=\"radio-label leverage\">High Leverage</span>\r\n            </label>\r\n            <label class=\"filter-radio\">\r\n              <input\r\n                type=\"radio\"\r\n                name=\"highlight-mode\"\r\n                value=\"fragile\"\r\n                ${highlightMode === 'fragile' ? 'checked' : ''}\r\n              />\r\n              <span class=\"radio-label fragile\">Fragile Values</span>\r\n            </label>\r\n            <label class=\"filter-radio\">\r\n              <input\r\n                type=\"radio\"\r\n                name=\"highlight-mode\"\r\n                value=\"conflicts\"\r\n                ${highlightMode === 'conflicts' ? 'checked' : ''}\r\n              />\r\n              <span class=\"radio-label conflicts\">Conflicts</span>\r\n            </label>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Reset Button -->\r\n        <div class=\"filter-actions\">\r\n          <button class=\"filter-reset-btn\" aria-label=\"Reset all filters\">\r\n            Reset Filters\r\n          </button>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    this.attachEventListeners();\r\n  }\r\n\r\n  private attachEventListeners(): void {\r\n    // Search input\r\n    const searchInput = this.container.querySelector<HTMLInputElement>('#filter-search');\r\n    if (searchInput) {\r\n      searchInput.addEventListener('input', (e) => {\r\n        this.filterState.searchQuery = (e.target as HTMLInputElement).value;\r\n        this.updateClearButton();\r\n        this.emitChange();\r\n      });\r\n\r\n      // Handle Escape key to clear search\r\n      searchInput.addEventListener('keydown', (e) => {\r\n        if (e.key === 'Escape') {\r\n          this.clearSearch();\r\n        }\r\n      });\r\n    }\r\n\r\n    // Clear search button\r\n    const clearBtn = this.container.querySelector<HTMLButtonElement>('.search-clear-btn');\r\n    if (clearBtn) {\r\n      clearBtn.addEventListener('click', () => {\r\n        this.clearSearch();\r\n      });\r\n    }\r\n\r\n    // Node type checkboxes\r\n    const behaviourCb = this.container.querySelector<HTMLInputElement>('#filter-behaviour');\r\n    const outcomeCb = this.container.querySelector<HTMLInputElement>('#filter-outcome');\r\n    const valueCb = this.container.querySelector<HTMLInputElement>('#filter-value');\r\n\r\n    behaviourCb?.addEventListener('change', (e) => {\r\n      this.filterState.nodeTypes.behaviour = (e.target as HTMLInputElement).checked;\r\n      this.emitChange();\r\n    });\r\n\r\n    outcomeCb?.addEventListener('change', (e) => {\r\n      this.filterState.nodeTypes.outcome = (e.target as HTMLInputElement).checked;\r\n      this.emitChange();\r\n    });\r\n\r\n    valueCb?.addEventListener('change', (e) => {\r\n      this.filterState.nodeTypes.value = (e.target as HTMLInputElement).checked;\r\n      this.emitChange();\r\n    });\r\n\r\n    // Valence checkboxes\r\n    const positiveCb = this.container.querySelector<HTMLInputElement>('#filter-positive');\r\n    const negativeCb = this.container.querySelector<HTMLInputElement>('#filter-negative');\r\n\r\n    positiveCb?.addEventListener('change', (e) => {\r\n      this.filterState.valence.positive = (e.target as HTMLInputElement).checked;\r\n      this.emitChange();\r\n    });\r\n\r\n    negativeCb?.addEventListener('change', (e) => {\r\n      this.filterState.valence.negative = (e.target as HTMLInputElement).checked;\r\n      this.emitChange();\r\n    });\r\n\r\n    // Highlight mode radios\r\n    const radios = this.container.querySelectorAll<HTMLInputElement>('input[name=\"highlight-mode\"]');\r\n    radios.forEach((radio) => {\r\n      radio.addEventListener('change', (e) => {\r\n        this.filterState.highlightMode = (e.target as HTMLInputElement).value as HighlightMode;\r\n        this.emitChange();\r\n      });\r\n    });\r\n\r\n    // Reset button\r\n    const resetBtn = this.container.querySelector<HTMLButtonElement>('.filter-reset-btn');\r\n    if (resetBtn) {\r\n      resetBtn.addEventListener('click', () => {\r\n        this.reset();\r\n      });\r\n    }\r\n  }\r\n\r\n  private updateClearButton(): void {\r\n    const clearBtn = this.container.querySelector<HTMLButtonElement>('.search-clear-btn');\r\n    if (clearBtn) {\r\n      clearBtn.classList.toggle('hidden', this.filterState.searchQuery === '');\r\n    }\r\n  }\r\n\r\n  private emitChange(): void {\r\n    this.callbacks.onFilterChange({ ...this.filterState });\r\n  }\r\n\r\n  private escapeHtml(text: string): string {\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n}\r\n","/**\r\n * Form Types and Shared Utilities\r\n *\r\n * Common types used across all form components.\r\n */\r\n\r\nimport type {\r\n  Behaviour,\r\n  Cost,\r\n  Frequency,\r\n  Importance,\r\n  Neglect,\r\n  Network,\r\n  Node,\r\n  Outcome,\r\n  Reliability,\r\n  Strength,\r\n  Valence,\r\n  Value,\r\n} from '@/types';\r\n\r\n// ============================================================================\r\n// Form Mode\r\n// ============================================================================\r\n\r\nexport type FormMode = 'create' | 'edit';\r\n\r\n// ============================================================================\r\n// Form State\r\n// ============================================================================\r\n\r\nexport interface FormError {\r\n  field: string;\r\n  message: string;\r\n}\r\n\r\nexport interface FormState {\r\n  isValid: boolean;\r\n  isDirty: boolean;\r\n  errors: FormError[];\r\n}\r\n\r\n// ============================================================================\r\n// Behaviour Form\r\n// ============================================================================\r\n\r\nexport interface BehaviourFormData {\r\n  label: string;\r\n  frequency: Frequency;\r\n  cost: Cost;\r\n  contextTags: string[];\r\n  notes: string;\r\n}\r\n\r\nexport const defaultBehaviourFormData: BehaviourFormData = {\r\n  label: '',\r\n  frequency: 'weekly',\r\n  cost: 'low',\r\n  contextTags: [],\r\n  notes: '',\r\n};\r\n\r\nexport function behaviourToFormData(behaviour: Behaviour): BehaviourFormData {\r\n  return {\r\n    label: behaviour.label,\r\n    frequency: behaviour.frequency,\r\n    cost: behaviour.cost,\r\n    contextTags: [...behaviour.contextTags],\r\n    notes: behaviour.notes ?? '',\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Outcome Form\r\n// ============================================================================\r\n\r\nexport interface OutcomeFormData {\r\n  label: string;\r\n  notes: string;\r\n}\r\n\r\nexport const defaultOutcomeFormData: OutcomeFormData = {\r\n  label: '',\r\n  notes: '',\r\n};\r\n\r\nexport function outcomeToFormData(outcome: Outcome): OutcomeFormData {\r\n  return {\r\n    label: outcome.label,\r\n    notes: outcome.notes ?? '',\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Value Form\r\n// ============================================================================\r\n\r\nexport interface ValueFormData {\r\n  label: string;\r\n  importance: Importance;\r\n  neglect: Neglect;\r\n  notes: string;\r\n}\r\n\r\nexport const defaultValueFormData: ValueFormData = {\r\n  label: '',\r\n  importance: 'medium',\r\n  neglect: 'adequately-met',\r\n  notes: '',\r\n};\r\n\r\nexport function valueToFormData(value: Value): ValueFormData {\r\n  return {\r\n    label: value.label,\r\n    importance: value.importance,\r\n    neglect: value.neglect,\r\n    notes: value.notes ?? '',\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Link Form\r\n// ============================================================================\r\n\r\nexport interface BehaviourOutcomeLinkFormData {\r\n  type: 'behaviour-outcome';\r\n  sourceId: string;\r\n  targetId: string;\r\n  valence: Valence;\r\n  reliability: Reliability;\r\n}\r\n\r\nexport interface OutcomeValueLinkFormData {\r\n  type: 'outcome-value';\r\n  sourceId: string;\r\n  targetId: string;\r\n  valence: Valence;\r\n  strength: Strength;\r\n}\r\n\r\nexport type LinkFormData = BehaviourOutcomeLinkFormData | OutcomeValueLinkFormData;\r\n\r\nexport const defaultBehaviourOutcomeLinkFormData: BehaviourOutcomeLinkFormData = {\r\n  type: 'behaviour-outcome',\r\n  sourceId: '',\r\n  targetId: '',\r\n  valence: 'positive',\r\n  reliability: 'usually',\r\n};\r\n\r\nexport const defaultOutcomeValueLinkFormData: OutcomeValueLinkFormData = {\r\n  type: 'outcome-value',\r\n  sourceId: '',\r\n  targetId: '',\r\n  valence: 'positive',\r\n  strength: 'moderate',\r\n};\r\n\r\n// ============================================================================\r\n// Form Callbacks\r\n// ============================================================================\r\n\r\nexport interface BehaviourFormCallbacks {\r\n  onSave: (data: BehaviourFormData) => void;\r\n  onCancel: () => void;\r\n  onDelete?: () => void;\r\n}\r\n\r\nexport interface OutcomeFormCallbacks {\r\n  onSave: (data: OutcomeFormData) => void;\r\n  onCancel: () => void;\r\n  onDelete?: () => void;\r\n}\r\n\r\nexport interface ValueFormCallbacks {\r\n  onSave: (data: ValueFormData) => void;\r\n  onCancel: () => void;\r\n  onDelete?: () => void;\r\n}\r\n\r\nexport interface LinkFormCallbacks {\r\n  onSave: (data: LinkFormData) => void;\r\n  onCancel: () => void;\r\n  onDelete?: () => void;\r\n}\r\n\r\n// ============================================================================\r\n// Select Options\r\n// ============================================================================\r\n\r\nexport interface SelectOption<T extends string> {\r\n  value: T;\r\n  label: string;\r\n}\r\n\r\nexport const frequencyOptions: SelectOption<Frequency>[] = [\r\n  { value: 'daily', label: 'Daily' },\r\n  { value: 'weekly', label: 'Weekly' },\r\n  { value: 'monthly', label: 'Monthly' },\r\n  { value: 'occasionally', label: 'Occasionally' },\r\n  { value: 'rarely', label: 'Rarely' },\r\n];\r\n\r\nexport const costOptions: SelectOption<Cost>[] = [\r\n  { value: 'trivial', label: 'Trivial' },\r\n  { value: 'low', label: 'Low' },\r\n  { value: 'medium', label: 'Medium' },\r\n  { value: 'high', label: 'High' },\r\n  { value: 'very-high', label: 'Very High' },\r\n];\r\n\r\nexport const importanceOptions: SelectOption<Importance>[] = [\r\n  { value: 'critical', label: 'Critical' },\r\n  { value: 'high', label: 'High' },\r\n  { value: 'medium', label: 'Medium' },\r\n  { value: 'low', label: 'Low' },\r\n];\r\n\r\nexport const neglectOptions: SelectOption<Neglect>[] = [\r\n  { value: 'severely-neglected', label: 'Severely Neglected' },\r\n  { value: 'somewhat-neglected', label: 'Somewhat Neglected' },\r\n  { value: 'adequately-met', label: 'Adequately Met' },\r\n  { value: 'well-satisfied', label: 'Well Satisfied' },\r\n];\r\n\r\nexport const valenceOptions: SelectOption<Valence>[] = [\r\n  { value: 'positive', label: 'Positive (+)' },\r\n  { value: 'negative', label: 'Negative (−)' },\r\n];\r\n\r\nexport const reliabilityOptions: SelectOption<Reliability>[] = [\r\n  { value: 'always', label: 'Always' },\r\n  { value: 'usually', label: 'Usually' },\r\n  { value: 'sometimes', label: 'Sometimes' },\r\n  { value: 'rarely', label: 'Rarely' },\r\n];\r\n\r\nexport const strengthOptions: SelectOption<Strength>[] = [\r\n  { value: 'strong', label: 'Strong' },\r\n  { value: 'moderate', label: 'Moderate' },\r\n  { value: 'weak', label: 'Weak' },\r\n];\r\n\r\n// ============================================================================\r\n// Autocomplete\r\n// ============================================================================\r\n\r\nexport interface AutocompleteItem {\r\n  id: string;\r\n  label: string;\r\n  type: 'behaviour' | 'outcome' | 'value';\r\n}\r\n\r\n/**\r\n * Get autocomplete suggestions from network nodes.\r\n */\r\nexport function getAutocompleteSuggestions(\r\n  network: Network,\r\n  nodeType: 'behaviour' | 'outcome' | 'value',\r\n  query: string,\r\n  excludeIds: string[] = []\r\n): AutocompleteItem[] {\r\n  const normalizedQuery = query.toLowerCase().trim();\r\n\r\n  let nodes: Node[];\r\n  switch (nodeType) {\r\n    case 'behaviour':\r\n      nodes = network.behaviours;\r\n      break;\r\n    case 'outcome':\r\n      nodes = network.outcomes;\r\n      break;\r\n    case 'value':\r\n      nodes = network.values;\r\n      break;\r\n  }\r\n\r\n  return nodes\r\n    .filter((node) => !excludeIds.includes(node.id))\r\n    .filter((node) => normalizedQuery === '' || node.label.toLowerCase().includes(normalizedQuery))\r\n    .map((node) => ({\r\n      id: node.id,\r\n      label: node.label,\r\n      type: nodeType,\r\n    }))\r\n    .slice(0, 10); // Limit to 10 suggestions\r\n}\r\n\r\n// ============================================================================\r\n// Validation Helpers\r\n// ============================================================================\r\n\r\n/**\r\n * Validate a label field.\r\n */\r\nexport function validateLabel(label: string, existingLabels: string[], currentLabel?: string): FormError | null {\r\n  const trimmed = label.trim();\r\n\r\n  if (!trimmed) {\r\n    return { field: 'label', message: 'Label is required' };\r\n  }\r\n\r\n  if (trimmed.length > 100) {\r\n    return { field: 'label', message: 'Label must be 100 characters or less' };\r\n  }\r\n\r\n  // Check for duplicates (case-insensitive), excluding current label during edit\r\n  const normalized = trimmed.toLowerCase();\r\n  const isDuplicate = existingLabels.some(\r\n    (existing) => existing.toLowerCase() === normalized && existing.toLowerCase() !== currentLabel?.toLowerCase()\r\n  );\r\n\r\n  if (isDuplicate) {\r\n    return { field: 'label', message: 'A node with this label already exists' };\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Check if a link already exists between two nodes.\r\n */\r\nexport function linkExists(network: Network, sourceId: string, targetId: string): boolean {\r\n  return network.links.some((link) => link.sourceId === sourceId && link.targetId === targetId);\r\n}\r\n\r\n/**\r\n * Get labels for a specific node type from the network.\r\n */\r\nexport function getLabelsForType(network: Network, nodeType: 'behaviour' | 'outcome' | 'value'): string[] {\r\n  switch (nodeType) {\r\n    case 'behaviour':\r\n      return network.behaviours.map((b) => b.label);\r\n    case 'outcome':\r\n      return network.outcomes.map((o) => o.label);\r\n    case 'value':\r\n      return network.values.map((v) => v.label);\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Node Detail Helpers\r\n// ============================================================================\r\n\r\nexport interface ConnectedNode {\r\n  id: string;\r\n  label: string;\r\n  type: 'behaviour' | 'outcome' | 'value';\r\n  linkId: string;\r\n  valence: Valence;\r\n  reliability?: Reliability;\r\n  strength?: Strength;\r\n  direction: 'incoming' | 'outgoing';\r\n}\r\n\r\n/**\r\n * Get all nodes connected to a given node.\r\n */\r\nexport function getConnectedNodes(network: Network, nodeId: string): ConnectedNode[] {\r\n  const connected: ConnectedNode[] = [];\r\n\r\n  for (const link of network.links) {\r\n    if (link.sourceId === nodeId) {\r\n      // Outgoing link\r\n      const target = findNode(network, link.targetId);\r\n      if (target) {\r\n        connected.push({\r\n          id: target.id,\r\n          label: target.label,\r\n          type: target.type,\r\n          linkId: link.id,\r\n          valence: link.valence,\r\n          reliability: link.type === 'behaviour-outcome' ? link.reliability : undefined,\r\n          strength: link.type === 'outcome-value' ? link.strength : undefined,\r\n          direction: 'outgoing',\r\n        });\r\n      }\r\n    } else if (link.targetId === nodeId) {\r\n      // Incoming link\r\n      const source = findNode(network, link.sourceId);\r\n      if (source) {\r\n        connected.push({\r\n          id: source.id,\r\n          label: source.label,\r\n          type: source.type,\r\n          linkId: link.id,\r\n          valence: link.valence,\r\n          reliability: link.type === 'behaviour-outcome' ? link.reliability : undefined,\r\n          strength: link.type === 'outcome-value' ? link.strength : undefined,\r\n          direction: 'incoming',\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  return connected;\r\n}\r\n\r\n/**\r\n * Find a node by ID across all node types.\r\n */\r\nexport function findNode(network: Network, nodeId: string): Node | undefined {\r\n  return (\r\n    network.behaviours.find((b) => b.id === nodeId) ??\r\n    network.outcomes.find((o) => o.id === nodeId) ??\r\n    network.values.find((v) => v.id === nodeId)\r\n  );\r\n}\r\n","/**\r\n * Behaviour Form Component\r\n *\r\n * Form for creating and editing Behaviour entities.\r\n */\r\n\r\nimport type { Network } from '@/types';\r\n\r\nimport {\r\n  BehaviourFormCallbacks,\r\n  BehaviourFormData,\r\n  FormError,\r\n  FormMode,\r\n  costOptions,\r\n  defaultBehaviourFormData,\r\n  frequencyOptions,\r\n  getLabelsForType,\r\n  validateLabel,\r\n} from './types';\r\n\r\nexport interface BehaviourFormOptions {\r\n  mode: FormMode;\r\n  network: Network;\r\n  initialData?: BehaviourFormData;\r\n  callbacks: BehaviourFormCallbacks;\r\n}\r\n\r\nexport class BehaviourForm {\r\n  private container: HTMLElement;\r\n  private mode: FormMode;\r\n  private network: Network;\r\n  private data: BehaviourFormData;\r\n  private originalLabel?: string;\r\n  private callbacks: BehaviourFormCallbacks;\r\n  private errors: FormError[] = [];\r\n\r\n  constructor(container: HTMLElement, options: BehaviourFormOptions) {\r\n    this.container = container;\r\n    this.mode = options.mode;\r\n    this.network = options.network;\r\n    this.callbacks = options.callbacks;\r\n\r\n    if (options.initialData) {\r\n      this.data = { ...options.initialData };\r\n      this.originalLabel = options.initialData.label;\r\n    } else {\r\n      this.data = { ...defaultBehaviourFormData };\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  private render(): void {\r\n    const title = this.mode === 'create' ? 'Add Behaviour' : 'Edit Behaviour';\r\n    const submitLabel = this.mode === 'create' ? 'Create' : 'Save';\r\n\r\n    this.container.innerHTML = `\r\n      <form class=\"entity-form behaviour-form\" novalidate>\r\n        <h3 class=\"form-title\">${title}</h3>\r\n        \r\n        <div class=\"form-group\">\r\n          <label for=\"behaviour-label\" class=\"form-label\">\r\n            Label <span class=\"required\">*</span>\r\n          </label>\r\n          <input\r\n            type=\"text\"\r\n            id=\"behaviour-label\"\r\n            class=\"form-input\"\r\n            value=\"${this.escapeHtml(this.data.label)}\"\r\n            placeholder=\"e.g., Morning meditation\"\r\n            maxlength=\"100\"\r\n            required\r\n          />\r\n          <div class=\"form-error\" id=\"label-error\"></div>\r\n        </div>\r\n\r\n        <div class=\"form-row\">\r\n          <div class=\"form-group\">\r\n            <label for=\"behaviour-frequency\" class=\"form-label\">Frequency</label>\r\n            <select id=\"behaviour-frequency\" class=\"form-select\">\r\n              ${frequencyOptions.map((opt) => `<option value=\"${opt.value}\" ${this.data.frequency === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}\r\n            </select>\r\n          </div>\r\n\r\n          <div class=\"form-group\">\r\n            <label for=\"behaviour-cost\" class=\"form-label\">Cost</label>\r\n            <select id=\"behaviour-cost\" class=\"form-select\">\r\n              ${costOptions.map((opt) => `<option value=\"${opt.value}\" ${this.data.cost === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}\r\n            </select>\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label for=\"behaviour-tags\" class=\"form-label\">Context Tags</label>\r\n          <input\r\n            type=\"text\"\r\n            id=\"behaviour-tags\"\r\n            class=\"form-input\"\r\n            value=\"${this.escapeHtml(this.data.contextTags.join(', '))}\"\r\n            placeholder=\"e.g., morning, alone, work\"\r\n          />\r\n          <div class=\"form-hint\">Separate tags with commas</div>\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label for=\"behaviour-notes\" class=\"form-label\">Notes</label>\r\n          <textarea\r\n            id=\"behaviour-notes\"\r\n            class=\"form-textarea\"\r\n            rows=\"3\"\r\n            placeholder=\"Optional notes about this behaviour...\"\r\n          >${this.escapeHtml(this.data.notes)}</textarea>\r\n        </div>\r\n\r\n        <div class=\"form-actions\">\r\n          ${this.mode === 'edit' && this.callbacks.onDelete ? '<button type=\"button\" class=\"btn btn-danger\" id=\"btn-delete\">Delete</button>' : ''}\r\n          <button type=\"button\" class=\"btn btn-secondary\" id=\"btn-cancel\">Cancel</button>\r\n          <button type=\"submit\" class=\"btn btn-primary\" id=\"btn-submit\">${submitLabel}</button>\r\n        </div>\r\n      </form>\r\n    `;\r\n\r\n    this.bindEvents();\r\n  }\r\n\r\n  private bindEvents(): void {\r\n    const form = this.container.querySelector('form')!;\r\n    const labelInput = this.container.querySelector('#behaviour-label') as HTMLInputElement;\r\n    const frequencySelect = this.container.querySelector('#behaviour-frequency') as HTMLSelectElement;\r\n    const costSelect = this.container.querySelector('#behaviour-cost') as HTMLSelectElement;\r\n    const tagsInput = this.container.querySelector('#behaviour-tags') as HTMLInputElement;\r\n    const notesTextarea = this.container.querySelector('#behaviour-notes') as HTMLTextAreaElement;\r\n    const cancelBtn = this.container.querySelector('#btn-cancel') as HTMLButtonElement;\r\n    const deleteBtn = this.container.querySelector('#btn-delete');\r\n\r\n    // Update data on input\r\n    labelInput.addEventListener('input', () => {\r\n      this.data.label = labelInput.value;\r\n      this.validateField('label');\r\n    });\r\n\r\n    frequencySelect.addEventListener('change', () => {\r\n      this.data.frequency = frequencySelect.value as typeof this.data.frequency;\r\n    });\r\n\r\n    costSelect.addEventListener('change', () => {\r\n      this.data.cost = costSelect.value as typeof this.data.cost;\r\n    });\r\n\r\n    tagsInput.addEventListener('input', () => {\r\n      this.data.contextTags = tagsInput.value\r\n        .split(',')\r\n        .map((tag) => tag.trim())\r\n        .filter((tag) => tag.length > 0);\r\n    });\r\n\r\n    notesTextarea.addEventListener('input', () => {\r\n      this.data.notes = notesTextarea.value;\r\n    });\r\n\r\n    // Form submission\r\n    form.addEventListener('submit', (e) => {\r\n      e.preventDefault();\r\n      if (this.validate()) {\r\n        this.callbacks.onSave(this.data);\r\n      }\r\n    });\r\n\r\n    // Cancel button\r\n    cancelBtn.addEventListener('click', () => {\r\n      this.callbacks.onCancel();\r\n    });\r\n\r\n    // Delete button\r\n    if (deleteBtn && this.callbacks.onDelete) {\r\n      deleteBtn.addEventListener('click', () => {\r\n        if (confirm('Are you sure you want to delete this behaviour? This will also remove all connected links.')) {\r\n          this.callbacks.onDelete!();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  private validateField(field: string): boolean {\r\n    // Remove existing error for this field\r\n    this.errors = this.errors.filter((e) => e.field !== field);\r\n\r\n    if (field === 'label') {\r\n      const existingLabels = getLabelsForType(this.network, 'behaviour');\r\n      const error = validateLabel(this.data.label, existingLabels, this.originalLabel);\r\n      if (error) {\r\n        this.errors.push(error);\r\n      }\r\n    }\r\n\r\n    this.updateErrorDisplay();\r\n    return !this.errors.some((e) => e.field === field);\r\n  }\r\n\r\n  private validate(): boolean {\r\n    this.errors = [];\r\n\r\n    // Validate label\r\n    const existingLabels = getLabelsForType(this.network, 'behaviour');\r\n    const labelError = validateLabel(this.data.label, existingLabels, this.originalLabel);\r\n    if (labelError) {\r\n      this.errors.push(labelError);\r\n    }\r\n\r\n    this.updateErrorDisplay();\r\n    return this.errors.length === 0;\r\n  }\r\n\r\n  private updateErrorDisplay(): void {\r\n    const labelError = this.container.querySelector('#label-error') as HTMLElement;\r\n    const labelInput = this.container.querySelector('#behaviour-label') as HTMLInputElement;\r\n\r\n    const error = this.errors.find((e) => e.field === 'label');\r\n    if (error) {\r\n      labelError.textContent = error.message;\r\n      labelInput.classList.add('invalid');\r\n    } else {\r\n      labelError.textContent = '';\r\n      labelInput.classList.remove('invalid');\r\n    }\r\n  }\r\n\r\n  private escapeHtml(text: string): string {\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n\r\n  /**\r\n   * Get the current form data.\r\n   */\r\n  getData(): BehaviourFormData {\r\n    return { ...this.data };\r\n  }\r\n\r\n  /**\r\n   * Update the network reference (for validation).\r\n   */\r\n  setNetwork(network: Network): void {\r\n    this.network = network;\r\n  }\r\n}\r\n","/**\r\n * Outcome Form Component\r\n *\r\n * Form for creating and editing Outcome entities.\r\n */\r\n\r\nimport type { Network } from '@/types';\r\n\r\nimport {\r\n  FormError,\r\n  FormMode,\r\n  OutcomeFormCallbacks,\r\n  OutcomeFormData,\r\n  defaultOutcomeFormData,\r\n  getLabelsForType,\r\n  validateLabel,\r\n} from './types';\r\n\r\nexport interface OutcomeFormOptions {\r\n  mode: FormMode;\r\n  network: Network;\r\n  initialData?: OutcomeFormData;\r\n  callbacks: OutcomeFormCallbacks;\r\n}\r\n\r\nexport class OutcomeForm {\r\n  private container: HTMLElement;\r\n  private mode: FormMode;\r\n  private network: Network;\r\n  private data: OutcomeFormData;\r\n  private originalLabel?: string;\r\n  private callbacks: OutcomeFormCallbacks;\r\n  private errors: FormError[] = [];\r\n\r\n  constructor(container: HTMLElement, options: OutcomeFormOptions) {\r\n    this.container = container;\r\n    this.mode = options.mode;\r\n    this.network = options.network;\r\n    this.callbacks = options.callbacks;\r\n\r\n    if (options.initialData) {\r\n      this.data = { ...options.initialData };\r\n      this.originalLabel = options.initialData.label;\r\n    } else {\r\n      this.data = { ...defaultOutcomeFormData };\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  private render(): void {\r\n    const title = this.mode === 'create' ? 'Add Outcome' : 'Edit Outcome';\r\n    const submitLabel = this.mode === 'create' ? 'Create' : 'Save';\r\n\r\n    this.container.innerHTML = `\r\n      <form class=\"entity-form outcome-form\" novalidate>\r\n        <h3 class=\"form-title\">${title}</h3>\r\n        \r\n        <div class=\"form-group\">\r\n          <label for=\"outcome-label\" class=\"form-label\">\r\n            Label <span class=\"required\">*</span>\r\n          </label>\r\n          <input\r\n            type=\"text\"\r\n            id=\"outcome-label\"\r\n            class=\"form-input\"\r\n            value=\"${this.escapeHtml(this.data.label)}\"\r\n            placeholder=\"e.g., Mental clarity\"\r\n            maxlength=\"100\"\r\n            required\r\n          />\r\n          <div class=\"form-error\" id=\"label-error\"></div>\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label for=\"outcome-notes\" class=\"form-label\">Notes</label>\r\n          <textarea\r\n            id=\"outcome-notes\"\r\n            class=\"form-textarea\"\r\n            rows=\"3\"\r\n            placeholder=\"Optional notes about this outcome...\"\r\n          >${this.escapeHtml(this.data.notes)}</textarea>\r\n        </div>\r\n\r\n        <div class=\"form-actions\">\r\n          ${this.mode === 'edit' && this.callbacks.onDelete ? '<button type=\"button\" class=\"btn btn-danger\" id=\"btn-delete\">Delete</button>' : ''}\r\n          <button type=\"button\" class=\"btn btn-secondary\" id=\"btn-cancel\">Cancel</button>\r\n          <button type=\"submit\" class=\"btn btn-primary\" id=\"btn-submit\">${submitLabel}</button>\r\n        </div>\r\n      </form>\r\n    `;\r\n\r\n    this.bindEvents();\r\n  }\r\n\r\n  private bindEvents(): void {\r\n    const form = this.container.querySelector('form')!;\r\n    const labelInput = this.container.querySelector('#outcome-label') as HTMLInputElement;\r\n    const notesTextarea = this.container.querySelector('#outcome-notes') as HTMLTextAreaElement;\r\n    const cancelBtn = this.container.querySelector('#btn-cancel') as HTMLButtonElement;\r\n    const deleteBtn = this.container.querySelector('#btn-delete');\r\n\r\n    // Update data on input\r\n    labelInput.addEventListener('input', () => {\r\n      this.data.label = labelInput.value;\r\n      this.validateField('label');\r\n    });\r\n\r\n    notesTextarea.addEventListener('input', () => {\r\n      this.data.notes = notesTextarea.value;\r\n    });\r\n\r\n    // Form submission\r\n    form.addEventListener('submit', (e) => {\r\n      e.preventDefault();\r\n      if (this.validate()) {\r\n        this.callbacks.onSave(this.data);\r\n      }\r\n    });\r\n\r\n    // Cancel button\r\n    cancelBtn.addEventListener('click', () => {\r\n      this.callbacks.onCancel();\r\n    });\r\n\r\n    // Delete button\r\n    if (deleteBtn && this.callbacks.onDelete) {\r\n      deleteBtn.addEventListener('click', () => {\r\n        if (confirm('Are you sure you want to delete this outcome? This will also remove all connected links.')) {\r\n          this.callbacks.onDelete!();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  private validateField(field: string): boolean {\r\n    this.errors = this.errors.filter((e) => e.field !== field);\r\n\r\n    if (field === 'label') {\r\n      const existingLabels = getLabelsForType(this.network, 'outcome');\r\n      const error = validateLabel(this.data.label, existingLabels, this.originalLabel);\r\n      if (error) {\r\n        this.errors.push(error);\r\n      }\r\n    }\r\n\r\n    this.updateErrorDisplay();\r\n    return !this.errors.some((e) => e.field === field);\r\n  }\r\n\r\n  private validate(): boolean {\r\n    this.errors = [];\r\n\r\n    const existingLabels = getLabelsForType(this.network, 'outcome');\r\n    const labelError = validateLabel(this.data.label, existingLabels, this.originalLabel);\r\n    if (labelError) {\r\n      this.errors.push(labelError);\r\n    }\r\n\r\n    this.updateErrorDisplay();\r\n    return this.errors.length === 0;\r\n  }\r\n\r\n  private updateErrorDisplay(): void {\r\n    const labelError = this.container.querySelector('#label-error') as HTMLElement;\r\n    const labelInput = this.container.querySelector('#outcome-label') as HTMLInputElement;\r\n\r\n    const error = this.errors.find((e) => e.field === 'label');\r\n    if (error) {\r\n      labelError.textContent = error.message;\r\n      labelInput.classList.add('invalid');\r\n    } else {\r\n      labelError.textContent = '';\r\n      labelInput.classList.remove('invalid');\r\n    }\r\n  }\r\n\r\n  private escapeHtml(text: string): string {\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n\r\n  getData(): OutcomeFormData {\r\n    return { ...this.data };\r\n  }\r\n\r\n  setNetwork(network: Network): void {\r\n    this.network = network;\r\n  }\r\n}\r\n","/**\r\n * Value Form Component\r\n *\r\n * Form for creating and editing Value entities.\r\n */\r\n\r\nimport type { Network } from '@/types';\r\n\r\nimport {\r\n  FormError,\r\n  FormMode,\r\n  ValueFormCallbacks,\r\n  ValueFormData,\r\n  defaultValueFormData,\r\n  getLabelsForType,\r\n  importanceOptions,\r\n  neglectOptions,\r\n  validateLabel,\r\n} from './types';\r\n\r\nexport interface ValueFormOptions {\r\n  mode: FormMode;\r\n  network: Network;\r\n  initialData?: ValueFormData;\r\n  callbacks: ValueFormCallbacks;\r\n}\r\n\r\nexport class ValueForm {\r\n  private container: HTMLElement;\r\n  private mode: FormMode;\r\n  private network: Network;\r\n  private data: ValueFormData;\r\n  private originalLabel?: string;\r\n  private callbacks: ValueFormCallbacks;\r\n  private errors: FormError[] = [];\r\n\r\n  constructor(container: HTMLElement, options: ValueFormOptions) {\r\n    this.container = container;\r\n    this.mode = options.mode;\r\n    this.network = options.network;\r\n    this.callbacks = options.callbacks;\r\n\r\n    if (options.initialData) {\r\n      this.data = { ...options.initialData };\r\n      this.originalLabel = options.initialData.label;\r\n    } else {\r\n      this.data = { ...defaultValueFormData };\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  private render(): void {\r\n    const title = this.mode === 'create' ? 'Add Value' : 'Edit Value';\r\n    const submitLabel = this.mode === 'create' ? 'Create' : 'Save';\r\n\r\n    this.container.innerHTML = `\r\n      <form class=\"entity-form value-form\" novalidate>\r\n        <h3 class=\"form-title\">${title}</h3>\r\n        \r\n        <div class=\"form-group\">\r\n          <label for=\"value-label\" class=\"form-label\">\r\n            Label <span class=\"required\">*</span>\r\n          </label>\r\n          <input\r\n            type=\"text\"\r\n            id=\"value-label\"\r\n            class=\"form-input\"\r\n            value=\"${this.escapeHtml(this.data.label)}\"\r\n            placeholder=\"e.g., Health\"\r\n            maxlength=\"100\"\r\n            required\r\n          />\r\n          <div class=\"form-error\" id=\"label-error\"></div>\r\n        </div>\r\n\r\n        <div class=\"form-row\">\r\n          <div class=\"form-group\">\r\n            <label for=\"value-importance\" class=\"form-label\">Importance</label>\r\n            <select id=\"value-importance\" class=\"form-select\">\r\n              ${importanceOptions.map((opt) => `<option value=\"${opt.value}\" ${this.data.importance === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}\r\n            </select>\r\n          </div>\r\n\r\n          <div class=\"form-group\">\r\n            <label for=\"value-neglect\" class=\"form-label\">Current Status</label>\r\n            <select id=\"value-neglect\" class=\"form-select\">\r\n              ${neglectOptions.map((opt) => `<option value=\"${opt.value}\" ${this.data.neglect === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}\r\n            </select>\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label for=\"value-notes\" class=\"form-label\">Notes</label>\r\n          <textarea\r\n            id=\"value-notes\"\r\n            class=\"form-textarea\"\r\n            rows=\"3\"\r\n            placeholder=\"Optional notes about this value...\"\r\n          >${this.escapeHtml(this.data.notes)}</textarea>\r\n        </div>\r\n\r\n        <div class=\"form-actions\">\r\n          ${this.mode === 'edit' && this.callbacks.onDelete ? '<button type=\"button\" class=\"btn btn-danger\" id=\"btn-delete\">Delete</button>' : ''}\r\n          <button type=\"button\" class=\"btn btn-secondary\" id=\"btn-cancel\">Cancel</button>\r\n          <button type=\"submit\" class=\"btn btn-primary\" id=\"btn-submit\">${submitLabel}</button>\r\n        </div>\r\n      </form>\r\n    `;\r\n\r\n    this.bindEvents();\r\n  }\r\n\r\n  private bindEvents(): void {\r\n    const form = this.container.querySelector('form')!;\r\n    const labelInput = this.container.querySelector('#value-label') as HTMLInputElement;\r\n    const importanceSelect = this.container.querySelector('#value-importance') as HTMLSelectElement;\r\n    const neglectSelect = this.container.querySelector('#value-neglect') as HTMLSelectElement;\r\n    const notesTextarea = this.container.querySelector('#value-notes') as HTMLTextAreaElement;\r\n    const cancelBtn = this.container.querySelector('#btn-cancel') as HTMLButtonElement;\r\n    const deleteBtn = this.container.querySelector('#btn-delete');\r\n\r\n    // Update data on input\r\n    labelInput.addEventListener('input', () => {\r\n      this.data.label = labelInput.value;\r\n      this.validateField('label');\r\n    });\r\n\r\n    importanceSelect.addEventListener('change', () => {\r\n      this.data.importance = importanceSelect.value as typeof this.data.importance;\r\n    });\r\n\r\n    neglectSelect.addEventListener('change', () => {\r\n      this.data.neglect = neglectSelect.value as typeof this.data.neglect;\r\n    });\r\n\r\n    notesTextarea.addEventListener('input', () => {\r\n      this.data.notes = notesTextarea.value;\r\n    });\r\n\r\n    // Form submission\r\n    form.addEventListener('submit', (e) => {\r\n      e.preventDefault();\r\n      if (this.validate()) {\r\n        this.callbacks.onSave(this.data);\r\n      }\r\n    });\r\n\r\n    // Cancel button\r\n    cancelBtn.addEventListener('click', () => {\r\n      this.callbacks.onCancel();\r\n    });\r\n\r\n    // Delete button\r\n    if (deleteBtn && this.callbacks.onDelete) {\r\n      deleteBtn.addEventListener('click', () => {\r\n        if (confirm('Are you sure you want to delete this value? This will also remove all connected links.')) {\r\n          this.callbacks.onDelete!();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  private validateField(field: string): boolean {\r\n    this.errors = this.errors.filter((e) => e.field !== field);\r\n\r\n    if (field === 'label') {\r\n      const existingLabels = getLabelsForType(this.network, 'value');\r\n      const error = validateLabel(this.data.label, existingLabels, this.originalLabel);\r\n      if (error) {\r\n        this.errors.push(error);\r\n      }\r\n    }\r\n\r\n    this.updateErrorDisplay();\r\n    return !this.errors.some((e) => e.field === field);\r\n  }\r\n\r\n  private validate(): boolean {\r\n    this.errors = [];\r\n\r\n    const existingLabels = getLabelsForType(this.network, 'value');\r\n    const labelError = validateLabel(this.data.label, existingLabels, this.originalLabel);\r\n    if (labelError) {\r\n      this.errors.push(labelError);\r\n    }\r\n\r\n    this.updateErrorDisplay();\r\n    return this.errors.length === 0;\r\n  }\r\n\r\n  private updateErrorDisplay(): void {\r\n    const labelError = this.container.querySelector('#label-error') as HTMLElement;\r\n    const labelInput = this.container.querySelector('#value-label') as HTMLInputElement;\r\n\r\n    const error = this.errors.find((e) => e.field === 'label');\r\n    if (error) {\r\n      labelError.textContent = error.message;\r\n      labelInput.classList.add('invalid');\r\n    } else {\r\n      labelError.textContent = '';\r\n      labelInput.classList.remove('invalid');\r\n    }\r\n  }\r\n\r\n  private escapeHtml(text: string): string {\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n\r\n  getData(): ValueFormData {\r\n    return { ...this.data };\r\n  }\r\n\r\n  setNetwork(network: Network): void {\r\n    this.network = network;\r\n  }\r\n}\r\n","/**\r\n * Link Form Component\r\n *\r\n * Form for creating and editing links between nodes.\r\n * Includes autocomplete for selecting source/target nodes.\r\n */\r\n\r\nimport type { Network } from '@/types';\r\n\r\nimport {\r\n  AutocompleteItem,\r\n  BehaviourOutcomeLinkFormData,\r\n  FormError,\r\n  FormMode,\r\n  LinkFormCallbacks,\r\n  LinkFormData,\r\n  OutcomeValueLinkFormData,\r\n  defaultBehaviourOutcomeLinkFormData,\r\n  defaultOutcomeValueLinkFormData,\r\n  getAutocompleteSuggestions,\r\n  linkExists,\r\n  reliabilityOptions,\r\n  strengthOptions,\r\n  valenceOptions,\r\n} from './types';\r\n\r\nexport type LinkType = 'behaviour-outcome' | 'outcome-value';\r\n\r\nexport interface LinkFormOptions {\r\n  mode: FormMode;\r\n  linkType: LinkType;\r\n  network: Network;\r\n  initialData?: LinkFormData;\r\n  /** Pre-select a source node (e.g., when adding link from detail panel) */\r\n  preselectedSourceId?: string;\r\n  /** Pre-select a target node */\r\n  preselectedTargetId?: string;\r\n  callbacks: LinkFormCallbacks;\r\n}\r\n\r\nexport class LinkForm {\r\n  private container: HTMLElement;\r\n  private mode: FormMode;\r\n  private linkType: LinkType;\r\n  private network: Network;\r\n  private data: LinkFormData;\r\n  private callbacks: LinkFormCallbacks;\r\n  private errors: FormError[] = [];\r\n\r\n  // Autocomplete state\r\n  private sourceQuery: string = '';\r\n  private targetQuery: string = '';\r\n  private sourceSuggestions: AutocompleteItem[] = [];\r\n  private targetSuggestions: AutocompleteItem[] = [];\r\n  private selectedSource: AutocompleteItem | null = null;\r\n  private selectedTarget: AutocompleteItem | null = null;\r\n\r\n  constructor(container: HTMLElement, options: LinkFormOptions) {\r\n    this.container = container;\r\n    this.mode = options.mode;\r\n    this.linkType = options.linkType;\r\n    this.network = options.network;\r\n    this.callbacks = options.callbacks;\r\n\r\n    // Initialize data based on link type\r\n    if (options.initialData) {\r\n      this.data = { ...options.initialData };\r\n      // Populate selected source/target from IDs\r\n      this.selectedSource = this.findNodeById(this.data.sourceId);\r\n      this.selectedTarget = this.findNodeById(this.data.targetId);\r\n    } else {\r\n      this.data =\r\n        this.linkType === 'behaviour-outcome'\r\n          ? { ...defaultBehaviourOutcomeLinkFormData }\r\n          : { ...defaultOutcomeValueLinkFormData };\r\n\r\n      // Handle preselected source/target\r\n      if (options.preselectedSourceId !== undefined && options.preselectedSourceId !== '') {\r\n        this.data.sourceId = options.preselectedSourceId;\r\n        this.selectedSource = this.findNodeById(options.preselectedSourceId);\r\n      }\r\n      if (options.preselectedTargetId !== undefined && options.preselectedTargetId !== '') {\r\n        this.data.targetId = options.preselectedTargetId;\r\n        this.selectedTarget = this.findNodeById(options.preselectedTargetId);\r\n      }\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  private findNodeById(id: string): AutocompleteItem | null {\r\n    if (id === '') return null;\r\n\r\n    const behaviour = this.network.behaviours.find((b) => b.id === id);\r\n    if (behaviour) return { id: behaviour.id, label: behaviour.label, type: 'behaviour' };\r\n\r\n    const outcome = this.network.outcomes.find((o) => o.id === id);\r\n    if (outcome) return { id: outcome.id, label: outcome.label, type: 'outcome' };\r\n\r\n    const value = this.network.values.find((v) => v.id === id);\r\n    if (value) return { id: value.id, label: value.label, type: 'value' };\r\n\r\n    return null;\r\n  }\r\n\r\n  private get sourceNodeType(): 'behaviour' | 'outcome' {\r\n    return this.linkType === 'behaviour-outcome' ? 'behaviour' : 'outcome';\r\n  }\r\n\r\n  private get targetNodeType(): 'outcome' | 'value' {\r\n    return this.linkType === 'behaviour-outcome' ? 'outcome' : 'value';\r\n  }\r\n\r\n  private render(): void {\r\n    const title =\r\n      this.mode === 'create'\r\n        ? this.linkType === 'behaviour-outcome'\r\n          ? 'Link Behaviour → Outcome'\r\n          : 'Link Outcome → Value'\r\n        : 'Edit Link';\r\n    const submitLabel = this.mode === 'create' ? 'Create Link' : 'Save';\r\n\r\n    const sourceTypeLabel = this.sourceNodeType === 'behaviour' ? 'Behaviour' : 'Outcome';\r\n    const targetTypeLabel = this.targetNodeType === 'outcome' ? 'Outcome' : 'Value';\r\n\r\n    const attributeField =\r\n      this.linkType === 'behaviour-outcome'\r\n        ? `\r\n          <div class=\"form-group\">\r\n            <label for=\"link-reliability\" class=\"form-label\">Reliability</label>\r\n            <select id=\"link-reliability\" class=\"form-select\">\r\n              ${reliabilityOptions.map((opt) => `<option value=\"${opt.value}\" ${(this.data as BehaviourOutcomeLinkFormData).reliability === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}\r\n            </select>\r\n            <div class=\"form-hint\">How reliably does this behaviour produce this outcome?</div>\r\n          </div>\r\n        `\r\n        : `\r\n          <div class=\"form-group\">\r\n            <label for=\"link-strength\" class=\"form-label\">Strength</label>\r\n            <select id=\"link-strength\" class=\"form-select\">\r\n              ${strengthOptions.map((opt) => `<option value=\"${opt.value}\" ${(this.data as OutcomeValueLinkFormData).strength === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}\r\n            </select>\r\n            <div class=\"form-hint\">How strongly does this outcome contribute to this value?</div>\r\n          </div>\r\n        `;\r\n\r\n    this.container.innerHTML = `\r\n      <form class=\"entity-form link-form\" novalidate>\r\n        <h3 class=\"form-title\">${title}</h3>\r\n\r\n        <div class=\"form-group\">\r\n          <label for=\"link-source\" class=\"form-label\">\r\n            ${sourceTypeLabel} <span class=\"required\">*</span>\r\n          </label>\r\n          <div class=\"autocomplete-wrapper\">\r\n            <input\r\n              type=\"text\"\r\n              id=\"link-source\"\r\n              class=\"form-input autocomplete-input\"\r\n              value=\"${this.selectedSource ? this.escapeHtml(this.selectedSource.label) : ''}\"\r\n              placeholder=\"Search ${sourceTypeLabel.toLowerCase()}s...\"\r\n              autocomplete=\"off\"\r\n              ${this.mode === 'edit' || this.selectedSource ? 'readonly' : ''}\r\n            />\r\n            ${this.selectedSource ? `<button type=\"button\" class=\"autocomplete-clear\" id=\"clear-source\">×</button>` : ''}\r\n            <div class=\"autocomplete-dropdown\" id=\"source-dropdown\" style=\"display: none;\"></div>\r\n          </div>\r\n          <div class=\"form-error\" id=\"source-error\"></div>\r\n        </div>\r\n\r\n        <div class=\"link-direction-indicator\">↓</div>\r\n\r\n        <div class=\"form-group\">\r\n          <label for=\"link-target\" class=\"form-label\">\r\n            ${targetTypeLabel} <span class=\"required\">*</span>\r\n          </label>\r\n          <div class=\"autocomplete-wrapper\">\r\n            <input\r\n              type=\"text\"\r\n              id=\"link-target\"\r\n              class=\"form-input autocomplete-input\"\r\n              value=\"${this.selectedTarget ? this.escapeHtml(this.selectedTarget.label) : ''}\"\r\n              placeholder=\"Search ${targetTypeLabel.toLowerCase()}s...\"\r\n              autocomplete=\"off\"\r\n              ${this.mode === 'edit' || this.selectedTarget ? 'readonly' : ''}\r\n            />\r\n            ${this.selectedTarget ? `<button type=\"button\" class=\"autocomplete-clear\" id=\"clear-target\">×</button>` : ''}\r\n            <div class=\"autocomplete-dropdown\" id=\"target-dropdown\" style=\"display: none;\"></div>\r\n          </div>\r\n          <div class=\"form-error\" id=\"target-error\"></div>\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label for=\"link-valence\" class=\"form-label\">Valence</label>\r\n          <select id=\"link-valence\" class=\"form-select\">\r\n            ${valenceOptions.map((opt) => `<option value=\"${opt.value}\" ${this.data.valence === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}\r\n          </select>\r\n          <div class=\"form-hint\">Does this link have a positive or negative effect?</div>\r\n        </div>\r\n\r\n        ${attributeField}\r\n\r\n        <div class=\"form-actions\">\r\n          ${this.mode === 'edit' && this.callbacks.onDelete ? '<button type=\"button\" class=\"btn btn-danger\" id=\"btn-delete\">Delete</button>' : ''}\r\n          <button type=\"button\" class=\"btn btn-secondary\" id=\"btn-cancel\">Cancel</button>\r\n          <button type=\"submit\" class=\"btn btn-primary\" id=\"btn-submit\">${submitLabel}</button>\r\n        </div>\r\n      </form>\r\n    `;\r\n\r\n    this.bindEvents();\r\n  }\r\n\r\n  private bindEvents(): void {\r\n    const form = this.container.querySelector('form')!;\r\n    const sourceInput = this.container.querySelector('#link-source') as HTMLInputElement;\r\n    const targetInput = this.container.querySelector('#link-target') as HTMLInputElement;\r\n    const sourceDropdown = this.container.querySelector('#source-dropdown') as HTMLElement;\r\n    const targetDropdown = this.container.querySelector('#target-dropdown') as HTMLElement;\r\n    const valenceSelect = this.container.querySelector('#link-valence') as HTMLSelectElement;\r\n    const cancelBtn = this.container.querySelector('#btn-cancel') as HTMLButtonElement;\r\n    const deleteBtn = this.container.querySelector('#btn-delete');\r\n    const clearSourceBtn = this.container.querySelector('#clear-source');\r\n    const clearTargetBtn = this.container.querySelector('#clear-target');\r\n\r\n    // Source autocomplete (only if not readonly)\r\n    if (!sourceInput.readOnly) {\r\n      sourceInput.addEventListener('input', () => {\r\n        this.sourceQuery = sourceInput.value;\r\n        this.updateSourceSuggestions();\r\n      });\r\n\r\n      sourceInput.addEventListener('focus', () => {\r\n        this.updateSourceSuggestions();\r\n      });\r\n\r\n      sourceInput.addEventListener('blur', () => {\r\n        // Delay to allow click on dropdown item\r\n        setTimeout(() => {\r\n          sourceDropdown.style.display = 'none';\r\n        }, 200);\r\n      });\r\n    }\r\n\r\n    // Target autocomplete (only if not readonly)\r\n    if (!targetInput.readOnly) {\r\n      targetInput.addEventListener('input', () => {\r\n        this.targetQuery = targetInput.value;\r\n        this.updateTargetSuggestions();\r\n      });\r\n\r\n      targetInput.addEventListener('focus', () => {\r\n        this.updateTargetSuggestions();\r\n      });\r\n\r\n      targetInput.addEventListener('blur', () => {\r\n        setTimeout(() => {\r\n          targetDropdown.style.display = 'none';\r\n        }, 200);\r\n      });\r\n    }\r\n\r\n    // Clear buttons\r\n    if (clearSourceBtn) {\r\n      clearSourceBtn.addEventListener('click', () => {\r\n        this.selectedSource = null;\r\n        this.data.sourceId = '';\r\n        this.render();\r\n      });\r\n    }\r\n\r\n    if (clearTargetBtn) {\r\n      clearTargetBtn.addEventListener('click', () => {\r\n        this.selectedTarget = null;\r\n        this.data.targetId = '';\r\n        this.render();\r\n      });\r\n    }\r\n\r\n    // Valence change\r\n    valenceSelect.addEventListener('change', () => {\r\n      this.data.valence = valenceSelect.value as typeof this.data.valence;\r\n    });\r\n\r\n    // Reliability/Strength change\r\n    if (this.linkType === 'behaviour-outcome') {\r\n      const reliabilitySelect = this.container.querySelector('#link-reliability') as HTMLSelectElement;\r\n      reliabilitySelect.addEventListener('change', () => {\r\n        (this.data as BehaviourOutcomeLinkFormData).reliability = reliabilitySelect.value as 'always' | 'usually' | 'sometimes' | 'rarely';\r\n      });\r\n    } else {\r\n      const strengthSelect = this.container.querySelector('#link-strength') as HTMLSelectElement;\r\n      strengthSelect.addEventListener('change', () => {\r\n        (this.data as OutcomeValueLinkFormData).strength = strengthSelect.value as 'strong' | 'moderate' | 'weak';\r\n      });\r\n    }\r\n\r\n    // Form submission\r\n    form.addEventListener('submit', (e) => {\r\n      e.preventDefault();\r\n      if (this.validate()) {\r\n        this.callbacks.onSave(this.data);\r\n      }\r\n    });\r\n\r\n    // Cancel button\r\n    cancelBtn.addEventListener('click', () => {\r\n      this.callbacks.onCancel();\r\n    });\r\n\r\n    // Delete button\r\n    if (deleteBtn && this.callbacks.onDelete) {\r\n      deleteBtn.addEventListener('click', () => {\r\n        if (confirm('Are you sure you want to delete this link?')) {\r\n          this.callbacks.onDelete!();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  private updateSourceSuggestions(): void {\r\n    const dropdown = this.container.querySelector('#source-dropdown') as HTMLElement;\r\n\r\n    this.sourceSuggestions = getAutocompleteSuggestions(this.network, this.sourceNodeType, this.sourceQuery);\r\n\r\n    if (this.sourceSuggestions.length === 0) {\r\n      dropdown.style.display = 'none';\r\n      return;\r\n    }\r\n\r\n    dropdown.innerHTML = this.sourceSuggestions\r\n      .map(\r\n        (item) => `\r\n        <div class=\"autocomplete-item\" data-id=\"${item.id}\">\r\n          <span class=\"autocomplete-label\">${this.escapeHtml(item.label)}</span>\r\n        </div>\r\n      `\r\n      )\r\n      .join('');\r\n\r\n    dropdown.style.display = 'block';\r\n\r\n    // Bind click events on items\r\n    dropdown.querySelectorAll('.autocomplete-item').forEach((el) => {\r\n      el.addEventListener('mousedown', (e) => {\r\n        e.preventDefault();\r\n        const id = (el as HTMLElement).dataset.id!;\r\n        const item = this.sourceSuggestions.find((s) => s.id === id);\r\n        if (item) {\r\n          this.selectSource(item);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  private updateTargetSuggestions(): void {\r\n    const dropdown = this.container.querySelector('#target-dropdown') as HTMLElement;\r\n\r\n    // Exclude already linked targets if creating new link\r\n    const excludeIds: string[] = [];\r\n    if (this.mode === 'create' && this.data.sourceId) {\r\n      // Get all existing targets for this source\r\n      this.network.links\r\n        .filter((l) => l.sourceId === this.data.sourceId)\r\n        .forEach((l) => excludeIds.push(l.targetId));\r\n    }\r\n\r\n    this.targetSuggestions = getAutocompleteSuggestions(this.network, this.targetNodeType, this.targetQuery, excludeIds);\r\n\r\n    if (this.targetSuggestions.length === 0) {\r\n      dropdown.style.display = 'none';\r\n      return;\r\n    }\r\n\r\n    dropdown.innerHTML = this.targetSuggestions\r\n      .map(\r\n        (item) => `\r\n        <div class=\"autocomplete-item\" data-id=\"${item.id}\">\r\n          <span class=\"autocomplete-label\">${this.escapeHtml(item.label)}</span>\r\n        </div>\r\n      `\r\n      )\r\n      .join('');\r\n\r\n    dropdown.style.display = 'block';\r\n\r\n    dropdown.querySelectorAll('.autocomplete-item').forEach((el) => {\r\n      el.addEventListener('mousedown', (e) => {\r\n        e.preventDefault();\r\n        const id = (el as HTMLElement).dataset.id!;\r\n        const item = this.targetSuggestions.find((s) => s.id === id);\r\n        if (item) {\r\n          this.selectTarget(item);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  private selectSource(item: AutocompleteItem): void {\r\n    this.selectedSource = item;\r\n    this.data.sourceId = item.id;\r\n    this.render();\r\n  }\r\n\r\n  private selectTarget(item: AutocompleteItem): void {\r\n    this.selectedTarget = item;\r\n    this.data.targetId = item.id;\r\n    this.render();\r\n  }\r\n\r\n  private validate(): boolean {\r\n    this.errors = [];\r\n\r\n    if (!this.data.sourceId) {\r\n      this.errors.push({ field: 'source', message: `Please select a ${this.sourceNodeType}` });\r\n    }\r\n\r\n    if (!this.data.targetId) {\r\n      this.errors.push({ field: 'target', message: `Please select a ${this.targetNodeType}` });\r\n    }\r\n\r\n    // Check for duplicate link (in create mode)\r\n    if (this.mode === 'create' && this.data.sourceId && this.data.targetId) {\r\n      if (linkExists(this.network, this.data.sourceId, this.data.targetId)) {\r\n        this.errors.push({ field: 'target', message: 'A link between these nodes already exists' });\r\n      }\r\n    }\r\n\r\n    this.updateErrorDisplay();\r\n    return this.errors.length === 0;\r\n  }\r\n\r\n  private updateErrorDisplay(): void {\r\n    const sourceError = this.container.querySelector('#source-error') as HTMLElement;\r\n    const targetError = this.container.querySelector('#target-error') as HTMLElement;\r\n    const sourceInput = this.container.querySelector('#link-source') as HTMLInputElement;\r\n    const targetInput = this.container.querySelector('#link-target') as HTMLInputElement;\r\n\r\n    const srcErr = this.errors.find((e) => e.field === 'source');\r\n    if (srcErr) {\r\n      sourceError.textContent = srcErr.message;\r\n      sourceInput.classList.add('invalid');\r\n    } else {\r\n      sourceError.textContent = '';\r\n      sourceInput.classList.remove('invalid');\r\n    }\r\n\r\n    const tgtErr = this.errors.find((e) => e.field === 'target');\r\n    if (tgtErr) {\r\n      targetError.textContent = tgtErr.message;\r\n      targetInput.classList.add('invalid');\r\n    } else {\r\n      targetError.textContent = '';\r\n      targetInput.classList.remove('invalid');\r\n    }\r\n  }\r\n\r\n  private escapeHtml(text: string): string {\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n\r\n  getData(): LinkFormData {\r\n    return { ...this.data };\r\n  }\r\n\r\n  setNetwork(network: Network): void {\r\n    this.network = network;\r\n  }\r\n}\r\n","/**\r\n * Node Detail Panel Component\r\n *\r\n * Displays detailed information about a selected node including\r\n * attributes and connected neighbours.\r\n */\r\n\r\nimport type { Behaviour, Network, Node, Outcome, Value } from '@/types';\r\n\r\nimport {\r\n  ConnectedNode,\r\n  costOptions,\r\n  frequencyOptions,\r\n  getConnectedNodes,\r\n  importanceOptions,\r\n  neglectOptions,\r\n  reliabilityOptions,\r\n  strengthOptions,\r\n} from './types';\r\n\r\nexport interface NodeDetailPanelCallbacks {\r\n  onEdit: (node: Node) => void;\r\n  onDelete: (node: Node) => void;\r\n  onAddLink: (nodeId: string, direction: 'outgoing' | 'incoming') => void;\r\n  onSelectNode: (nodeId: string) => void;\r\n  onEditLink: (linkId: string) => void;\r\n  onDeleteLink: (linkId: string) => void;\r\n  onClose: () => void;\r\n}\r\n\r\nexport interface NodeDetailPanelOptions {\r\n  network: Network;\r\n  callbacks: NodeDetailPanelCallbacks;\r\n}\r\n\r\nexport class NodeDetailPanel {\r\n  private container: HTMLElement;\r\n  private network: Network;\r\n  private callbacks: NodeDetailPanelCallbacks;\r\n  private selectedNode: Node | null = null;\r\n\r\n  constructor(container: HTMLElement, options: NodeDetailPanelOptions) {\r\n    this.container = container;\r\n    this.network = options.network;\r\n    this.callbacks = options.callbacks;\r\n    this.render();\r\n  }\r\n\r\n  /**\r\n   * Show details for a specific node.\r\n   */\r\n  show(node: Node): void {\r\n    this.selectedNode = node;\r\n    this.container.classList.remove('hidden');\r\n    this.render();\r\n  }\r\n\r\n  /**\r\n   * Hide the panel.\r\n   */\r\n  hide(): void {\r\n    this.selectedNode = null;\r\n    this.container.classList.add('hidden');\r\n  }\r\n\r\n  /**\r\n   * Update the network reference.\r\n   */\r\n  setNetwork(network: Network): void {\r\n    this.network = network;\r\n    // Re-render if we have a selected node\r\n    if (this.selectedNode) {\r\n      // Find updated node\r\n      const updated = this.findNode(this.selectedNode.id);\r\n      if (updated) {\r\n        this.selectedNode = updated;\r\n        this.render();\r\n      } else {\r\n        // Node was deleted\r\n        this.hide();\r\n      }\r\n    }\r\n  }\r\n\r\n  private findNode(id: string): Node | undefined {\r\n    return (\r\n      this.network.behaviours.find((b) => b.id === id) ??\r\n      this.network.outcomes.find((o) => o.id === id) ??\r\n      this.network.values.find((v) => v.id === id)\r\n    );\r\n  }\r\n\r\n  private render(): void {\r\n    if (!this.selectedNode) {\r\n      this.container.innerHTML = `\r\n        <div class=\"panel-content\">\r\n          <div class=\"panel-header\">\r\n            <h2>Select a node</h2>\r\n          </div>\r\n          <p class=\"panel-placeholder\">Click on a node in the graph to see its details.</p>\r\n        </div>\r\n      `;\r\n      return;\r\n    }\r\n\r\n    const node = this.selectedNode;\r\n    const connectedNodes = getConnectedNodes(this.network, node.id);\r\n    const incoming = connectedNodes.filter((n) => n.direction === 'incoming');\r\n    const outgoing = connectedNodes.filter((n) => n.direction === 'outgoing');\r\n\r\n    const typeLabel = this.getTypeLabel(node.type);\r\n    const typeClass = node.type;\r\n\r\n    this.container.innerHTML = `\r\n      <div class=\"panel-content\">\r\n        <div class=\"panel-header\">\r\n          <button class=\"panel-close\" id=\"btn-close\" aria-label=\"Close panel\">×</button>\r\n          <span class=\"node-type-badge ${typeClass}\">${typeLabel}</span>\r\n          <h2 class=\"panel-title\">${this.escapeHtml(node.label)}</h2>\r\n        </div>\r\n\r\n        <div class=\"panel-section\">\r\n          <h3>Attributes</h3>\r\n          ${this.renderAttributes(node)}\r\n        </div>\r\n\r\n        ${incoming.length > 0 ? this.renderConnections('Incoming Links', incoming, 'incoming') : ''}\r\n        ${outgoing.length > 0 ? this.renderConnections('Outgoing Links', outgoing, 'outgoing') : ''}\r\n\r\n        <div class=\"panel-section panel-actions-section\">\r\n          ${this.renderAddLinkButtons(node)}\r\n          <div class=\"panel-action-buttons\">\r\n            <button class=\"btn btn-secondary\" id=\"btn-edit\">Edit</button>\r\n            <button class=\"btn btn-danger\" id=\"btn-delete\">Delete</button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    this.bindEvents();\r\n  }\r\n\r\n  private renderAttributes(node: Node): string {\r\n    switch (node.type) {\r\n      case 'behaviour':\r\n        return this.renderBehaviourAttributes(node);\r\n      case 'outcome':\r\n        return this.renderOutcomeAttributes(node);\r\n      case 'value':\r\n        return this.renderValueAttributes(node);\r\n    }\r\n  }\r\n\r\n  private renderBehaviourAttributes(behaviour: Behaviour): string {\r\n    const freqLabel = frequencyOptions.find((o) => o.value === behaviour.frequency)?.label ?? behaviour.frequency;\r\n    const costLabel = costOptions.find((o) => o.value === behaviour.cost)?.label ?? behaviour.cost;\r\n\r\n    return `\r\n      <dl class=\"attribute-list\">\r\n        <dt>Frequency</dt>\r\n        <dd>${freqLabel}</dd>\r\n        <dt>Cost</dt>\r\n        <dd>${costLabel}</dd>\r\n        ${behaviour.contextTags.length > 0 ? `<dt>Tags</dt><dd>${behaviour.contextTags.map((t) => `<span class=\"tag\">${this.escapeHtml(t)}</span>`).join(' ')}</dd>` : ''}\r\n        ${behaviour.notes !== undefined && behaviour.notes !== '' ? `<dt>Notes</dt><dd class=\"notes\">${this.escapeHtml(behaviour.notes)}</dd>` : ''}\r\n      </dl>\r\n    `;\r\n  }\r\n\r\n  private renderOutcomeAttributes(outcome: Outcome): string {\r\n    return `\r\n      <dl class=\"attribute-list\">\r\n        ${outcome.notes !== undefined && outcome.notes !== '' ? `<dt>Notes</dt><dd class=\"notes\">${this.escapeHtml(outcome.notes)}</dd>` : '<p class=\"no-attributes\">No additional attributes</p>'}\r\n      </dl>\r\n    `;\r\n  }\r\n\r\n  private renderValueAttributes(value: Value): string {\r\n    const impLabel = importanceOptions.find((o) => o.value === value.importance)?.label ?? value.importance;\r\n    const negLabel = neglectOptions.find((o) => o.value === value.neglect)?.label ?? value.neglect;\r\n\r\n    return `\r\n      <dl class=\"attribute-list\">\r\n        <dt>Importance</dt>\r\n        <dd>${impLabel}</dd>\r\n        <dt>Current Status</dt>\r\n        <dd>${negLabel}</dd>\r\n        ${value.notes !== undefined && value.notes !== '' ? `<dt>Notes</dt><dd class=\"notes\">${this.escapeHtml(value.notes)}</dd>` : ''}\r\n      </dl>\r\n    `;\r\n  }\r\n\r\n  private renderConnections(title: string, connections: ConnectedNode[], direction: 'incoming' | 'outgoing'): string {\r\n    return `\r\n      <div class=\"panel-section\">\r\n        <h3>${title}</h3>\r\n        <ul class=\"connection-list\">\r\n          ${connections\r\n            .map((conn) => {\r\n              const typeClass = conn.type;\r\n              const valenceClass = conn.valence;\r\n              const strengthLabel = conn.strength !== undefined\r\n                ? strengthOptions.find((o) => o.value === conn.strength)?.label\r\n                : conn.reliability !== undefined\r\n                  ? reliabilityOptions.find((o) => o.value === conn.reliability)?.label\r\n                  : '';\r\n\r\n              return `\r\n              <li class=\"connection-item\">\r\n                <div class=\"connection-main\">\r\n                  <span class=\"connection-direction\">${direction === 'incoming' ? '←' : '→'}</span>\r\n                  <span class=\"node-type-dot ${typeClass}\"></span>\r\n                  <a href=\"#\" class=\"connection-label\" data-node-id=\"${conn.id}\">${this.escapeHtml(conn.label)}</a>\r\n                </div>\r\n                <div class=\"connection-meta\">\r\n                  <span class=\"valence-badge ${valenceClass}\">${conn.valence === 'positive' ? '+' : '−'}</span>\r\n                  ${strengthLabel !== '' ? `<span class=\"strength-label\">${strengthLabel}</span>` : ''}\r\n                  <button class=\"btn-icon\" data-link-id=\"${conn.linkId}\" data-action=\"edit-link\" title=\"Edit link\">✎</button>\r\n                  <button class=\"btn-icon btn-icon-danger\" data-link-id=\"${conn.linkId}\" data-action=\"delete-link\" title=\"Delete link\">×</button>\r\n                </div>\r\n              </li>\r\n            `;\r\n            })\r\n            .join('')}\r\n        </ul>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderAddLinkButtons(node: Node): string {\r\n    const buttons: string[] = [];\r\n\r\n    // Behaviours can link to Outcomes (outgoing only)\r\n    if (node.type === 'behaviour') {\r\n      buttons.push(`<button class=\"btn btn-sm\" id=\"btn-add-outgoing\">+ Link to Outcome</button>`);\r\n    }\r\n\r\n    // Outcomes can have incoming from Behaviours and outgoing to Values\r\n    if (node.type === 'outcome') {\r\n      buttons.push(`<button class=\"btn btn-sm\" id=\"btn-add-incoming\">+ Link from Behaviour</button>`);\r\n      buttons.push(`<button class=\"btn btn-sm\" id=\"btn-add-outgoing\">+ Link to Value</button>`);\r\n    }\r\n\r\n    // Values can have incoming from Outcomes (incoming only)\r\n    if (node.type === 'value') {\r\n      buttons.push(`<button class=\"btn btn-sm\" id=\"btn-add-incoming\">+ Link from Outcome</button>`);\r\n    }\r\n\r\n    return buttons.length > 0 ? `<div class=\"add-link-buttons\">${buttons.join('')}</div>` : '';\r\n  }\r\n\r\n  private getTypeLabel(type: 'behaviour' | 'outcome' | 'value'): string {\r\n    switch (type) {\r\n      case 'behaviour':\r\n        return 'Behaviour';\r\n      case 'outcome':\r\n        return 'Outcome';\r\n      case 'value':\r\n        return 'Value';\r\n    }\r\n  }\r\n\r\n  private bindEvents(): void {\r\n    const closeBtn = this.container.querySelector('#btn-close');\r\n    const editBtn = this.container.querySelector('#btn-edit');\r\n    const deleteBtn = this.container.querySelector('#btn-delete');\r\n    const addIncomingBtn = this.container.querySelector('#btn-add-incoming');\r\n    const addOutgoingBtn = this.container.querySelector('#btn-add-outgoing');\r\n\r\n    closeBtn?.addEventListener('click', () => {\r\n      this.callbacks.onClose();\r\n    });\r\n\r\n    editBtn?.addEventListener('click', () => {\r\n      if (this.selectedNode) {\r\n        this.callbacks.onEdit(this.selectedNode);\r\n      }\r\n    });\r\n\r\n    deleteBtn?.addEventListener('click', () => {\r\n      if (this.selectedNode) {\r\n        if (confirm(`Are you sure you want to delete \"${this.selectedNode.label}\"? This will also remove all connected links.`)) {\r\n          this.callbacks.onDelete(this.selectedNode);\r\n        }\r\n      }\r\n    });\r\n\r\n    addIncomingBtn?.addEventListener('click', () => {\r\n      if (this.selectedNode) {\r\n        this.callbacks.onAddLink(this.selectedNode.id, 'incoming');\r\n      }\r\n    });\r\n\r\n    addOutgoingBtn?.addEventListener('click', () => {\r\n      if (this.selectedNode) {\r\n        this.callbacks.onAddLink(this.selectedNode.id, 'outgoing');\r\n      }\r\n    });\r\n\r\n    // Connection label clicks (navigate to node)\r\n    this.container.querySelectorAll('.connection-label').forEach((el) => {\r\n      el.addEventListener('click', (e) => {\r\n        e.preventDefault();\r\n        const nodeId = (el as HTMLElement).dataset.nodeId;\r\n        if (nodeId !== undefined && nodeId !== '') {\r\n          this.callbacks.onSelectNode(nodeId);\r\n        }\r\n      });\r\n    });\r\n\r\n    // Edit link buttons\r\n    this.container.querySelectorAll('[data-action=\"edit-link\"]').forEach((el) => {\r\n      el.addEventListener('click', () => {\r\n        const linkId = (el as HTMLElement).dataset.linkId;\r\n        if (linkId !== undefined && linkId !== '') {\r\n          this.callbacks.onEditLink(linkId);\r\n        }\r\n      });\r\n    });\r\n\r\n    // Delete link buttons\r\n    this.container.querySelectorAll('[data-action=\"delete-link\"]').forEach((el) => {\r\n      el.addEventListener('click', () => {\r\n        const linkId = (el as HTMLElement).dataset.linkId;\r\n        if (linkId !== undefined && linkId !== '' && confirm('Are you sure you want to delete this link?')) {\r\n          this.callbacks.onDeleteLink(linkId);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  private escapeHtml(text: string): string {\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n}\r\n","/**\r\n * Graph Data Transformation\r\n *\r\n * Converts Network domain model to D3-compatible graph data.\r\n */\r\n\r\nimport type { Network, Reliability, Strength } from '@/types';\r\n\r\nimport type {\r\n  AnyGraphNode,\r\n  BehaviourGraphNode,\r\n  GraphData,\r\n  GraphEdge,\r\n  OutcomeGraphNode,\r\n  ValueGraphNode,\r\n} from './types';\r\n\r\n// ============================================================================\r\n// Strength Normalization\r\n// ============================================================================\r\n\r\n/**\r\n * Convert reliability to normalized 0-1 value.\r\n * Per docs/metrics-and-insights.md:\r\n * - always = 1.0\r\n * - usually = 0.75\r\n * - sometimes = 0.5\r\n * - rarely = 0.25\r\n */\r\nexport function normalizeReliability(reliability: Reliability): number {\r\n  const map: Record<Reliability, number> = {\r\n    always: 1.0,\r\n    usually: 0.75,\r\n    sometimes: 0.5,\r\n    rarely: 0.25,\r\n  };\r\n  return map[reliability];\r\n}\r\n\r\n/**\r\n * Convert strength to normalized 0-1 value.\r\n * Per docs/metrics-and-insights.md:\r\n * - strong = 1.0\r\n * - moderate = 0.6\r\n * - weak = 0.3\r\n */\r\nexport function normalizeStrength(strength: Strength): number {\r\n  const map: Record<Strength, number> = {\r\n    strong: 1.0,\r\n    moderate: 0.6,\r\n    weak: 0.3,\r\n  };\r\n  return map[strength];\r\n}\r\n\r\n// ============================================================================\r\n// Graph Data Transformation\r\n// ============================================================================\r\n\r\n/**\r\n * Transform Network domain model to D3-compatible graph data.\r\n */\r\nexport function networkToGraphData(network: Network): GraphData {\r\n  // Transform behaviours to graph nodes\r\n  const behaviourNodes: BehaviourGraphNode[] = network.behaviours.map((b) => ({\r\n    id: b.id,\r\n    label: b.label,\r\n    type: 'behaviour' as const,\r\n    data: b,\r\n  }));\r\n\r\n  // Transform outcomes to graph nodes\r\n  const outcomeNodes: OutcomeGraphNode[] = network.outcomes.map((o) => ({\r\n    id: o.id,\r\n    label: o.label,\r\n    type: 'outcome' as const,\r\n    data: o,\r\n  }));\r\n\r\n  // Transform values to graph nodes\r\n  const valueNodes: ValueGraphNode[] = network.values.map((v) => ({\r\n    id: v.id,\r\n    label: v.label,\r\n    type: 'value' as const,\r\n    data: v,\r\n  }));\r\n\r\n  const nodes: AnyGraphNode[] = [...behaviourNodes, ...outcomeNodes, ...valueNodes];\r\n\r\n  // Transform links to graph edges\r\n  const edges: GraphEdge[] = network.links.map((link) => {\r\n    const strength =\r\n      link.type === 'behaviour-outcome'\r\n        ? normalizeReliability(link.reliability)\r\n        : normalizeStrength(link.strength);\r\n\r\n    return {\r\n      id: link.id,\r\n      source: link.sourceId,\r\n      target: link.targetId,\r\n      type: link.type,\r\n      valence: link.valence,\r\n      strength,\r\n      data: link,\r\n    };\r\n  });\r\n\r\n  return { nodes, edges };\r\n}\r\n\r\n/**\r\n * Get all node IDs connected to a given node (direct neighbors).\r\n */\r\nexport function getConnectedNodeIds(graphData: GraphData, nodeId: string): Set<string> {\r\n  const connected = new Set<string>();\r\n\r\n  for (const edge of graphData.edges) {\r\n    const sourceId = typeof edge.source === 'string' ? edge.source : edge.source.id;\r\n    const targetId = typeof edge.target === 'string' ? edge.target : edge.target.id;\r\n\r\n    if (sourceId === nodeId) {\r\n      connected.add(targetId);\r\n    } else if (targetId === nodeId) {\r\n      connected.add(sourceId);\r\n    }\r\n  }\r\n\r\n  return connected;\r\n}\r\n\r\n/**\r\n * Get all edge IDs connected to a given node.\r\n */\r\nexport function getConnectedEdgeIds(graphData: GraphData, nodeId: string): Set<string> {\r\n  const connected = new Set<string>();\r\n\r\n  for (const edge of graphData.edges) {\r\n    const sourceId = typeof edge.source === 'string' ? edge.source : edge.source.id;\r\n    const targetId = typeof edge.target === 'string' ? edge.target : edge.target.id;\r\n\r\n    if (sourceId === nodeId || targetId === nodeId) {\r\n      connected.add(edge.id);\r\n    }\r\n  }\r\n\r\n  return connected;\r\n}\r\n\r\n/**\r\n * Truncate label for display (max 20 chars per visual-design.md).\r\n */\r\nexport function truncateLabel(label: string, maxLength: number = 20): string {\r\n  if (label.length <= maxLength) {\r\n    return label;\r\n  }\r\n  return label.substring(0, maxLength - 1) + '…';\r\n}\r\n","/**\r\n * SVG Renderer - Node Shapes\r\n *\r\n * Renders nodes as SVG elements based on type-specific shapes.\r\n * Per visual-design.md §2 Node Encoding.\r\n */\r\n\r\nimport * as d3 from 'd3';\r\n\r\nimport { truncateLabel } from './data';\r\nimport type { AnyGraphNode, GraphTheme, NodeVisualConfig } from './types';\r\n\r\n\r\n/**\r\n * Create SVG definitions for markers and gradients.\r\n */\r\nexport function createDefs(\r\n  svg: d3.Selection<SVGSVGElement, unknown, null, undefined>,\r\n  theme: GraphTheme\r\n): void {\r\n  const defs = svg.append('defs');\r\n\r\n  // Arrow marker for positive edges\r\n  defs\r\n    .append('marker')\r\n    .attr('id', 'arrow-positive')\r\n    .attr('viewBox', '0 -5 10 10')\r\n    .attr('refX', 10)\r\n    .attr('refY', 0)\r\n    .attr('markerWidth', 6)\r\n    .attr('markerHeight', 6)\r\n    .attr('orient', 'auto')\r\n    .append('path')\r\n    .attr('d', 'M0,-5L10,0L0,5')\r\n    .attr('fill', theme.edges.positive.stroke);\r\n\r\n  // Arrow marker for negative edges\r\n  defs\r\n    .append('marker')\r\n    .attr('id', 'arrow-negative')\r\n    .attr('viewBox', '0 -5 10 10')\r\n    .attr('refX', 10)\r\n    .attr('refY', 0)\r\n    .attr('markerWidth', 6)\r\n    .attr('markerHeight', 6)\r\n    .attr('orient', 'auto')\r\n    .append('path')\r\n    .attr('d', 'M0,-5L10,0L0,5')\r\n    .attr('fill', theme.edges.negative.stroke);\r\n\r\n  // Drop shadow filter for selection state\r\n  const filter = defs\r\n    .append('filter')\r\n    .attr('id', 'drop-shadow')\r\n    .attr('x', '-50%')\r\n    .attr('y', '-50%')\r\n    .attr('width', '200%')\r\n    .attr('height', '200%');\r\n\r\n  filter\r\n    .append('feDropShadow')\r\n    .attr('dx', 0)\r\n    .attr('dy', 2)\r\n    .attr('stdDeviation', 4)\r\n    .attr('flood-color', 'rgba(0,0,0,0.3)');\r\n}\r\n\r\n/**\r\n * Get node visual config from theme.\r\n */\r\nexport function getNodeConfig(theme: GraphTheme, type: AnyGraphNode['type']): NodeVisualConfig {\r\n  return theme.nodes[type];\r\n}\r\n\r\n/**\r\n * Render a rectangle node (for Behaviours).\r\n */\r\nexport function renderRectNode(\r\n  group: d3.Selection<SVGGElement, AnyGraphNode, SVGGElement, unknown>,\r\n  config: NodeVisualConfig\r\n): void {\r\n  const cornerRadius = 8;\r\n\r\n  group\r\n    .append('rect')\r\n    .attr('class', 'node-shape')\r\n    .attr('x', -config.width / 2)\r\n    .attr('y', -config.height / 2)\r\n    .attr('width', config.width)\r\n    .attr('height', config.height)\r\n    .attr('rx', cornerRadius)\r\n    .attr('ry', cornerRadius)\r\n    .attr('fill', config.fill)\r\n    .attr('stroke', config.stroke)\r\n    .attr('stroke-width', 2);\r\n}\r\n\r\n/**\r\n * Render a diamond node (for Outcomes).\r\n */\r\nexport function renderDiamondNode(\r\n  group: d3.Selection<SVGGElement, AnyGraphNode, SVGGElement, unknown>,\r\n  config: NodeVisualConfig\r\n): void {\r\n  const halfW = config.width / 2;\r\n  const halfH = config.height / 2;\r\n\r\n  const points = [\r\n    [0, -halfH], // top\r\n    [halfW, 0], // right\r\n    [0, halfH], // bottom\r\n    [-halfW, 0], // left\r\n  ]\r\n    .map((p) => p.join(','))\r\n    .join(' ');\r\n\r\n  group\r\n    .append('polygon')\r\n    .attr('class', 'node-shape')\r\n    .attr('points', points)\r\n    .attr('fill', config.fill)\r\n    .attr('stroke', config.stroke)\r\n    .attr('stroke-width', 2);\r\n}\r\n\r\n/**\r\n * Render a circle node (for Values).\r\n */\r\nexport function renderCircleNode(\r\n  group: d3.Selection<SVGGElement, AnyGraphNode, SVGGElement, unknown>,\r\n  config: NodeVisualConfig\r\n): void {\r\n  const radius = Math.min(config.width, config.height) / 2;\r\n\r\n  group\r\n    .append('circle')\r\n    .attr('class', 'node-shape')\r\n    .attr('r', radius)\r\n    .attr('fill', config.fill)\r\n    .attr('stroke', config.stroke)\r\n    .attr('stroke-width', 2);\r\n}\r\n\r\n/**\r\n * Render node shape based on type.\r\n */\r\nexport function renderNodeShape(\r\n  group: d3.Selection<SVGGElement, AnyGraphNode, SVGGElement, unknown>,\r\n  theme: GraphTheme\r\n): void {\r\n  group.each(function (d) {\r\n    const g = d3.select(this) as unknown as d3.Selection<SVGGElement, AnyGraphNode, SVGGElement, unknown>;\r\n    const config = getNodeConfig(theme, d.type);\r\n\r\n    switch (config.shape) {\r\n      case 'rect':\r\n        renderRectNode(g, config);\r\n        break;\r\n      case 'diamond':\r\n        renderDiamondNode(g, config);\r\n        break;\r\n      case 'circle':\r\n        renderCircleNode(g, config);\r\n        break;\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Render node label.\r\n */\r\nexport function renderNodeLabel(\r\n  group: d3.Selection<SVGGElement, AnyGraphNode, SVGGElement, unknown>,\r\n  theme: GraphTheme\r\n): void {\r\n  group\r\n    .append('text')\r\n    .attr('class', 'node-label')\r\n    .attr('text-anchor', 'middle')\r\n    .attr('dominant-baseline', 'middle')\r\n    .attr('fill', theme.text.fill)\r\n    .attr('font-size', theme.text.fontSize)\r\n    .attr('font-family', theme.text.fontFamily)\r\n    .attr('pointer-events', 'none')\r\n    .text((d) => truncateLabel(d.label));\r\n}\r\n\r\n/**\r\n * Get node boundary point for edge connection.\r\n * Returns the point on the node boundary where an edge should connect.\r\n */\r\nexport function getNodeBoundaryPoint(\r\n  node: AnyGraphNode,\r\n  targetX: number,\r\n  targetY: number,\r\n  theme: GraphTheme\r\n): { x: number; y: number } {\r\n  const config = getNodeConfig(theme, node.type);\r\n  const nodeX = node.x ?? 0;\r\n  const nodeY = node.y ?? 0;\r\n\r\n  const dx = targetX - nodeX;\r\n  const dy = targetY - nodeY;\r\n  const angle = Math.atan2(dy, dx);\r\n\r\n  switch (config.shape) {\r\n    case 'rect': {\r\n      const halfW = config.width / 2;\r\n      const halfH = config.height / 2;\r\n      // Find intersection with rectangle\r\n      const tanAngle = Math.abs(Math.tan(angle));\r\n      let bx: number, by: number;\r\n      if (tanAngle < halfH / halfW) {\r\n        // Intersects vertical edge\r\n        bx = dx > 0 ? halfW : -halfW;\r\n        by = bx * Math.tan(angle);\r\n      } else {\r\n        // Intersects horizontal edge\r\n        by = dy > 0 ? halfH : -halfH;\r\n        bx = by / Math.tan(angle);\r\n      }\r\n      return { x: nodeX + bx, y: nodeY + by };\r\n    }\r\n    case 'diamond': {\r\n      const halfW = config.width / 2;\r\n      const halfH = config.height / 2;\r\n      // Diamond is defined by |x|/halfW + |y|/halfH = 1\r\n      // Find intersection along angle\r\n      const absAngle = Math.abs(angle);\r\n      let t: number;\r\n      if (absAngle < Math.PI / 2) {\r\n        t = 1 / (Math.abs(Math.cos(angle)) / halfW + Math.abs(Math.sin(angle)) / halfH);\r\n      } else {\r\n        t = 1 / (Math.abs(Math.cos(angle)) / halfW + Math.abs(Math.sin(angle)) / halfH);\r\n      }\r\n      return {\r\n        x: nodeX + t * Math.cos(angle),\r\n        y: nodeY + t * Math.sin(angle),\r\n      };\r\n    }\r\n    case 'circle': {\r\n      const radius = Math.min(config.width, config.height) / 2;\r\n      return {\r\n        x: nodeX + radius * Math.cos(angle),\r\n        y: nodeY + radius * Math.sin(angle),\r\n      };\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Default Graph Theme\r\n *\r\n * Visual encoding defaults per visual-design.md specification.\r\n */\r\n\r\nimport type { GraphTheme, GraphOptions, LayeredLayoutConfig } from './types';\r\n\r\n/**\r\n * Default theme following visual-design.md colour families.\r\n * - Behaviours: Blue family, rectangle\r\n * - Outcomes: Orange/Yellow family, diamond\r\n * - Values: Green family, circle\r\n */\r\nexport const defaultTheme: GraphTheme = {\r\n  nodes: {\r\n    behaviour: {\r\n      shape: 'rect',\r\n      fill: '#3b82f6', // Blue-500\r\n      stroke: '#1d4ed8', // Blue-700\r\n      width: 140,\r\n      height: 50,\r\n    },\r\n    outcome: {\r\n      shape: 'diamond',\r\n      fill: '#f59e0b', // Amber-500\r\n      stroke: '#d97706', // Amber-600\r\n      width: 120,\r\n      height: 60,\r\n    },\r\n    value: {\r\n      shape: 'circle',\r\n      fill: '#10b981', // Emerald-500\r\n      stroke: '#059669', // Emerald-600\r\n      width: 100,\r\n      height: 100,\r\n    },\r\n  },\r\n  edges: {\r\n    positive: {\r\n      stroke: '#6b7280', // Gray-500\r\n      strokeDasharray: '', // Solid\r\n      markerEnd: 'url(#arrow-positive)',\r\n    },\r\n    negative: {\r\n      stroke: '#ef4444', // Red-500\r\n      strokeDasharray: '8,4', // Dashed\r\n      markerEnd: 'url(#arrow-negative)',\r\n    },\r\n  },\r\n  background: '#f9fafb', // Gray-50\r\n  text: {\r\n    fill: '#ffffff',\r\n    fontSize: 12,\r\n    fontFamily: 'system-ui, -apple-system, sans-serif',\r\n  },\r\n};\r\n\r\n/**\r\n * Default layered layout configuration.\r\n */\r\nexport const defaultLayeredLayout: LayeredLayoutConfig = {\r\n  type: 'layered',\r\n  columnGap: 250,\r\n  rowGap: 80,\r\n  padding: 60,\r\n};\r\n\r\n/**\r\n * Default graph options.\r\n */\r\nexport const defaultGraphOptions: GraphOptions = {\r\n  width: 1200,\r\n  height: 800,\r\n  layout: defaultLayeredLayout,\r\n  theme: defaultTheme,\r\n  zoomExtent: [0.25, 4],\r\n  transitionDuration: 300,\r\n};\r\n\r\n/**\r\n * Edge stroke widths based on strength/reliability.\r\n * Maps normalized 0-1 strength to pixel width.\r\n */\r\nexport const edgeWidthScale = {\r\n  min: 1,\r\n  max: 4,\r\n};\r\n\r\n/**\r\n * Edge opacity based on strength/reliability.\r\n * Maps normalized 0-1 strength to opacity.\r\n */\r\nexport const edgeOpacityScale = {\r\n  min: 0.3,\r\n  max: 1.0,\r\n};\r\n","/**\r\n * SVG Renderer - Edges\r\n *\r\n * Renders edges as SVG path elements with valence and strength encoding.\r\n * Per visual-design.md §3 Edge Encoding.\r\n */\r\n\r\nimport * as d3 from 'd3';\r\n\r\n\r\nimport { getNodeBoundaryPoint } from './nodes';\r\nimport { edgeOpacityScale, edgeWidthScale } from './theme';\r\nimport type { AnyGraphNode, GraphEdge, GraphTheme } from './types';\r\n\r\n/**\r\n * Calculate edge stroke width from normalized strength.\r\n */\r\nexport function getEdgeWidth(strength: number): number {\r\n  return edgeWidthScale.min + strength * (edgeWidthScale.max - edgeWidthScale.min);\r\n}\r\n\r\n/**\r\n * Calculate edge opacity from normalized strength.\r\n */\r\nexport function getEdgeOpacity(strength: number): number {\r\n  return edgeOpacityScale.min + strength * (edgeOpacityScale.max - edgeOpacityScale.min);\r\n}\r\n\r\n/**\r\n * Generate path data for an edge.\r\n * Uses straight lines for layered layout.\r\n */\r\nexport function generateEdgePath(\r\n  source: AnyGraphNode,\r\n  target: AnyGraphNode,\r\n  theme: GraphTheme\r\n): string {\r\n  const sourceX = source.x ?? 0;\r\n  const sourceY = source.y ?? 0;\r\n  const targetX = target.x ?? 0;\r\n  const targetY = target.y ?? 0;\r\n\r\n  // Get boundary points\r\n  const sourcePoint = getNodeBoundaryPoint(source, targetX, targetY, theme);\r\n  const targetPoint = getNodeBoundaryPoint(target, sourceX, sourceY, theme);\r\n\r\n  // Offset target point slightly for arrow marker\r\n  const dx = targetPoint.x - sourcePoint.x;\r\n  const dy = targetPoint.y - sourcePoint.y;\r\n  const len = Math.sqrt(dx * dx + dy * dy);\r\n  const arrowOffset = 8; // Space for arrow marker\r\n  const adjustedTarget = {\r\n    x: targetPoint.x - (dx / len) * arrowOffset,\r\n    y: targetPoint.y - (dy / len) * arrowOffset,\r\n  };\r\n\r\n  return `M ${sourcePoint.x},${sourcePoint.y} L ${adjustedTarget.x},${adjustedTarget.y}`;\r\n}\r\n\r\n/**\r\n * Render edges with visual encoding.\r\n */\r\nexport function renderEdges(\r\n  edgeGroup: d3.Selection<SVGGElement, unknown, null, undefined>,\r\n  edges: GraphEdge[],\r\n  theme: GraphTheme\r\n): d3.Selection<SVGPathElement, GraphEdge, SVGGElement, unknown> {\r\n  const edgeSelection = edgeGroup\r\n    .selectAll<SVGPathElement, GraphEdge>('path.edge')\r\n    .data(edges, (d) => d.id);\r\n\r\n  // Exit\r\n  edgeSelection.exit().remove();\r\n\r\n  // Enter\r\n  const edgeEnter = edgeSelection\r\n    .enter()\r\n    .append('path')\r\n    .attr('class', 'edge')\r\n    .attr('fill', 'none');\r\n\r\n  // Update (merge enter + update)\r\n  const edgeMerge = edgeEnter.merge(edgeSelection);\r\n\r\n  edgeMerge.each(function (d) {\r\n    const path = d3.select(this);\r\n    const valenceConfig = theme.edges[d.valence];\r\n\r\n    path\r\n      .attr('stroke', valenceConfig.stroke)\r\n      .attr('stroke-dasharray', valenceConfig.strokeDasharray)\r\n      .attr('stroke-width', getEdgeWidth(d.strength))\r\n      .attr('opacity', getEdgeOpacity(d.strength))\r\n      .attr('marker-end', valenceConfig.markerEnd);\r\n  });\r\n\r\n  return edgeMerge;\r\n}\r\n\r\n/**\r\n * Update edge paths based on current node positions.\r\n */\r\nexport function updateEdgePaths(\r\n  edgeSelection: d3.Selection<SVGPathElement, GraphEdge, SVGGElement, unknown>,\r\n  theme: GraphTheme\r\n): void {\r\n  edgeSelection.attr('d', (d) => {\r\n    const source = d.source as AnyGraphNode;\r\n    const target = d.target as AnyGraphNode;\r\n    return generateEdgePath(source, target, theme);\r\n  });\r\n}\r\n\r\n/**\r\n * Apply highlight styling to edges.\r\n */\r\nexport function highlightEdge(\r\n  edge: d3.Selection<SVGPathElement, GraphEdge, SVGGElement, unknown>,\r\n  highlighted: boolean\r\n): void {\r\n  edge\r\n    .classed('highlighted', highlighted)\r\n    .attr('opacity', highlighted ? 1 : null);\r\n}\r\n\r\n/**\r\n * Apply dimmed styling to edges.\r\n */\r\nexport function dimEdge(\r\n  edge: d3.Selection<SVGPathElement, GraphEdge, SVGGElement, unknown>,\r\n  dimmed: boolean\r\n): void {\r\n  edge\r\n    .classed('dimmed', dimmed)\r\n    .attr('opacity', dimmed ? 0.15 : null);\r\n}\r\n","/**\r\n * Layered Layout Algorithm\r\n *\r\n * Arranges nodes in three columns: Behaviours → Outcomes → Values.\r\n * Per visual-design.md §4.1 Layered Layout.\r\n */\r\n\r\nimport type { AnyGraphNode, GraphData, LayeredLayoutConfig } from './types';\r\n\r\n/**\r\n * Column indices for layered layout.\r\n */\r\nconst LAYER_COLUMN = {\r\n  behaviour: 0,\r\n  outcome: 1,\r\n  value: 2,\r\n} as const;\r\n\r\n/**\r\n * Apply layered layout to graph data.\r\n * Mutates node x/y positions in place.\r\n *\r\n * @param graphData - The graph data with nodes and edges\r\n * @param config - Layout configuration\r\n * @param canvasWidth - Available canvas width\r\n * @param canvasHeight - Available canvas height\r\n */\r\nexport function applyLayeredLayout(\r\n  graphData: GraphData,\r\n  config: LayeredLayoutConfig,\r\n  canvasWidth: number,\r\n  canvasHeight: number\r\n): void {\r\n  // Group nodes by type\r\n  const columns: Record<number, AnyGraphNode[]> = {\r\n    0: [], // Behaviours\r\n    1: [], // Outcomes\r\n    2: [], // Values\r\n  };\r\n\r\n  for (const node of graphData.nodes) {\r\n    const col = LAYER_COLUMN[node.type];\r\n    columns[col]!.push(node);\r\n  }\r\n\r\n  // Calculate column x positions (centered in canvas)\r\n  const totalWidth = 2 * config.columnGap + 2 * config.padding;\r\n  const startX = (canvasWidth - totalWidth) / 2 + config.padding;\r\n\r\n  const columnX = [\r\n    startX, // Behaviours\r\n    startX + config.columnGap, // Outcomes\r\n    startX + 2 * config.columnGap, // Values\r\n  ];\r\n\r\n  // Position nodes in each column\r\n  for (let col = 0; col < 3; col++) {\r\n    const nodesInColumn = columns[col]!;\r\n    const columnHeight = (nodesInColumn.length - 1) * config.rowGap;\r\n    const startY = (canvasHeight - columnHeight) / 2;\r\n\r\n    nodesInColumn.forEach((node, index) => {\r\n      node.x = columnX[col];\r\n      node.y = startY + index * config.rowGap;\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Sort nodes within columns by connectivity.\r\n * Nodes with more connections to adjacent columns are placed closer\r\n * to minimize edge crossings (simple heuristic).\r\n */\r\nexport function sortNodesByConnectivity(graphData: GraphData): void {\r\n  // Build adjacency map\r\n  const adjacency = new Map<string, Set<string>>();\r\n\r\n  for (const node of graphData.nodes) {\r\n    adjacency.set(node.id, new Set());\r\n  }\r\n\r\n  for (const edge of graphData.edges) {\r\n    const sourceId = typeof edge.source === 'string' ? edge.source : edge.source.id;\r\n    const targetId = typeof edge.target === 'string' ? edge.target : edge.target.id;\r\n    adjacency.get(sourceId)?.add(targetId);\r\n    adjacency.get(targetId)?.add(sourceId);\r\n  }\r\n\r\n  // Group by type\r\n  const behaviours = graphData.nodes.filter((n) => n.type === 'behaviour');\r\n  const outcomes = graphData.nodes.filter((n) => n.type === 'outcome');\r\n  const values = graphData.nodes.filter((n) => n.type === 'value');\r\n\r\n  // Sort outcomes by number of connections (most connected in middle)\r\n  outcomes.sort((a, b) => {\r\n    const aCount = adjacency.get(a.id)?.size ?? 0;\r\n    const bCount = adjacency.get(b.id)?.size ?? 0;\r\n    return bCount - aCount;\r\n  });\r\n\r\n  // Sort behaviours by average y-position of connected outcomes\r\n  const getAverageOutcomeY = (nodeId: string): number => {\r\n    const connected = adjacency.get(nodeId);\r\n    if (!connected || connected.size === 0) return 0;\r\n\r\n    let sum = 0;\r\n    let count = 0;\r\n    for (const outId of connected) {\r\n      const outcome = outcomes.find((o) => o.id === outId);\r\n      if (outcome?.y !== undefined) {\r\n        sum += outcome.y;\r\n        count++;\r\n      }\r\n    }\r\n    return count > 0 ? sum / count : 0;\r\n  };\r\n\r\n  // First pass: position outcomes\r\n  const columnHeight = (outcomes.length - 1) * 80; // Default row gap\r\n  outcomes.forEach((node, index) => {\r\n    node.y = index * 80 - columnHeight / 2;\r\n  });\r\n\r\n  // Sort behaviours by their connected outcomes' positions\r\n  behaviours.sort((a, b) => getAverageOutcomeY(a.id) - getAverageOutcomeY(b.id));\r\n\r\n  // Sort values by their connected outcomes' positions\r\n  const getAverageOutcomeYForValue = (nodeId: string): number => {\r\n    const connected = adjacency.get(nodeId);\r\n    if (!connected || connected.size === 0) return 0;\r\n\r\n    let sum = 0;\r\n    let count = 0;\r\n    for (const outId of connected) {\r\n      const outcome = outcomes.find((o) => o.id === outId);\r\n      if (outcome?.y !== undefined) {\r\n        sum += outcome.y;\r\n        count++;\r\n      }\r\n    }\r\n    return count > 0 ? sum / count : 0;\r\n  };\r\n\r\n  values.sort((a, b) => getAverageOutcomeYForValue(a.id) - getAverageOutcomeYForValue(b.id));\r\n\r\n  // Rebuild nodes array in sorted order\r\n  graphData.nodes.length = 0;\r\n  graphData.nodes.push(...behaviours, ...outcomes, ...values);\r\n}\r\n\r\n/**\r\n * Get column boundaries for rendering guidelines or debugging.\r\n */\r\nexport function getColumnBoundaries(\r\n  config: LayeredLayoutConfig,\r\n  canvasWidth: number\r\n): { x: number; label: string }[] {\r\n  const totalWidth = 2 * config.columnGap + 2 * config.padding;\r\n  const startX = (canvasWidth - totalWidth) / 2 + config.padding;\r\n\r\n  return [\r\n    { x: startX, label: 'Behaviours' },\r\n    { x: startX + config.columnGap, label: 'Outcomes' },\r\n    { x: startX + 2 * config.columnGap, label: 'Values' },\r\n  ];\r\n}\r\n","/**\r\n * Legend Component\r\n *\r\n * Renders a visual legend explaining the graph encoding.\r\n * Per visual-design.md §7 Legend.\r\n */\r\n\r\nimport * as d3 from 'd3';\r\n\r\nimport type { GraphTheme } from './types';\r\n\r\nexport interface LegendOptions {\r\n  x: number;\r\n  y: number;\r\n  collapsed: boolean;\r\n}\r\n\r\nconst LEGEND_PADDING = 12;\r\nconst LEGEND_ROW_HEIGHT = 24;\r\nconst ICON_SIZE = 16;\r\nconst ICON_TEXT_GAP = 8;\r\nconst SECTION_GAP = 16;\r\n\r\n/**\r\n * Render the legend component.\r\n */\r\nexport function renderLegend(\r\n  svg: d3.Selection<SVGSVGElement, unknown, null, undefined>,\r\n  theme: GraphTheme,\r\n  options: LegendOptions\r\n): d3.Selection<SVGGElement, unknown, null, undefined> {\r\n  // Remove existing legend\r\n  svg.select('.legend').remove();\r\n\r\n  if (options.collapsed) {\r\n    return renderCollapsedLegend(svg, options);\r\n  }\r\n\r\n  const legend = svg\r\n    .append('g')\r\n    .attr('class', 'legend')\r\n    .attr('transform', `translate(${options.x}, ${options.y})`);\r\n\r\n  // Background\r\n  const bgRect = legend\r\n    .append('rect')\r\n    .attr('class', 'legend-bg')\r\n    .attr('fill', 'white')\r\n    .attr('stroke', '#e5e7eb')\r\n    .attr('stroke-width', 1)\r\n    .attr('rx', 8);\r\n\r\n  let currentY = LEGEND_PADDING;\r\n\r\n  // Title\r\n  legend\r\n    .append('text')\r\n    .attr('class', 'legend-title')\r\n    .attr('x', LEGEND_PADDING)\r\n    .attr('y', currentY + 12)\r\n    .attr('font-size', 12)\r\n    .attr('font-weight', 'bold')\r\n    .attr('fill', '#374151')\r\n    .text('Legend');\r\n\r\n  currentY += LEGEND_ROW_HEIGHT + 4;\r\n\r\n  // Node Types section\r\n  legend\r\n    .append('text')\r\n    .attr('class', 'legend-section')\r\n    .attr('x', LEGEND_PADDING)\r\n    .attr('y', currentY + 10)\r\n    .attr('font-size', 10)\r\n    .attr('fill', '#6b7280')\r\n    .text('Node Types');\r\n\r\n  currentY += LEGEND_ROW_HEIGHT - 4;\r\n\r\n  // Behaviour\r\n  renderLegendNodeItem(legend, LEGEND_PADDING, currentY, 'Behaviour', theme.nodes.behaviour);\r\n  currentY += LEGEND_ROW_HEIGHT;\r\n\r\n  // Outcome\r\n  renderLegendNodeItem(legend, LEGEND_PADDING, currentY, 'Outcome', theme.nodes.outcome);\r\n  currentY += LEGEND_ROW_HEIGHT;\r\n\r\n  // Value\r\n  renderLegendNodeItem(legend, LEGEND_PADDING, currentY, 'Value', theme.nodes.value);\r\n  currentY += LEGEND_ROW_HEIGHT + SECTION_GAP;\r\n\r\n  // Edge Valence section\r\n  legend\r\n    .append('text')\r\n    .attr('class', 'legend-section')\r\n    .attr('x', LEGEND_PADDING)\r\n    .attr('y', currentY + 10)\r\n    .attr('font-size', 10)\r\n    .attr('fill', '#6b7280')\r\n    .text('Edge Valence');\r\n\r\n  currentY += LEGEND_ROW_HEIGHT - 4;\r\n\r\n  // Positive edge\r\n  renderLegendEdgeItem(legend, LEGEND_PADDING, currentY, 'Positive', theme.edges.positive.stroke, '');\r\n  currentY += LEGEND_ROW_HEIGHT;\r\n\r\n  // Negative edge\r\n  renderLegendEdgeItem(legend, LEGEND_PADDING, currentY, 'Negative', theme.edges.negative.stroke, '8,4');\r\n  currentY += LEGEND_ROW_HEIGHT + SECTION_GAP;\r\n\r\n  // Edge Strength section\r\n  legend\r\n    .append('text')\r\n    .attr('class', 'legend-section')\r\n    .attr('x', LEGEND_PADDING)\r\n    .attr('y', currentY + 10)\r\n    .attr('font-size', 10)\r\n    .attr('fill', '#6b7280')\r\n    .text('Edge Strength');\r\n\r\n  currentY += LEGEND_ROW_HEIGHT - 4;\r\n\r\n  // Strong\r\n  renderLegendStrengthItem(legend, LEGEND_PADDING, currentY, 'Strong', 4, 1.0);\r\n  currentY += LEGEND_ROW_HEIGHT;\r\n\r\n  // Moderate\r\n  renderLegendStrengthItem(legend, LEGEND_PADDING, currentY, 'Moderate', 2.5, 0.7);\r\n  currentY += LEGEND_ROW_HEIGHT;\r\n\r\n  // Weak\r\n  renderLegendStrengthItem(legend, LEGEND_PADDING, currentY, 'Weak', 1, 0.4);\r\n  currentY += LEGEND_ROW_HEIGHT;\r\n\r\n  // Size background to content\r\n  const legendWidth = 140;\r\n  bgRect\r\n    .attr('width', legendWidth)\r\n    .attr('height', currentY + LEGEND_PADDING);\r\n\r\n  return legend;\r\n}\r\n\r\n/**\r\n * Render collapsed legend (just an icon button).\r\n */\r\nfunction renderCollapsedLegend(\r\n  svg: d3.Selection<SVGSVGElement, unknown, null, undefined>,\r\n  options: LegendOptions\r\n): d3.Selection<SVGGElement, unknown, null, undefined> {\r\n  const legend = svg\r\n    .append('g')\r\n    .attr('class', 'legend collapsed')\r\n    .attr('transform', `translate(${options.x}, ${options.y})`)\r\n    .style('cursor', 'pointer');\r\n\r\n  legend\r\n    .append('rect')\r\n    .attr('width', 32)\r\n    .attr('height', 32)\r\n    .attr('rx', 6)\r\n    .attr('fill', 'white')\r\n    .attr('stroke', '#e5e7eb');\r\n\r\n  // Question mark icon\r\n  legend\r\n    .append('text')\r\n    .attr('x', 16)\r\n    .attr('y', 22)\r\n    .attr('text-anchor', 'middle')\r\n    .attr('font-size', 16)\r\n    .attr('fill', '#6b7280')\r\n    .text('?');\r\n\r\n  return legend;\r\n}\r\n\r\n/**\r\n * Render a node type legend item.\r\n */\r\nfunction renderLegendNodeItem(\r\n  legend: d3.Selection<SVGGElement, unknown, null, undefined>,\r\n  x: number,\r\n  y: number,\r\n  label: string,\r\n  config: { shape: string; fill: string }\r\n): void {\r\n  const iconX = x + ICON_SIZE / 2;\r\n  const iconY = y + ICON_SIZE / 2;\r\n\r\n  switch (config.shape) {\r\n    case 'rect':\r\n      legend\r\n        .append('rect')\r\n        .attr('x', x)\r\n        .attr('y', y)\r\n        .attr('width', ICON_SIZE)\r\n        .attr('height', ICON_SIZE)\r\n        .attr('rx', 3)\r\n        .attr('fill', config.fill);\r\n      break;\r\n    case 'diamond':\r\n      legend\r\n        .append('polygon')\r\n        .attr('points', `${iconX},${y} ${x + ICON_SIZE},${iconY} ${iconX},${y + ICON_SIZE} ${x},${iconY}`)\r\n        .attr('fill', config.fill);\r\n      break;\r\n    case 'circle':\r\n      legend\r\n        .append('circle')\r\n        .attr('cx', iconX)\r\n        .attr('cy', iconY)\r\n        .attr('r', ICON_SIZE / 2)\r\n        .attr('fill', config.fill);\r\n      break;\r\n  }\r\n\r\n  legend\r\n    .append('text')\r\n    .attr('x', x + ICON_SIZE + ICON_TEXT_GAP)\r\n    .attr('y', y + ICON_SIZE / 2 + 4)\r\n    .attr('font-size', 11)\r\n    .attr('fill', '#374151')\r\n    .text(label);\r\n}\r\n\r\n/**\r\n * Render an edge valence legend item.\r\n */\r\nfunction renderLegendEdgeItem(\r\n  legend: d3.Selection<SVGGElement, unknown, null, undefined>,\r\n  x: number,\r\n  y: number,\r\n  label: string,\r\n  stroke: string,\r\n  dasharray: string\r\n): void {\r\n  legend\r\n    .append('line')\r\n    .attr('x1', x)\r\n    .attr('y1', y + ICON_SIZE / 2)\r\n    .attr('x2', x + ICON_SIZE + 8)\r\n    .attr('y2', y + ICON_SIZE / 2)\r\n    .attr('stroke', stroke)\r\n    .attr('stroke-width', 2)\r\n    .attr('stroke-dasharray', dasharray);\r\n\r\n  legend\r\n    .append('text')\r\n    .attr('x', x + ICON_SIZE + ICON_TEXT_GAP + 8)\r\n    .attr('y', y + ICON_SIZE / 2 + 4)\r\n    .attr('font-size', 11)\r\n    .attr('fill', '#374151')\r\n    .text(label);\r\n}\r\n\r\n/**\r\n * Render an edge strength legend item.\r\n */\r\nfunction renderLegendStrengthItem(\r\n  legend: d3.Selection<SVGGElement, unknown, null, undefined>,\r\n  x: number,\r\n  y: number,\r\n  label: string,\r\n  width: number,\r\n  opacity: number\r\n): void {\r\n  legend\r\n    .append('line')\r\n    .attr('x1', x)\r\n    .attr('y1', y + ICON_SIZE / 2)\r\n    .attr('x2', x + ICON_SIZE + 8)\r\n    .attr('y2', y + ICON_SIZE / 2)\r\n    .attr('stroke', '#6b7280')\r\n    .attr('stroke-width', width)\r\n    .attr('opacity', opacity);\r\n\r\n  legend\r\n    .append('text')\r\n    .attr('x', x + ICON_SIZE + ICON_TEXT_GAP + 8)\r\n    .attr('y', y + ICON_SIZE / 2 + 4)\r\n    .attr('font-size', 11)\r\n    .attr('fill', '#374151')\r\n    .text(label);\r\n}\r\n","/**\r\n * NetworkGraph Component\r\n *\r\n * Main D3.js visualization component for rendering the M-E Network.\r\n * Per visual-design.md specification.\r\n */\r\n\r\nimport * as d3 from 'd3';\r\n\r\nimport type { Network } from '@/types';\r\n\r\nimport { getConnectedEdgeIds, getConnectedNodeIds, networkToGraphData } from './data';\r\nimport { renderEdges, updateEdgePaths } from './edges';\r\nimport { applyLayeredLayout, sortNodesByConnectivity } from './layout';\r\nimport { renderLegend } from './legend';\r\nimport { createDefs, getNodeConfig, renderNodeLabel, renderNodeShape } from './nodes';\r\nimport { defaultGraphOptions } from './theme';\r\nimport type {\r\n  AnyGraphNode,\r\n  GraphData,\r\n  GraphEdge,\r\n  GraphInteractionState,\r\n  GraphOptions,\r\n} from './types';\r\n\r\n// ============================================================================\r\n// NetworkGraph Class\r\n// ============================================================================\r\n\r\nexport class NetworkGraph {\r\n  private svg: d3.Selection<SVGSVGElement, unknown, null, undefined>;\r\n  private zoomGroup: d3.Selection<SVGGElement, unknown, null, undefined>;\r\n  private edgeGroup: d3.Selection<SVGGElement, unknown, null, undefined>;\r\n  private nodeGroup: d3.Selection<SVGGElement, unknown, null, undefined>;\r\n\r\n  private options: GraphOptions;\r\n  private graphData: GraphData;\r\n  private interactionState: GraphInteractionState;\r\n\r\n  private zoom: d3.ZoomBehavior<SVGSVGElement, unknown>;\r\n  private edgeSelection: d3.Selection<SVGPathElement, GraphEdge, SVGGElement, unknown> | null = null;\r\n  private nodeSelection: d3.Selection<SVGGElement, AnyGraphNode, SVGGElement, unknown> | null = null;\r\n  private keydownHandler: ((event: KeyboardEvent) => void) | null = null;\r\n\r\n  // Event callbacks\r\n  private onNodeClick?: (node: AnyGraphNode) => void;\r\n  private onNodeHover?: (node: AnyGraphNode | null) => void;\r\n  private onBackgroundClick?: () => void;\r\n\r\n  constructor(container: HTMLElement, options: Partial<GraphOptions> = {}) {\r\n    this.options = { ...defaultGraphOptions, ...options };\r\n    this.graphData = { nodes: [], edges: [] };\r\n    this.interactionState = {\r\n      selectedNodeId: null,\r\n      hoveredNodeId: null,\r\n      hoveredEdgeId: null,\r\n      hoverHighlightedNodeIds: new Set(),\r\n      modeHighlightedNodeIds: new Set(),\r\n      searchQuery: '',\r\n      nodeTypeVisibility: { behaviour: true, outcome: true, value: true },\r\n      valenceVisibility: { positive: true, negative: true },\r\n    };\r\n\r\n    // Create SVG\r\n    this.svg = d3\r\n      .select(container)\r\n      .append('svg')\r\n      .attr('width', this.options.width)\r\n      .attr('height', this.options.height)\r\n      .attr('class', 'network-graph')\r\n      .style('background', this.options.theme.background);\r\n\r\n    // Create defs (markers, filters)\r\n    createDefs(this.svg, this.options.theme);\r\n\r\n    // Create zoom group\r\n    this.zoomGroup = this.svg.append('g').attr('class', 'zoom-group');\r\n\r\n    // Create layer groups (edges under nodes)\r\n    this.edgeGroup = this.zoomGroup.append('g').attr('class', 'edges');\r\n    this.nodeGroup = this.zoomGroup.append('g').attr('class', 'nodes');\r\n\r\n    // Setup zoom behavior\r\n    this.zoom = d3\r\n      .zoom<SVGSVGElement, unknown>()\r\n      .scaleExtent(this.options.zoomExtent)\r\n      .on('zoom', (event: d3.D3ZoomEvent<SVGSVGElement, unknown>) => {\r\n        this.zoomGroup.attr('transform', event.transform.toString());\r\n      });\r\n\r\n    this.svg.call(this.zoom);\r\n\r\n    this.keydownHandler = (event: KeyboardEvent): void => {\r\n      if (event.key !== 'Escape') return;\r\n      const target = event.target as HTMLElement | null;\r\n      const tagName = target?.tagName?.toLowerCase();\r\n      if (tagName && (tagName === 'input' || tagName === 'textarea' || tagName === 'select')) {\r\n        return;\r\n      }\r\n      this.clearSelection();\r\n      this.onBackgroundClick?.();\r\n    };\r\n    document.addEventListener('keydown', this.keydownHandler);\r\n\r\n    // Background click handler\r\n    this.svg.on('click', (event: MouseEvent) => {\r\n      if (event.target === this.svg.node()) {\r\n        this.clearSelection();\r\n        this.onBackgroundClick?.();\r\n      }\r\n    });\r\n\r\n    // Render legend\r\n    this.renderLegend();\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Public API\r\n  // ==========================================================================\r\n\r\n  /**\r\n   * Update the graph with new network data.\r\n   */\r\n  public setNetwork(network: Network): void {\r\n    this.graphData = networkToGraphData(network);\r\n\r\n    const nodeLookup = new Map(this.graphData.nodes.map((node) => [node.id, node] as const));\r\n    for (const edge of this.graphData.edges) {\r\n      const sourceId = typeof edge.source === 'string' ? edge.source : edge.source.id;\r\n      const targetId = typeof edge.target === 'string' ? edge.target : edge.target.id;\r\n      const sourceNode = nodeLookup.get(sourceId);\r\n      const targetNode = nodeLookup.get(targetId);\r\n      if (sourceNode) {\r\n        edge.source = sourceNode;\r\n      }\r\n      if (targetNode) {\r\n        edge.target = targetNode;\r\n      }\r\n    }\r\n\r\n    // Sort nodes to minimize edge crossings\r\n    sortNodesByConnectivity(this.graphData);\r\n\r\n    // Apply layout\r\n    if (this.options.layout.type === 'layered') {\r\n      applyLayeredLayout(\r\n        this.graphData,\r\n        this.options.layout,\r\n        this.options.width,\r\n        this.options.height\r\n      );\r\n    }\r\n\r\n    this.render();\r\n    // Re-apply current selection/filter state to new DOM elements\r\n    this.updateSelectionState();\r\n  }\r\n\r\n  /**\r\n   * Resize the graph canvas.\r\n   */\r\n  public resize(width: number, height: number): void {\r\n    this.options.width = width;\r\n    this.options.height = height;\r\n\r\n    this.svg.attr('width', width).attr('height', height);\r\n\r\n    // Re-apply layout\r\n    if (this.options.layout.type === 'layered') {\r\n      applyLayeredLayout(this.graphData, this.options.layout, width, height);\r\n    }\r\n\r\n    this.updatePositions();\r\n    this.renderLegend();\r\n  }\r\n\r\n  /**\r\n   * Zoom to fit all nodes in view.\r\n   */\r\n  public fitToView(): void {\r\n    if (this.graphData.nodes.length === 0) return;\r\n\r\n    const bounds = this.calculateBounds();\r\n    const padding = 40;\r\n\r\n    const width = bounds.maxX - bounds.minX + padding * 2;\r\n    const height = bounds.maxY - bounds.minY + padding * 2;\r\n\r\n    const scale = Math.min(\r\n      this.options.width / width,\r\n      this.options.height / height,\r\n      1 // Don't zoom in beyond 100%\r\n    );\r\n\r\n    const centerX = (bounds.minX + bounds.maxX) / 2;\r\n    const centerY = (bounds.minY + bounds.maxY) / 2;\r\n\r\n    const transform = d3.zoomIdentity\r\n      .translate(this.options.width / 2, this.options.height / 2)\r\n      .scale(scale)\r\n      .translate(-centerX, -centerY);\r\n\r\n    this.svg\r\n      .transition()\r\n      .duration(this.options.transitionDuration)\r\n      .call((selection) => this.zoom.transform(selection, transform));\r\n  }\r\n\r\n  /**\r\n   * Reset zoom to default.\r\n   */\r\n  public resetZoom(): void {\r\n    this.svg\r\n      .transition()\r\n      .duration(this.options.transitionDuration)\r\n      .call((selection) => this.zoom.transform(selection, d3.zoomIdentity));\r\n  }\r\n\r\n  /**\r\n   * Select a node by ID.\r\n   */\r\n  public selectNode(nodeId: string): void {\r\n    this.interactionState.selectedNodeId = nodeId;\r\n    this.updateSelectionState();\r\n  }\r\n\r\n  /**\r\n   * Clear current selection.\r\n   */\r\n  public clearSelection(): void {\r\n    this.interactionState.selectedNodeId = null;\r\n    this.interactionState.hoverHighlightedNodeIds.clear();\r\n    this.updateSelectionState();\r\n  }\r\n\r\n  /**\r\n   * Set node click callback.\r\n   */\r\n  public setOnNodeClick(callback: (node: AnyGraphNode) => void): void {\r\n    this.onNodeClick = callback;\r\n  }\r\n\r\n  /**\r\n   * Set node hover callback.\r\n   */\r\n  public setOnNodeHover(callback: (node: AnyGraphNode | null) => void): void {\r\n    this.onNodeHover = callback;\r\n  }\r\n\r\n  /**\r\n   * Set background click callback.\r\n   */\r\n  public setOnBackgroundClick(callback: () => void): void {\r\n    this.onBackgroundClick = callback;\r\n  }\r\n\r\n  /**\r\n   * Set search query for filtering nodes.\r\n   */\r\n  public setSearchQuery(query: string): void {\r\n    this.interactionState.searchQuery = query;\r\n    // When search is active, disable hover highlighting to avoid fighting states.\r\n    if (query.trim() !== '') {\r\n      this.interactionState.hoverHighlightedNodeIds.clear();\r\n    }\r\n    this.updateSelectionState();\r\n  }\r\n\r\n  /**\r\n   * Set node type visibility.\r\n   */\r\n  public setNodeTypeVisibility(\r\n    nodeType: 'behaviour' | 'outcome' | 'value',\r\n    visible: boolean\r\n  ): void {\r\n    this.interactionState.nodeTypeVisibility[nodeType] = visible;\r\n    this.updateSelectionState();\r\n  }\r\n\r\n  /**\r\n   * Set edge valence visibility.\r\n   */\r\n  public setValenceVisibility(valence: 'positive' | 'negative', visible: boolean): void {\r\n    this.interactionState.valenceVisibility[valence] = visible;\r\n    this.updateSelectionState();\r\n  }\r\n\r\n  /**\r\n   * Set highlighted node IDs (for highlight modes).\r\n   */\r\n  public setHighlightedNodes(nodeIds: Set<string>): void {\r\n    this.interactionState.modeHighlightedNodeIds = nodeIds;\r\n    // Disable hover highlight while an explicit mode is active.\r\n    if (nodeIds.size > 0) {\r\n      this.interactionState.hoverHighlightedNodeIds.clear();\r\n    }\r\n    this.updateSelectionState();\r\n  }\r\n\r\n  /**\r\n   * Clear all highlights.\r\n   */\r\n  public clearHighlights(): void {\r\n    this.interactionState.modeHighlightedNodeIds.clear();\r\n    this.updateSelectionState();\r\n  }\r\n\r\n  /**\r\n   * Destroy the graph and clean up.\r\n   */\r\n  public destroy(): void {\r\n    if (this.keydownHandler) {\r\n      document.removeEventListener('keydown', this.keydownHandler);\r\n    }\r\n    this.svg.remove();\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Private Methods\r\n  // ==========================================================================\r\n\r\n  /**\r\n   * Render the complete graph.\r\n   */\r\n  private render(): void {\r\n    this.renderEdges();\r\n    this.renderNodes();\r\n    this.updatePositions();\r\n  }\r\n\r\n  private buildNodeAriaLabel(node: AnyGraphNode): string {\r\n    const typeLabel = `${node.type.charAt(0).toUpperCase()}${node.type.slice(1)}`;\r\n    return `${typeLabel} node ${node.label}. Press Enter to select.`;\r\n  }\r\n\r\n  /**\r\n   * Render edge elements.\r\n   */\r\n  private renderEdges(): void {\r\n    this.edgeSelection = renderEdges(this.edgeGroup, this.graphData.edges, this.options.theme);\r\n\r\n    // Edge hover\r\n    this.edgeSelection\r\n      .on('mouseenter', (_event: MouseEvent, d: GraphEdge) => {\r\n        this.interactionState.hoveredEdgeId = d.id;\r\n      })\r\n      .on('mouseleave', () => {\r\n        this.interactionState.hoveredEdgeId = null;\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Render node elements.\r\n   */\r\n  private renderNodes(): void {\r\n    const selection = this.nodeGroup\r\n      .selectAll<SVGGElement, AnyGraphNode>('g.node')\r\n      .data(this.graphData.nodes, (d) => d.id);\r\n\r\n    // Exit\r\n    selection.exit().remove();\r\n\r\n    // Enter\r\n    const nodeEnter = selection\r\n      .enter()\r\n      .append('g')\r\n      .attr('class', 'node')\r\n      .attr('tabindex', 0)\r\n      .attr('role', 'button')\r\n      .attr('focusable', 'true')\r\n      .attr('aria-keyshortcuts', 'Enter Space')\r\n      .attr('aria-label', (d) => this.buildNodeAriaLabel(d))\r\n      .style('cursor', 'pointer');\r\n\r\n    // Render shapes and labels\r\n    renderNodeShape(nodeEnter, this.options.theme);\r\n    renderNodeLabel(nodeEnter, this.options.theme);\r\n\r\n    // Merge\r\n    this.nodeSelection = nodeEnter.merge(selection);\r\n    this.nodeSelection\r\n      .attr('tabindex', 0)\r\n      .attr('role', 'button')\r\n      .attr('focusable', 'true')\r\n      .attr('aria-keyshortcuts', 'Enter Space')\r\n      .attr('aria-label', (d) => this.buildNodeAriaLabel(d));\r\n\r\n    // Event handlers\r\n    this.nodeSelection\r\n      .on('click', (event: MouseEvent, d: AnyGraphNode) => {\r\n        event.stopPropagation();\r\n        this.selectNode(d.id);\r\n        this.onNodeClick?.(d);\r\n      })\r\n      .on('keydown', (event: KeyboardEvent, d: AnyGraphNode) => {\r\n        if (event.key === 'Enter' || event.key === ' ') {\r\n          event.preventDefault();\r\n          this.selectNode(d.id);\r\n          this.onNodeClick?.(d);\r\n        }\r\n      })\r\n      .on('focus', (_event: FocusEvent, d: AnyGraphNode) => {\r\n        this.interactionState.hoveredNodeId = d.id;\r\n        this.highlightConnected(d.id);\r\n        this.onNodeHover?.(d);\r\n      })\r\n      .on('blur', () => {\r\n        this.interactionState.hoveredNodeId = null;\r\n        this.clearHighlight();\r\n        this.onNodeHover?.(null);\r\n      })\r\n      .on('mouseenter', (_event: MouseEvent, d: AnyGraphNode) => {\r\n        this.interactionState.hoveredNodeId = d.id;\r\n        this.highlightConnected(d.id);\r\n        this.onNodeHover?.(d);\r\n      })\r\n      .on('mouseleave', () => {\r\n        this.interactionState.hoveredNodeId = null;\r\n        if (this.interactionState.selectedNodeId === null) {\r\n          this.clearHighlight();\r\n        }\r\n        this.onNodeHover?.(null);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Update node and edge positions.\r\n   */\r\n  private updatePositions(): void {\r\n    // Update node positions\r\n    this.nodeSelection?.attr('transform', (d) => `translate(${d.x ?? 0}, ${d.y ?? 0})`);\r\n\r\n    // Update edge paths\r\n    if (this.edgeSelection) {\r\n      updateEdgePaths(this.edgeSelection, this.options.theme);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update visual state based on selection/hover.\r\n   */\r\n  private updateSelectionState(): void {\r\n    const selectedId = this.interactionState.selectedNodeId;\r\n    const { nodeTypeVisibility, valenceVisibility, searchQuery } = this.interactionState;\r\n    const searchActive = searchQuery.trim() !== '';\r\n\r\n    const nodeById = new Map(this.graphData.nodes.map((n) => [n.id, n] as const));\r\n\r\n    const modeHighlightedIds = this.interactionState.modeHighlightedNodeIds;\r\n    const hoverHighlightedIds = this.interactionState.hoverHighlightedNodeIds;\r\n    const modeActive = modeHighlightedIds.size > 0;\r\n    const hoverActive = !modeActive && !searchActive && hoverHighlightedIds.size > 0;\r\n\r\n    const activeHighlightedIds = modeActive ? modeHighlightedIds : hoverActive ? hoverHighlightedIds : new Set<string>();\r\n\r\n    // Update node styling\r\n    this.nodeSelection?.each(function (d) {\r\n      const group = d3.select(this);\r\n      const isSelected = d.id === selectedId;\r\n      const typeEnabled = nodeTypeVisibility[d.type];\r\n      const matchesSearch = !searchActive || d.label.toLowerCase().includes(searchQuery.toLowerCase().trim());\r\n\r\n      const isHighlighted = activeHighlightedIds.has(d.id) || (searchActive && matchesSearch);\r\n\r\n      // Dimming rules:\r\n      // - Node type filter: disable -> dim node but keep it visible\r\n      // - Search: active -> dim non-matches\r\n      // - Highlight mode: active -> dim nodes not in mode set\r\n      // - Hover highlight: active (and no search/mode) -> dim nodes not in hover set\r\n      const dimByType = !typeEnabled;\r\n      const dimBySearch = searchActive && !matchesSearch;\r\n      const dimByMode = modeActive && !modeHighlightedIds.has(d.id);\r\n      const dimByHover = hoverActive && !hoverHighlightedIds.has(d.id) && d.id !== selectedId;\r\n\r\n      const isDimmed = !isSelected && (dimByType || dimBySearch || dimByMode || dimByHover);\r\n\r\n      group.classed('selected', isSelected);\r\n      group.classed('highlighted', isHighlighted);\r\n      group.classed('dimmed', isDimmed);\r\n      group.attr('aria-pressed', isSelected ? 'true' : 'false');\r\n\r\n      group\r\n        .select('.node-shape')\r\n        .attr('filter', isSelected ? 'url(#drop-shadow)' : null)\r\n        .attr('stroke-width', isSelected ? 3 : 2)\r\n        .attr('opacity', isDimmed ? 0.3 : 1);\r\n\r\n      group.select('.node-label').attr('opacity', isDimmed ? 0.3 : 1);\r\n    });\r\n\r\n    // Update edge styling\r\n    this.edgeSelection?.each(function (d) {\r\n      const edge = d3.select(this);\r\n      const sourceId = typeof d.source === 'string' ? d.source : d.source.id;\r\n      const targetId = typeof d.target === 'string' ? d.target : d.target.id;\r\n\r\n      const sourceNode = nodeById.get(sourceId);\r\n      const targetNode = nodeById.get(targetId);\r\n\r\n      // Determine if edge should be hidden due to filters\r\n      const valenceEnabled = valenceVisibility[d.valence];\r\n      const sourceTypeEnabled = sourceNode ? nodeTypeVisibility[sourceNode.type] : true;\r\n      const targetTypeEnabled = targetNode ? nodeTypeVisibility[targetNode.type] : true;\r\n\r\n      const isHidden = !valenceEnabled || !sourceTypeEnabled || !targetTypeEnabled;\r\n      edge.classed('filtered-hidden', isHidden);\r\n      if (isHidden) {\r\n        edge.style('display', 'none');\r\n        return;\r\n      }\r\n      edge.style('display', null);\r\n\r\n      // Dimming rules:\r\n      // - Highlight mode: dim edges when neither endpoint is highlighted\r\n      // - Search: dim edges when neither endpoint matches search\r\n      // - Hover highlight: dim edges when not connected to hovered/selected neighborhood\r\n      const isConnectedToSelected = sourceId === selectedId || targetId === selectedId;\r\n      const isConnectedToActiveHighlight =\r\n        activeHighlightedIds.has(sourceId) || activeHighlightedIds.has(targetId);\r\n\r\n      const dimByModeEdge = modeActive && !isConnectedToActiveHighlight && !isConnectedToSelected;\r\n\r\n      const q = searchQuery.toLowerCase().trim();\r\n      const sourceMatchesSearch = !searchActive || (sourceNode?.label.toLowerCase().includes(q) ?? false);\r\n      const targetMatchesSearch = !searchActive || (targetNode?.label.toLowerCase().includes(q) ?? false);\r\n      const dimBySearchEdge = searchActive && !sourceMatchesSearch && !targetMatchesSearch;\r\n\r\n      const dimByHoverEdge = hoverActive && !isConnectedToActiveHighlight && !isConnectedToSelected;\r\n\r\n      const isDimmed = dimByModeEdge || dimBySearchEdge || dimByHoverEdge;\r\n\r\n      edge.classed('dimmed', isDimmed);\r\n      edge.attr('opacity', isDimmed ? 0.15 : null);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Highlight nodes connected to the given node.\r\n   */\r\n  private highlightConnected(nodeId: string): void {\r\n    // Don't override active search/highlight mode.\r\n    if (this.interactionState.modeHighlightedNodeIds.size > 0) return;\r\n    if (this.interactionState.searchQuery.trim() !== '') return;\r\n\r\n    const connectedNodes = getConnectedNodeIds(this.graphData, nodeId);\r\n    const connectedEdges = getConnectedEdgeIds(this.graphData, nodeId);\r\n\r\n    this.interactionState.hoverHighlightedNodeIds = new Set([nodeId, ...connectedNodes]);\r\n\r\n    this.updateSelectionState();\r\n\r\n    // Also store connected edges for potential edge highlighting\r\n    void connectedEdges; // Currently unused but available\r\n  }\r\n\r\n  /**\r\n   * Clear all highlighting.\r\n   */\r\n  private clearHighlight(): void {\r\n    this.interactionState.hoverHighlightedNodeIds.clear();\r\n    this.updateSelectionState();\r\n  }\r\n\r\n  /**\r\n   * Calculate bounding box of all nodes.\r\n   */\r\n  private calculateBounds(): { minX: number; minY: number; maxX: number; maxY: number } {\r\n    let minX = Infinity,\r\n      minY = Infinity,\r\n      maxX = -Infinity,\r\n      maxY = -Infinity;\r\n\r\n    for (const node of this.graphData.nodes) {\r\n      const config = getNodeConfig(this.options.theme, node.type);\r\n      const x = node.x ?? 0;\r\n      const y = node.y ?? 0;\r\n      const halfW = config.width / 2;\r\n      const halfH = config.height / 2;\r\n\r\n      minX = Math.min(minX, x - halfW);\r\n      minY = Math.min(minY, y - halfH);\r\n      maxX = Math.max(maxX, x + halfW);\r\n      maxY = Math.max(maxY, y + halfH);\r\n    }\r\n\r\n    return { minX, minY, maxX, maxY };\r\n  }\r\n\r\n  /**\r\n   * Render the legend component.\r\n   */\r\n  private renderLegend(): void {\r\n    renderLegend(this.svg, this.options.theme, {\r\n      x: this.options.width - 160,\r\n      y: 20,\r\n      collapsed: false,\r\n    });\r\n  }\r\n}\r\n","/**\r\n * Numeric Mappings for Metrics Computation\r\n *\r\n * Maps qualitative attributes to numeric values for calculations.\r\n * See docs/metrics-and-insights.md for specification.\r\n */\r\n\r\nimport type { Reliability, Strength, Cost, Importance, Neglect, Valence } from '@/types';\r\n\r\n// ============================================================================\r\n// Link Reliability (Behaviour → Outcome)\r\n// ============================================================================\r\n\r\nconst RELIABILITY_VALUES: Record<Reliability, number> = {\r\n  always: 1.0,\r\n  usually: 0.75,\r\n  sometimes: 0.5,\r\n  rarely: 0.25,\r\n};\r\n\r\nexport function reliabilityToNumber(reliability: Reliability): number {\r\n  return RELIABILITY_VALUES[reliability];\r\n}\r\n\r\n// ============================================================================\r\n// Link Strength (Outcome → Value)\r\n// ============================================================================\r\n\r\nconst STRENGTH_VALUES: Record<Strength, number> = {\r\n  strong: 1.0,\r\n  moderate: 0.6,\r\n  weak: 0.3,\r\n};\r\n\r\nexport function strengthToNumber(strength: Strength): number {\r\n  return STRENGTH_VALUES[strength];\r\n}\r\n\r\n// ============================================================================\r\n// Link Valence\r\n// ============================================================================\r\n\r\nconst VALENCE_MULTIPLIERS: Record<Valence, number> = {\r\n  positive: 1,\r\n  negative: -1,\r\n};\r\n\r\nexport function valenceToMultiplier(valence: Valence): number {\r\n  return VALENCE_MULTIPLIERS[valence];\r\n}\r\n\r\n// ============================================================================\r\n// Behaviour Cost (used as divisor - lower cost = higher efficiency)\r\n// ============================================================================\r\n\r\nconst COST_VALUES: Record<Cost, number> = {\r\n  trivial: 1,\r\n  low: 2,\r\n  medium: 4,\r\n  high: 8,\r\n  'very-high': 16,\r\n};\r\n\r\nexport function costToNumber(cost: Cost): number {\r\n  return COST_VALUES[cost];\r\n}\r\n\r\n// ============================================================================\r\n// Value Importance\r\n// ============================================================================\r\n\r\nconst IMPORTANCE_VALUES: Record<Importance, number> = {\r\n  critical: 4,\r\n  high: 3,\r\n  medium: 2,\r\n  low: 1,\r\n};\r\n\r\nexport function importanceToNumber(importance: Importance): number {\r\n  return IMPORTANCE_VALUES[importance];\r\n}\r\n\r\n// ============================================================================\r\n// Value Neglect\r\n// ============================================================================\r\n\r\nconst NEGLECT_VALUES: Record<Neglect, number> = {\r\n  'severely-neglected': 4,\r\n  'somewhat-neglected': 3,\r\n  'adequately-met': 2,\r\n  'well-satisfied': 1,\r\n};\r\n\r\nexport function neglectToNumber(neglect: Neglect): number {\r\n  return NEGLECT_VALUES[neglect];\r\n}\r\n\r\n// ============================================================================\r\n// Exports for constants (useful for tests)\r\n// ============================================================================\r\n\r\nexport const MAPPINGS = {\r\n  reliability: RELIABILITY_VALUES,\r\n  strength: STRENGTH_VALUES,\r\n  valence: VALENCE_MULTIPLIERS,\r\n  cost: COST_VALUES,\r\n  importance: IMPORTANCE_VALUES,\r\n  neglect: NEGLECT_VALUES,\r\n} as const;\r\n","/**\r\n * Path Computation for Metrics\r\n *\r\n * Computes all paths from behaviours through outcomes to values,\r\n * along with weighted influence values.\r\n */\r\n\r\nimport type {\r\n  Network,\r\n  Behaviour,\r\n  Value,\r\n  BehaviourOutcomeLink,\r\n  OutcomeValueLink,\r\n} from '@/types';\r\n\r\nimport {\r\n  reliabilityToNumber,\r\n  strengthToNumber,\r\n  valenceToMultiplier,\r\n  importanceToNumber,\r\n} from './mappings';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\n/**\r\n * Represents a single path from a behaviour through an outcome to a value.\r\n */\r\nexport interface PathToValue {\r\n  behaviourId: string;\r\n  outcomeId: string;\r\n  valueId: string;\r\n  boLinkId: string;\r\n  ovLinkId: string;\r\n  /** Product of valences: positive if both same sign, negative otherwise */\r\n  effectiveValence: 'positive' | 'negative';\r\n  /** Raw path weight: reliability × strength (without valence or importance) */\r\n  pathWeight: number;\r\n  /** Influence contribution: valence × reliability × strength × importance */\r\n  influence: number;\r\n}\r\n\r\n/**\r\n * Summary of all paths from a behaviour to all values.\r\n */\r\nexport interface BehaviourPaths {\r\n  behaviourId: string;\r\n  paths: PathToValue[];\r\n  /** Total positive influence across all paths */\r\n  positiveInfluence: number;\r\n  /** Total negative influence (absolute value) across all paths */\r\n  negativeInfluence: number;\r\n  /** Net influence (positive - negative) */\r\n  netInfluence: number;\r\n  /** Set of value IDs reached via positive paths */\r\n  positiveValueIds: Set<string>;\r\n  /** Set of value IDs reached via negative paths */\r\n  negativeValueIds: Set<string>;\r\n  /** Set of all outcome IDs in paths */\r\n  outcomeIds: Set<string>;\r\n}\r\n\r\n/**\r\n * Summary of all paths supporting a value.\r\n */\r\nexport interface ValueSupport {\r\n  valueId: string;\r\n  paths: PathToValue[];\r\n  /** Total positive support from all behaviours */\r\n  positiveSupport: number;\r\n  /** Total negative impact from all behaviours */\r\n  negativeSupport: number;\r\n  /** Net support (positive - negative abs) */\r\n  netSupport: number;\r\n  /** Set of behaviour IDs that support this value positively */\r\n  supportingBehaviourIds: Set<string>;\r\n  /** Set of behaviour IDs that harm this value */\r\n  harmingBehaviourIds: Set<string>;\r\n}\r\n\r\n// ============================================================================\r\n// Helper Functions\r\n// ============================================================================\r\n\r\nfunction getBehaviours(network: Network): Behaviour[] {\r\n  return network.behaviours;\r\n}\r\n\r\nfunction getValues(network: Network): Value[] {\r\n  return network.values;\r\n}\r\n\r\nfunction getBehaviourOutcomeLinks(network: Network): BehaviourOutcomeLink[] {\r\n  return network.links.filter((l): l is BehaviourOutcomeLink => l.type === 'behaviour-outcome');\r\n}\r\n\r\nfunction getOutcomeValueLinks(network: Network): OutcomeValueLink[] {\r\n  return network.links.filter((l): l is OutcomeValueLink => l.type === 'outcome-value');\r\n}\r\n\r\nfunction findValue(network: Network, id: string): Value | undefined {\r\n  return network.values.find((v) => v.id === id);\r\n}\r\n\r\n// ============================================================================\r\n// Path Computation\r\n// ============================================================================\r\n\r\n/**\r\n * Compute all paths from behaviours to values through outcomes.\r\n */\r\nexport function computeAllPaths(network: Network): PathToValue[] {\r\n  const paths: PathToValue[] = [];\r\n  const boLinks = getBehaviourOutcomeLinks(network);\r\n  const ovLinks = getOutcomeValueLinks(network);\r\n\r\n  // For each B→O link, find all O→V links and create paths\r\n  for (const boLink of boLinks) {\r\n    const outcomeId = boLink.targetId;\r\n\r\n    // Find all O→V links from this outcome\r\n    const relatedOVLinks = ovLinks.filter((l) => l.sourceId === outcomeId);\r\n\r\n    for (const ovLink of relatedOVLinks) {\r\n      const value = findValue(network, ovLink.targetId);\r\n      if (!value) continue;\r\n\r\n      // Compute effective valence: positive×positive=positive, negative×negative=positive, mixed=negative\r\n      const boValence = valenceToMultiplier(boLink.valence);\r\n      const ovValence = valenceToMultiplier(ovLink.valence);\r\n      const combinedValence = boValence * ovValence;\r\n      const effectiveValence: 'positive' | 'negative' = combinedValence > 0 ? 'positive' : 'negative';\r\n\r\n      // Compute path weight (reliability × strength)\r\n      const reliability = reliabilityToNumber(boLink.reliability);\r\n      const strength = strengthToNumber(ovLink.strength);\r\n      const pathWeight = reliability * strength;\r\n\r\n      // Compute influence (valence × weight × importance)\r\n      const importance = importanceToNumber(value.importance);\r\n      const influence = combinedValence * pathWeight * importance;\r\n\r\n      paths.push({\r\n        behaviourId: boLink.sourceId,\r\n        outcomeId,\r\n        valueId: ovLink.targetId,\r\n        boLinkId: boLink.id,\r\n        ovLinkId: ovLink.id,\r\n        effectiveValence,\r\n        pathWeight,\r\n        influence,\r\n      });\r\n    }\r\n  }\r\n\r\n  return paths;\r\n}\r\n\r\n/**\r\n * Group paths by behaviour and compute summaries.\r\n */\r\nexport function groupPathsByBehaviour(network: Network): Map<string, BehaviourPaths> {\r\n  const allPaths = computeAllPaths(network);\r\n  const behaviours = getBehaviours(network);\r\n  const result = new Map<string, BehaviourPaths>();\r\n\r\n  // Initialize for all behaviours (even those with no paths)\r\n  for (const behaviour of behaviours) {\r\n    result.set(behaviour.id, {\r\n      behaviourId: behaviour.id,\r\n      paths: [],\r\n      positiveInfluence: 0,\r\n      negativeInfluence: 0,\r\n      netInfluence: 0,\r\n      positiveValueIds: new Set(),\r\n      negativeValueIds: new Set(),\r\n      outcomeIds: new Set(),\r\n    });\r\n  }\r\n\r\n  // Group paths\r\n  for (const path of allPaths) {\r\n    const summary = result.get(path.behaviourId);\r\n    if (!summary) continue;\r\n\r\n    summary.paths.push(path);\r\n    summary.outcomeIds.add(path.outcomeId);\r\n\r\n    if (path.influence > 0) {\r\n      summary.positiveInfluence += path.influence;\r\n      summary.positiveValueIds.add(path.valueId);\r\n    } else if (path.influence < 0) {\r\n      summary.negativeInfluence += Math.abs(path.influence);\r\n      summary.negativeValueIds.add(path.valueId);\r\n    }\r\n  }\r\n\r\n  // Compute net influence\r\n  for (const summary of result.values()) {\r\n    summary.netInfluence = summary.positiveInfluence - summary.negativeInfluence;\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Group paths by value and compute support summaries.\r\n */\r\nexport function groupPathsByValue(network: Network): Map<string, ValueSupport> {\r\n  const allPaths = computeAllPaths(network);\r\n  const values = getValues(network);\r\n  const result = new Map<string, ValueSupport>();\r\n\r\n  // Initialize for all values (even those with no paths)\r\n  for (const value of values) {\r\n    result.set(value.id, {\r\n      valueId: value.id,\r\n      paths: [],\r\n      positiveSupport: 0,\r\n      negativeSupport: 0,\r\n      netSupport: 0,\r\n      supportingBehaviourIds: new Set(),\r\n      harmingBehaviourIds: new Set(),\r\n    });\r\n  }\r\n\r\n  // Group paths\r\n  for (const path of allPaths) {\r\n    const summary = result.get(path.valueId);\r\n    if (!summary) continue;\r\n\r\n    summary.paths.push(path);\r\n\r\n    if (path.influence > 0) {\r\n      summary.positiveSupport += path.influence;\r\n      summary.supportingBehaviourIds.add(path.behaviourId);\r\n    } else if (path.influence < 0) {\r\n      summary.negativeSupport += Math.abs(path.influence);\r\n      summary.harmingBehaviourIds.add(path.behaviourId);\r\n    }\r\n  }\r\n\r\n  // Compute net support\r\n  for (const summary of result.values()) {\r\n    summary.netSupport = summary.positiveSupport - summary.negativeSupport;\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Get all unique values reached by a behaviour (coverage).\r\n */\r\nexport function getValuesReachedByBehaviour(\r\n  network: Network,\r\n  behaviourId: string\r\n): { positive: string[]; negative: string[] } {\r\n  const pathsByBehaviour = groupPathsByBehaviour(network);\r\n  const summary = pathsByBehaviour.get(behaviourId);\r\n\r\n  if (!summary) {\r\n    return { positive: [], negative: [] };\r\n  }\r\n\r\n  return {\r\n    positive: Array.from(summary.positiveValueIds),\r\n    negative: Array.from(summary.negativeValueIds),\r\n  };\r\n}\r\n\r\n/**\r\n * Get all behaviours that support a value.\r\n */\r\nexport function getBehavioursSupportingValue(\r\n  network: Network,\r\n  valueId: string\r\n): { supporting: string[]; harming: string[] } {\r\n  const pathsByValue = groupPathsByValue(network);\r\n  const summary = pathsByValue.get(valueId);\r\n\r\n  if (!summary) {\r\n    return { supporting: [], harming: [] };\r\n  }\r\n\r\n  return {\r\n    supporting: Array.from(summary.supportingBehaviourIds),\r\n    harming: Array.from(summary.harmingBehaviourIds),\r\n  };\r\n}\r\n\r\n/**\r\n * Get outcomes involved in paths between behaviour and values.\r\n */\r\nexport function getOutcomesForBehaviour(network: Network, behaviourId: string): string[] {\r\n  const pathsByBehaviour = groupPathsByBehaviour(network);\r\n  const summary = pathsByBehaviour.get(behaviourId);\r\n\r\n  if (!summary) {\r\n    return [];\r\n  }\r\n\r\n  return Array.from(summary.outcomeIds);\r\n}\r\n","/**\r\n * Metrics Computation\r\n *\r\n * Computes leverage, fragility, conflict index, and coverage metrics.\r\n * See docs/metrics-and-insights.md for specification.\r\n */\r\n\r\nimport type { Network, Behaviour, Value, BehaviourMetrics, ValueMetrics } from '@/types';\r\n\r\nimport { costToNumber, importanceToNumber, neglectToNumber } from './mappings';\r\nimport { groupPathsByBehaviour, groupPathsByValue, BehaviourPaths, ValueSupport } from './paths';\r\n\r\n// ============================================================================\r\n// Constants\r\n// ============================================================================\r\n\r\n/** Sentinel value for infinite fragility (orphan values) */\r\nexport const INFINITE_FRAGILITY = Infinity;\r\n\r\n/** Threshold for flagging fragile values (from spec) */\r\nexport const FRAGILITY_THRESHOLD = 3.0;\r\n\r\n/** Threshold for flagging conflict behaviours (from spec) */\r\nexport const CONFLICT_THRESHOLD = 0.5;\r\n\r\n/** Number of top behaviours to highlight */\r\nexport const TOP_LEVERAGE_COUNT = 5;\r\n\r\n// ============================================================================\r\n// Leverage Score\r\n// ============================================================================\r\n\r\n/**\r\n * Compute leverage score for a behaviour.\r\n *\r\n * Leverage = TotalInfluence / Cost\r\n *\r\n * Where TotalInfluence is the sum of influence across all paths to values\r\n * (already weighted by importance in path computation).\r\n */\r\nexport function computeLeverageScore(behaviour: Behaviour, paths: BehaviourPaths): number {\r\n  const cost = costToNumber(behaviour.cost);\r\n  const totalInfluence = paths.netInfluence;\r\n\r\n  return totalInfluence / cost;\r\n}\r\n\r\n// ============================================================================\r\n// Coverage\r\n// ============================================================================\r\n\r\n/**\r\n * Compute coverage for a behaviour.\r\n *\r\n * Coverage = number of distinct values reached via positive paths.\r\n */\r\nexport function computeCoverage(paths: BehaviourPaths): number {\r\n  return paths.positiveValueIds.size;\r\n}\r\n\r\n// ============================================================================\r\n// Conflict Index\r\n// ============================================================================\r\n\r\n/**\r\n * Compute conflict index for a behaviour.\r\n *\r\n * ConflictIndex = min(PositiveInfluence, NegativeInfluence)\r\n *\r\n * High conflict = behaviour has substantial effects in both directions.\r\n */\r\nexport function computeConflictIndex(paths: BehaviourPaths): number {\r\n  return Math.min(paths.positiveInfluence, paths.negativeInfluence);\r\n}\r\n\r\n// ============================================================================\r\n// Fragility Score\r\n// ============================================================================\r\n\r\n/**\r\n * Compute fragility score for a value.\r\n *\r\n * Fragility = (Importance × Neglect) / SupportStrength\r\n *\r\n * If SupportStrength = 0 (orphan value), fragility is INFINITE_FRAGILITY.\r\n */\r\nexport function computeFragilityScore(value: Value, support: ValueSupport): number {\r\n  const importance = importanceToNumber(value.importance);\r\n  const neglect = neglectToNumber(value.neglect);\r\n  const supportStrength = support.positiveSupport;\r\n\r\n  if (supportStrength <= 0) {\r\n    return INFINITE_FRAGILITY;\r\n  }\r\n\r\n  return (importance * neglect) / supportStrength;\r\n}\r\n\r\n// ============================================================================\r\n// Aggregate Metrics\r\n// ============================================================================\r\n\r\n/**\r\n * Compute all metrics for all behaviours.\r\n */\r\nexport function computeAllBehaviourMetrics(network: Network): Map<string, BehaviourMetrics> {\r\n  const pathsByBehaviour = groupPathsByBehaviour(network);\r\n  const result = new Map<string, BehaviourMetrics>();\r\n\r\n  for (const behaviour of network.behaviours) {\r\n    const paths = pathsByBehaviour.get(behaviour.id);\r\n    if (!paths) continue;\r\n\r\n    result.set(behaviour.id, {\r\n      behaviourId: behaviour.id,\r\n      leverageScore: computeLeverageScore(behaviour, paths),\r\n      coverage: computeCoverage(paths),\r\n      conflictIndex: computeConflictIndex(paths),\r\n      positiveInfluence: paths.positiveInfluence,\r\n      negativeInfluence: paths.negativeInfluence,\r\n    });\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Compute all metrics for all values.\r\n */\r\nexport function computeAllValueMetrics(network: Network): Map<string, ValueMetrics> {\r\n  const pathsByValue = groupPathsByValue(network);\r\n  const result = new Map<string, ValueMetrics>();\r\n\r\n  for (const value of network.values) {\r\n    const support = pathsByValue.get(value.id);\r\n    if (!support) continue;\r\n\r\n    result.set(value.id, {\r\n      valueId: value.id,\r\n      fragilityScore: computeFragilityScore(value, support),\r\n      supportStrength: support.positiveSupport,\r\n      supportingBehaviours: Array.from(support.supportingBehaviourIds),\r\n    });\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n// ============================================================================\r\n// Insight Getters\r\n// ============================================================================\r\n\r\nexport interface LeverageInsight {\r\n  behaviour: Behaviour;\r\n  metrics: BehaviourMetrics;\r\n  supportedValues: Value[];\r\n  viaOutcomes: string[];\r\n}\r\n\r\nexport interface FragilityInsight {\r\n  value: Value;\r\n  metrics: ValueMetrics;\r\n  supportingBehaviours: Behaviour[];\r\n  isOrphan: boolean;\r\n}\r\n\r\nexport interface ConflictInsight {\r\n  behaviour: Behaviour;\r\n  metrics: BehaviourMetrics;\r\n  positiveValues: Value[];\r\n  negativeValues: Value[];\r\n}\r\n\r\n/**\r\n * Get top leverage behaviours with explanations.\r\n */\r\nexport function getTopLeverageBehaviours(\r\n  network: Network,\r\n  count: number = TOP_LEVERAGE_COUNT\r\n): LeverageInsight[] {\r\n  const behaviourMetrics = computeAllBehaviourMetrics(network);\r\n  const pathsByBehaviour = groupPathsByBehaviour(network);\r\n\r\n  // Sort by leverage (descending)\r\n  const sorted = Array.from(behaviourMetrics.entries())\r\n    .filter(([_, m]) => m.leverageScore > 0) // Only positive leverage\r\n    .sort((a, b) => b[1].leverageScore - a[1].leverageScore)\r\n    .slice(0, count);\r\n\r\n  return sorted.map(([behaviourId, metrics]) => {\r\n    const behaviour = network.behaviours.find((b) => b.id === behaviourId);\r\n    const paths = pathsByBehaviour.get(behaviourId);\r\n\r\n    if (!behaviour || !paths) {\r\n      throw new Error(`Behaviour not found: ${behaviourId}`);\r\n    }\r\n\r\n    // Get supported values\r\n    const supportedValues = network.values.filter((v) => paths.positiveValueIds.has(v.id));\r\n\r\n    // Get outcomes involved\r\n    const viaOutcomes = network.outcomes\r\n      .filter((o) => paths.outcomeIds.has(o.id))\r\n      .map((o) => o.label);\r\n\r\n    return {\r\n      behaviour,\r\n      metrics,\r\n      supportedValues,\r\n      viaOutcomes,\r\n    };\r\n  });\r\n}\r\n\r\n/**\r\n * Get fragile values (fragility > threshold or orphans).\r\n */\r\nexport function getFragileValues(\r\n  network: Network,\r\n  threshold: number = FRAGILITY_THRESHOLD\r\n): FragilityInsight[] {\r\n  const valueMetrics = computeAllValueMetrics(network);\r\n\r\n  // Sort by fragility (descending), orphans first\r\n  const sorted = Array.from(valueMetrics.entries())\r\n    .filter(([_, m]) => m.fragilityScore > threshold || m.fragilityScore === INFINITE_FRAGILITY)\r\n    .sort((a, b) => {\r\n      // Infinite fragility (orphans) always first\r\n      if (a[1].fragilityScore === INFINITE_FRAGILITY && b[1].fragilityScore !== INFINITE_FRAGILITY) {\r\n        return -1;\r\n      }\r\n      if (b[1].fragilityScore === INFINITE_FRAGILITY && a[1].fragilityScore !== INFINITE_FRAGILITY) {\r\n        return 1;\r\n      }\r\n      return b[1].fragilityScore - a[1].fragilityScore;\r\n    });\r\n\r\n  return sorted.map(([valueId, metrics]) => {\r\n    const value = network.values.find((v) => v.id === valueId);\r\n    if (!value) {\r\n      throw new Error(`Value not found: ${valueId}`);\r\n    }\r\n\r\n    const supportingBehaviours = network.behaviours.filter((b) =>\r\n      metrics.supportingBehaviours.includes(b.id)\r\n    );\r\n\r\n    return {\r\n      value,\r\n      metrics,\r\n      supportingBehaviours,\r\n      isOrphan: metrics.fragilityScore === INFINITE_FRAGILITY,\r\n    };\r\n  });\r\n}\r\n\r\n/**\r\n * Get conflict behaviours (conflict index > threshold).\r\n */\r\nexport function getConflictBehaviours(\r\n  network: Network,\r\n  threshold: number = CONFLICT_THRESHOLD\r\n): ConflictInsight[] {\r\n  const behaviourMetrics = computeAllBehaviourMetrics(network);\r\n  const pathsByBehaviour = groupPathsByBehaviour(network);\r\n\r\n  // Sort by conflict index (descending)\r\n  const sorted = Array.from(behaviourMetrics.entries())\r\n    .filter(([_, m]) => m.conflictIndex > threshold)\r\n    .sort((a, b) => b[1].conflictIndex - a[1].conflictIndex);\r\n\r\n  return sorted.map(([behaviourId, metrics]) => {\r\n    const behaviour = network.behaviours.find((b) => b.id === behaviourId);\r\n    const paths = pathsByBehaviour.get(behaviourId);\r\n\r\n    if (!behaviour || !paths) {\r\n      throw new Error(`Behaviour not found: ${behaviourId}`);\r\n    }\r\n\r\n    const positiveValues = network.values.filter((v) => paths.positiveValueIds.has(v.id));\r\n    const negativeValues = network.values.filter((v) => paths.negativeValueIds.has(v.id));\r\n\r\n    return {\r\n      behaviour,\r\n      metrics,\r\n      positiveValues,\r\n      negativeValues,\r\n    };\r\n  });\r\n}\r\n\r\n// ============================================================================\r\n// Full Network Analysis\r\n// ============================================================================\r\n\r\nexport interface NetworkAnalysis {\r\n  behaviourMetrics: Map<string, BehaviourMetrics>;\r\n  valueMetrics: Map<string, ValueMetrics>;\r\n  topLeverage: LeverageInsight[];\r\n  fragileValues: FragilityInsight[];\r\n  conflictBehaviours: ConflictInsight[];\r\n}\r\n\r\n/**\r\n * Perform full network analysis.\r\n */\r\nexport function analyzeNetwork(network: Network): NetworkAnalysis {\r\n  return {\r\n    behaviourMetrics: computeAllBehaviourMetrics(network),\r\n    valueMetrics: computeAllValueMetrics(network),\r\n    topLeverage: getTopLeverageBehaviours(network),\r\n    fragileValues: getFragileValues(network),\r\n    conflictBehaviours: getConflictBehaviours(network),\r\n  };\r\n}\r\n","/**\r\n * Insights Panel Component\r\n *\r\n * Displays metrics-based insights: top leverage behaviours,\r\n * fragile values, and conflict behaviours.\r\n */\r\n\r\nimport {\r\n  analyzeNetwork,\r\n  NetworkAnalysis,\r\n  LeverageInsight,\r\n  FragilityInsight,\r\n  ConflictInsight,\r\n} from '@/metrics';\r\nimport type { Network } from '@/types';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface InsightsPanelCallbacks {\r\n  onNavigateToNode: (nodeId: string) => void;\r\n}\r\n\r\nexport interface InsightsPanelOptions {\r\n  network: Network;\r\n  callbacks: InsightsPanelCallbacks;\r\n}\r\n\r\n// ============================================================================\r\n// Component\r\n// ============================================================================\r\n\r\nexport class InsightsPanel {\r\n  private container: HTMLElement;\r\n  private network: Network;\r\n  private callbacks: InsightsPanelCallbacks;\r\n  private analysis: NetworkAnalysis | null = null;\r\n  private expandedSections: Set<string> = new Set(['leverage']); // Leverage expanded by default\r\n\r\n  constructor(container: HTMLElement, options: InsightsPanelOptions) {\r\n    this.container = container;\r\n    this.network = options.network;\r\n    this.callbacks = options.callbacks;\r\n\r\n    this.render();\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Public Methods\r\n  // ==========================================================================\r\n\r\n  public setNetwork(network: Network): void {\r\n    this.network = network;\r\n    this.analysis = null;\r\n    this.render();\r\n  }\r\n\r\n  public getAnalysis(): NetworkAnalysis {\r\n    this.analysis ??= analyzeNetwork(this.network);\r\n    return this.analysis;\r\n  }\r\n\r\n  public refresh(): void {\r\n    this.analysis = null;\r\n    this.render();\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Rendering\r\n  // ==========================================================================\r\n\r\n  private render(): void {\r\n    const analysis = this.getAnalysis();\r\n\r\n    this.container.innerHTML = `\r\n      <div class=\"insights-panel\">\r\n        ${this.renderHeader(analysis)}\r\n        ${this.renderSections(analysis)}\r\n      </div>\r\n    `;\r\n\r\n    this.bindEvents();\r\n  }\r\n\r\n  private renderHeader(analysis: NetworkAnalysis): string {\r\n    const hasInsights =\r\n      analysis.topLeverage.length > 0 ||\r\n      analysis.fragileValues.length > 0 ||\r\n      analysis.conflictBehaviours.length > 0;\r\n\r\n    return `\r\n      <div class=\"insights-header\">\r\n        <div class=\"insights-status ${hasInsights ? 'has-insights' : 'no-insights'}\">\r\n          <span class=\"status-icon\">${hasInsights ? '📊' : '📈'}</span>\r\n          <span class=\"status-text\">${hasInsights ? 'Insights available' : 'Add more data for insights'}</span>\r\n        </div>\r\n        <button class=\"btn-icon\" id=\"btn-refresh-insights\" title=\"Refresh insights\">\r\n          🔄\r\n        </button>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderSections(analysis: NetworkAnalysis): string {\r\n    return `\r\n      <div class=\"insights-sections\">\r\n        ${this.renderLeverageSection(analysis.topLeverage)}\r\n        ${this.renderFragilitySection(analysis.fragileValues)}\r\n        ${this.renderConflictSection(analysis.conflictBehaviours)}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderLeverageSection(insights: LeverageInsight[]): string {\r\n    const isExpanded = this.expandedSections.has('leverage');\r\n    const isEmpty = insights.length === 0;\r\n\r\n    return `\r\n      <div class=\"insight-section ${isExpanded ? 'expanded' : ''}\" data-section=\"leverage\">\r\n        <div class=\"section-header\" data-section=\"leverage\">\r\n          <span class=\"expand-icon\">▶</span>\r\n          <span class=\"section-title\">🚀 Top Leverage</span>\r\n          <span class=\"section-count\">${insights.length}</span>\r\n        </div>\r\n        <div class=\"section-content\">\r\n          ${isEmpty ? this.renderEmptyLeverage() : this.renderLeverageList(insights)}\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderEmptyLeverage(): string {\r\n    return `\r\n      <div class=\"insight-empty\">\r\n        <p>No high-leverage behaviours yet.</p>\r\n        <p class=\"hint\">Add behaviours with links to outcomes and values.</p>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderLeverageList(insights: LeverageInsight[]): string {\r\n    let html = '<div class=\"insight-list\">';\r\n    for (const insight of insights) {\r\n      html += this.renderLeverageItem(insight);\r\n    }\r\n    html += '</div>';\r\n    return html;\r\n  }\r\n\r\n  private renderLeverageItem(insight: LeverageInsight): string {\r\n    const { behaviour, metrics, supportedValues, viaOutcomes } = insight;\r\n    const valueLabels = supportedValues.map((v) => v.label).join(', ');\r\n    const outcomeLabels = viaOutcomes.join(', ');\r\n\r\n    return `\r\n      <div class=\"insight-item leverage-item\" data-node-id=\"${behaviour.id}\">\r\n        <div class=\"insight-main\">\r\n          <div class=\"insight-label\">${this.escapeHtml(behaviour.label)}</div>\r\n          <div class=\"insight-score\">\r\n            <span class=\"score-value\">${metrics.leverageScore.toFixed(2)}</span>\r\n            <span class=\"score-label\">leverage</span>\r\n          </div>\r\n        </div>\r\n        <div class=\"insight-explanation\">\r\n          <span class=\"explanation-text\">\r\n            Supports <strong>${valueLabels !== '' ? valueLabels : 'no values'}</strong>\r\n            ${outcomeLabels !== '' ? `via ${outcomeLabels}` : ''}\r\n          </span>\r\n        </div>\r\n        <div class=\"insight-meta\">\r\n          <span class=\"meta-item\">Coverage: ${metrics.coverage}</span>\r\n          <span class=\"meta-item\">Cost: ${behaviour.cost}</span>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderFragilitySection(insights: FragilityInsight[]): string {\r\n    const isExpanded = this.expandedSections.has('fragility');\r\n    const isEmpty = insights.length === 0;\r\n\r\n    return `\r\n      <div class=\"insight-section ${isExpanded ? 'expanded' : ''}\" data-section=\"fragility\">\r\n        <div class=\"section-header\" data-section=\"fragility\">\r\n          <span class=\"expand-icon\">▶</span>\r\n          <span class=\"section-title\">⚠️ Fragile Values</span>\r\n          <span class=\"section-count\">${insights.length}</span>\r\n        </div>\r\n        <div class=\"section-content\">\r\n          ${isEmpty ? this.renderEmptyFragility() : this.renderFragilityList(insights)}\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderEmptyFragility(): string {\r\n    return `\r\n      <div class=\"insight-empty\">\r\n        <p>No fragile values detected.</p>\r\n        <p class=\"hint\">All values have adequate support.</p>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderFragilityList(insights: FragilityInsight[]): string {\r\n    let html = '<div class=\"insight-list\">';\r\n    for (const insight of insights) {\r\n      html += this.renderFragilityItem(insight);\r\n    }\r\n    html += '</div>';\r\n    return html;\r\n  }\r\n\r\n  private renderFragilityItem(insight: FragilityInsight): string {\r\n    const { value, metrics, supportingBehaviours, isOrphan } = insight;\r\n    const fragilityDisplay = isOrphan ? '∞' : metrics.fragilityScore.toFixed(2);\r\n    const behaviourLabels = supportingBehaviours.map((b) => b.label).join(', ');\r\n\r\n    return `\r\n      <div class=\"insight-item fragility-item ${isOrphan ? 'orphan' : ''}\" data-node-id=\"${value.id}\">\r\n        <div class=\"insight-main\">\r\n          <div class=\"insight-label\">${this.escapeHtml(value.label)}</div>\r\n          <div class=\"insight-score\">\r\n            <span class=\"score-value ${isOrphan ? 'critical' : ''}\">${fragilityDisplay}</span>\r\n            <span class=\"score-label\">fragility</span>\r\n          </div>\r\n        </div>\r\n        <div class=\"insight-explanation\">\r\n          ${isOrphan\r\n            ? '<span class=\"explanation-text warning\">No behaviours support this value.</span>'\r\n            : `<span class=\"explanation-text\">Supported by: <strong>${behaviourLabels !== '' ? behaviourLabels : 'none'}</strong></span>`\r\n          }\r\n        </div>\r\n        <div class=\"insight-meta\">\r\n          <span class=\"meta-item\">Importance: ${value.importance}</span>\r\n          <span class=\"meta-item\">Neglect: ${this.formatNeglect(value.neglect)}</span>\r\n        </div>\r\n        ${isOrphan ? '<div class=\"suggestion\">Consider adding behaviours that support this value.</div>' : ''}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderConflictSection(insights: ConflictInsight[]): string {\r\n    const isExpanded = this.expandedSections.has('conflict');\r\n    const isEmpty = insights.length === 0;\r\n\r\n    return `\r\n      <div class=\"insight-section ${isExpanded ? 'expanded' : ''}\" data-section=\"conflict\">\r\n        <div class=\"section-header\" data-section=\"conflict\">\r\n          <span class=\"expand-icon\">▶</span>\r\n          <span class=\"section-title\">⚡ Conflicts</span>\r\n          <span class=\"section-count\">${insights.length}</span>\r\n        </div>\r\n        <div class=\"section-content\">\r\n          ${isEmpty ? this.renderEmptyConflict() : this.renderConflictList(insights)}\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderEmptyConflict(): string {\r\n    return `\r\n      <div class=\"insight-empty\">\r\n        <p>No conflict behaviours detected.</p>\r\n        <p class=\"hint\">Behaviours have consistent positive or negative effects.</p>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderConflictList(insights: ConflictInsight[]): string {\r\n    let html = '<div class=\"insight-list\">';\r\n    for (const insight of insights) {\r\n      html += this.renderConflictItem(insight);\r\n    }\r\n    html += '</div>';\r\n    return html;\r\n  }\r\n\r\n  private renderConflictItem(insight: ConflictInsight): string {\r\n    const { behaviour, metrics, positiveValues, negativeValues } = insight;\r\n    const positiveLabels = positiveValues.map((v) => v.label).join(', ');\r\n    const negativeLabels = negativeValues.map((v) => v.label).join(', ');\r\n\r\n    return `\r\n      <div class=\"insight-item conflict-item\" data-node-id=\"${behaviour.id}\">\r\n        <div class=\"insight-main\">\r\n          <div class=\"insight-label\">${this.escapeHtml(behaviour.label)}</div>\r\n          <div class=\"insight-score\">\r\n            <span class=\"score-value\">${metrics.conflictIndex.toFixed(2)}</span>\r\n            <span class=\"score-label\">conflict</span>\r\n          </div>\r\n        </div>\r\n        <div class=\"insight-explanation\">\r\n          <div class=\"conflict-breakdown\">\r\n            <span class=\"positive-effect\">\r\n              ✓ ${positiveLabels !== '' ? positiveLabels : 'none'} (+${metrics.positiveInfluence.toFixed(1)})\r\n            </span>\r\n            <span class=\"negative-effect\">\r\n              ✗ ${negativeLabels !== '' ? negativeLabels : 'none'} (-${metrics.negativeInfluence.toFixed(1)})\r\n            </span>\r\n          </div>\r\n        </div>\r\n        <div class=\"suggestion\">Consider reducing frequency or mitigating negative effects.</div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Helpers\r\n  // ==========================================================================\r\n\r\n  private formatNeglect(neglect: string): string {\r\n    return neglect.replace(/-/g, ' ');\r\n  }\r\n\r\n  private escapeHtml(text: string): string {\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Event Handling\r\n  // ==========================================================================\r\n\r\n  private bindEvents(): void {\r\n    // Refresh button\r\n    this.container.querySelector('#btn-refresh-insights')?.addEventListener('click', () => {\r\n      this.refresh();\r\n    });\r\n\r\n    // Section headers (expand/collapse)\r\n    this.container.querySelectorAll('.section-header').forEach((header) => {\r\n      header.addEventListener('click', (e) => {\r\n        const section = (e.currentTarget as HTMLElement).dataset.section;\r\n        if (section !== undefined && section !== '') {\r\n          if (this.expandedSections.has(section)) {\r\n            this.expandedSections.delete(section);\r\n          } else {\r\n            this.expandedSections.add(section);\r\n          }\r\n          this.render();\r\n        }\r\n      });\r\n    });\r\n\r\n    // Insight items (navigate to node)\r\n    this.container.querySelectorAll('.insight-item').forEach((item) => {\r\n      item.addEventListener('click', (e) => {\r\n        const nodeId = (e.currentTarget as HTMLElement).dataset.nodeId;\r\n        if (nodeId !== undefined && nodeId !== '') {\r\n          this.callbacks.onNavigateToNode(nodeId);\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n","/**\r\n * Why Ladder Types and Utilities\r\n *\r\n * Types and helpers for the guided \"Why Ladder\" capture mode.\r\n */\r\n\r\nimport type {\r\n  Behaviour,\r\n  BehaviourOutcomeLink,\r\n  Network,\r\n  Outcome,\r\n  OutcomeValueLink,\r\n  Value,\r\n} from '@/types';\r\n\r\n// ============================================================================\r\n// State Machine Types\r\n// ============================================================================\r\n\r\n/**\r\n * Steps in the Why Ladder flow.\r\n */\r\nexport type LadderStep =\r\n  | 'select-behaviour' // Step 1: Select or create a behaviour\r\n  | 'add-outcomes' // Step 2: Add outcomes for current behaviour\r\n  | 'explain-outcome' // Step 3: Explain why an outcome matters (link to value or chain to outcome)\r\n  | 'complete'; // Done with current ladder\r\n\r\n/**\r\n * Represents an unexplained node that needs to be connected.\r\n */\r\nexport interface UnexplainedNode {\r\n  id: string;\r\n  type: 'behaviour' | 'outcome';\r\n  label: string;\r\n}\r\n\r\n/**\r\n * A pending outcome that needs to be explained (linked to a value).\r\n */\r\nexport interface PendingOutcome {\r\n  outcomeId: string;\r\n  outcomeLabel: string;\r\n  explained: boolean;\r\n}\r\n\r\n/**\r\n * Session state for a Why Ladder session.\r\n */\r\nexport interface LadderSession {\r\n  /** Unique session ID */\r\n  id: string;\r\n  /** Current step in the ladder */\r\n  currentStep: LadderStep;\r\n  /** The behaviour being explored */\r\n  behaviourId: string | null;\r\n  behaviourLabel: string;\r\n  /** Outcomes created/linked in this session */\r\n  outcomes: PendingOutcome[];\r\n  /** Index of the outcome currently being explained */\r\n  currentOutcomeIndex: number;\r\n  /** Values created/linked in this session */\r\n  valueIds: string[];\r\n  /** Whether the session was completed normally */\r\n  completed: boolean;\r\n  /** Timestamp when session started */\r\n  startedAt: string;\r\n}\r\n\r\n/**\r\n * Creates an empty ladder session.\r\n */\r\nexport function createLadderSession(): LadderSession {\r\n  return {\r\n    id: `ladder-${Date.now()}`,\r\n    currentStep: 'select-behaviour',\r\n    behaviourId: null,\r\n    behaviourLabel: '',\r\n    outcomes: [],\r\n    currentOutcomeIndex: 0,\r\n    valueIds: [],\r\n    completed: false,\r\n    startedAt: new Date().toISOString(),\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Callbacks\r\n// ============================================================================\r\n\r\n/**\r\n * Callbacks for Why Ladder component.\r\n */\r\nexport interface WhyLadderCallbacks {\r\n  /** Called when a new behaviour is created */\r\n  onCreateBehaviour: (label: string) => Behaviour;\r\n  /** Called when an existing behaviour is selected */\r\n  onSelectBehaviour: (id: string) => void;\r\n  /** Called when a new outcome is created and linked to the current behaviour */\r\n  onCreateOutcome: (label: string, behaviourId: string) => Outcome;\r\n  /** Called when an existing outcome is linked to the current behaviour */\r\n  onLinkOutcome: (outcomeId: string, behaviourId: string) => void;\r\n  /** Called when a new value is created and linked to an outcome */\r\n  onCreateValue: (label: string, outcomeId: string) => Value;\r\n  /** Called when an existing value is linked to an outcome */\r\n  onLinkValue: (valueId: string, outcomeId: string) => void;\r\n  /** Called when the ladder is completed */\r\n  onComplete: (session: LadderSession) => void;\r\n  /** Called when the ladder is cancelled/exited early */\r\n  onExit: (session: LadderSession) => void;\r\n  /** Called when a new outcome is chained (intermediate) */\r\n  onChainOutcome: (label: string, parentOutcomeId: string) => Outcome;\r\n}\r\n\r\n/**\r\n * Options for the Why Ladder component.\r\n */\r\nexport interface WhyLadderOptions {\r\n  network: Network;\r\n  callbacks: WhyLadderCallbacks;\r\n  /** Optional pre-selected behaviour ID to start with */\r\n  initialBehaviourId?: string;\r\n}\r\n\r\n// ============================================================================\r\n// Helper Functions\r\n// ============================================================================\r\n\r\n/**\r\n * Get all behaviour-outcome links from the network.\r\n */\r\nfunction getBehaviourOutcomeLinks(network: Network): BehaviourOutcomeLink[] {\r\n  return network.links.filter(\r\n    (link): link is BehaviourOutcomeLink => link.type === 'behaviour-outcome'\r\n  );\r\n}\r\n\r\n/**\r\n * Get all outcome-value links from the network.\r\n */\r\nfunction getOutcomeValueLinks(network: Network): OutcomeValueLink[] {\r\n  return network.links.filter(\r\n    (link): link is OutcomeValueLink => link.type === 'outcome-value'\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// Utility Functions\r\n// ============================================================================\r\n\r\n/**\r\n * Get all unexplained behaviours (no outgoing links).\r\n */\r\nexport function getUnexplainedBehaviours(network: Network): UnexplainedNode[] {\r\n  const unexplained: UnexplainedNode[] = [];\r\n  const boLinks = getBehaviourOutcomeLinks(network);\r\n\r\n  for (const behaviour of network.behaviours) {\r\n    const hasOutgoingLink = boLinks.some((link) => link.sourceId === behaviour.id);\r\n    if (!hasOutgoingLink) {\r\n      unexplained.push({\r\n        id: behaviour.id,\r\n        type: 'behaviour',\r\n        label: behaviour.label,\r\n      });\r\n    }\r\n  }\r\n\r\n  return unexplained;\r\n}\r\n\r\n/**\r\n * Get all floating outcomes (no downstream links to values).\r\n */\r\nexport function getFloatingOutcomes(network: Network): UnexplainedNode[] {\r\n  const floating: UnexplainedNode[] = [];\r\n  const ovLinks = getOutcomeValueLinks(network);\r\n\r\n  for (const outcome of network.outcomes) {\r\n    const hasDownstreamLink = ovLinks.some((link) => link.sourceId === outcome.id);\r\n    if (!hasDownstreamLink) {\r\n      floating.push({\r\n        id: outcome.id,\r\n        type: 'outcome',\r\n        label: outcome.label,\r\n      });\r\n    }\r\n  }\r\n\r\n  return floating;\r\n}\r\n\r\n/**\r\n * Check if a behaviour has any outgoing links.\r\n */\r\nexport function behaviourHasOutgoingLinks(network: Network, behaviourId: string): boolean {\r\n  const boLinks = getBehaviourOutcomeLinks(network);\r\n  return boLinks.some((link) => link.sourceId === behaviourId);\r\n}\r\n\r\n/**\r\n * Check if an outcome has any downstream links to values.\r\n */\r\nexport function outcomeHasDownstreamLinks(network: Network, outcomeId: string): boolean {\r\n  const ovLinks = getOutcomeValueLinks(network);\r\n  return ovLinks.some((link) => link.sourceId === outcomeId);\r\n}\r\n\r\n/**\r\n * Get the next unexplained outcome in a session.\r\n */\r\nexport function getNextUnexplainedOutcome(session: LadderSession): PendingOutcome | null {\r\n  for (let i = session.currentOutcomeIndex; i < session.outcomes.length; i++) {\r\n    const outcome = session.outcomes[i];\r\n    if (outcome && !outcome.explained) {\r\n      return outcome;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\n/**\r\n * Count unexplained outcomes in a session.\r\n */\r\nexport function countUnexplainedOutcomes(session: LadderSession): number {\r\n  return session.outcomes.filter((o) => !o.explained).length;\r\n}\r\n\r\n/**\r\n * Get behaviours that can be selected for the ladder (optionally filter unexplained).\r\n */\r\nexport function getSelectableBehaviours(\r\n  network: Network,\r\n  onlyUnexplained: boolean = false\r\n): Array<{ id: string; label: string; hasLinks: boolean }> {\r\n  return network.behaviours\r\n    .map((b) => ({\r\n      id: b.id,\r\n      label: b.label,\r\n      hasLinks: behaviourHasOutgoingLinks(network, b.id),\r\n    }))\r\n    .filter((b) => !onlyUnexplained || !b.hasLinks);\r\n}\r\n\r\n/**\r\n * Get outcomes that can be linked to a behaviour.\r\n */\r\nexport function getLinkableOutcomes(\r\n  network: Network,\r\n  behaviourId: string\r\n): Array<{ id: string; label: string; alreadyLinked: boolean }> {\r\n  const boLinks = getBehaviourOutcomeLinks(network);\r\n  const linkedOutcomeIds = new Set(\r\n    boLinks.filter((link) => link.sourceId === behaviourId).map((link) => link.targetId)\r\n  );\r\n\r\n  return network.outcomes.map((o) => ({\r\n    id: o.id,\r\n    label: o.label,\r\n    alreadyLinked: linkedOutcomeIds.has(o.id),\r\n  }));\r\n}\r\n\r\n/**\r\n * Get values that can be linked to an outcome.\r\n */\r\nexport function getLinkableValues(\r\n  network: Network,\r\n  outcomeId: string\r\n): Array<{ id: string; label: string; alreadyLinked: boolean }> {\r\n  const ovLinks = getOutcomeValueLinks(network);\r\n  const linkedValueIds = new Set(\r\n    ovLinks.filter((link) => link.sourceId === outcomeId).map((link) => link.targetId)\r\n  );\r\n\r\n  return network.values.map((v) => ({\r\n    id: v.id,\r\n    label: v.label,\r\n    alreadyLinked: linkedValueIds.has(v.id),\r\n  }));\r\n}\r\n","/**\r\n * Why Ladder Component\r\n *\r\n * A guided capture mode that walks users through the \"Why Ladder\" flow:\r\n * Behaviour → Outcomes → Values\r\n */\r\n\r\nimport type { Network } from '@/types';\r\n\r\nimport {\r\n  countUnexplainedOutcomes,\r\n  createLadderSession,\r\n  getLinkableOutcomes,\r\n  getLinkableValues,\r\n  getNextUnexplainedOutcome,\r\n  getSelectableBehaviours,\r\n  LadderSession,\r\n  LadderStep,\r\n  PendingOutcome,\r\n  WhyLadderCallbacks,\r\n  WhyLadderOptions,\r\n} from './types';\r\n\r\n/**\r\n * WhyLadder manages the guided \"Why Ladder\" capture flow.\r\n */\r\nexport class WhyLadder {\r\n  private container: HTMLElement;\r\n  private network: Network;\r\n  private callbacks: WhyLadderCallbacks;\r\n  private session: LadderSession;\r\n\r\n  constructor(container: HTMLElement, options: WhyLadderOptions) {\r\n    this.container = container;\r\n    this.network = options.network;\r\n    this.callbacks = options.callbacks;\r\n    this.session = createLadderSession();\r\n\r\n    // If initial behaviour provided, skip to outcomes step\r\n    if (options.initialBehaviourId !== undefined && options.initialBehaviourId !== '') {\r\n      const behaviour = this.network.behaviours.find((b) => b.id === options.initialBehaviourId);\r\n      if (behaviour) {\r\n        this.session.behaviourId = behaviour.id;\r\n        this.session.behaviourLabel = behaviour.label;\r\n        this.session.currentStep = 'add-outcomes';\r\n      }\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  /**\r\n   * Update the network reference (called when network changes).\r\n   */\r\n  public setNetwork(network: Network): void {\r\n    this.network = network;\r\n    this.render();\r\n  }\r\n\r\n  /**\r\n   * Get the current session state.\r\n   */\r\n  public getSession(): LadderSession {\r\n    return { ...this.session };\r\n  }\r\n\r\n  /**\r\n   * Reset and start a new session.\r\n   */\r\n  public reset(): void {\r\n    this.session = createLadderSession();\r\n    this.render();\r\n  }\r\n\r\n  // ============================================================================\r\n  // Rendering\r\n  // ============================================================================\r\n\r\n  private render(): void {\r\n    switch (this.session.currentStep) {\r\n      case 'select-behaviour':\r\n        this.renderSelectBehaviour();\r\n        break;\r\n      case 'add-outcomes':\r\n        this.renderAddOutcomes();\r\n        break;\r\n      case 'explain-outcome':\r\n        this.renderExplainOutcome();\r\n        break;\r\n      case 'complete':\r\n        this.renderComplete();\r\n        break;\r\n    }\r\n  }\r\n\r\n  private renderSelectBehaviour(): void {\r\n    const behaviours = getSelectableBehaviours(this.network, false);\r\n\r\n    this.container.innerHTML = `\r\n      <div class=\"ladder-panel\">\r\n        <div class=\"ladder-header\">\r\n          <h2>Why Ladder</h2>\r\n          <p class=\"ladder-subtitle\">Map your behaviours to what matters</p>\r\n        </div>\r\n\r\n        <div class=\"ladder-step\">\r\n          <div class=\"step-indicator\">\r\n            <span class=\"step-number\">1</span>\r\n            <span class=\"step-label\">Choose a Behaviour</span>\r\n          </div>\r\n\r\n          <p class=\"ladder-prompt\">\r\n            What behaviour would you like to explore? Why do you do it?\r\n          </p>\r\n\r\n          <div class=\"ladder-form\">\r\n            <div class=\"form-group\">\r\n              <label for=\"behaviour-input\">Create new behaviour</label>\r\n              <div class=\"input-row\">\r\n                <input \r\n                  type=\"text\" \r\n                  id=\"behaviour-input\" \r\n                  class=\"form-input\" \r\n                  placeholder=\"e.g., Morning meditation, 30-min walk...\"\r\n                  autocomplete=\"off\"\r\n                />\r\n                <button type=\"button\" class=\"btn btn-primary\" id=\"btn-create-behaviour\">\r\n                  Create\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n            ${behaviours.length > 0 ? `\r\n              <div class=\"divider-text\">\r\n                <span>or select existing</span>\r\n              </div>\r\n\r\n              <div class=\"form-group\">\r\n                <label>Select existing behaviour</label>\r\n                <ul class=\"selectable-list\" id=\"behaviour-list\">\r\n                  ${behaviours.map((b) => `\r\n                    <li class=\"selectable-item ${b.hasLinks ? 'has-links' : 'no-links'}\" data-id=\"${b.id}\">\r\n                      <span class=\"item-label\">${this.escapeHtml(b.label)}</span>\r\n                      ${b.hasLinks ? '<span class=\"item-badge\">has links</span>' : '<span class=\"item-badge unexplained\">unexplained</span>'}\r\n                    </li>\r\n                  `).join('')}\r\n                </ul>\r\n              </div>\r\n            ` : ''}\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"ladder-actions\">\r\n          <button type=\"button\" class=\"btn btn-secondary\" id=\"btn-cancel\">\r\n            Cancel\r\n          </button>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    this.bindSelectBehaviourEvents();\r\n  }\r\n\r\n  private renderAddOutcomes(): void {\r\n    const linkableOutcomes = getLinkableOutcomes(this.network, this.session.behaviourId!);\r\n    const availableOutcomes = linkableOutcomes.filter((o) => !o.alreadyLinked);\r\n    const addedCount = this.session.outcomes.length;\r\n\r\n    this.container.innerHTML = `\r\n      <div class=\"ladder-panel\">\r\n        <div class=\"ladder-header\">\r\n          <h2>Why Ladder</h2>\r\n          <p class=\"ladder-subtitle\">Exploring: <strong>${this.escapeHtml(this.session.behaviourLabel)}</strong></p>\r\n        </div>\r\n\r\n        <div class=\"ladder-step\">\r\n          <div class=\"step-indicator\">\r\n            <span class=\"step-number\">2</span>\r\n            <span class=\"step-label\">Add Outcomes</span>\r\n          </div>\r\n\r\n          <p class=\"ladder-prompt\">\r\n            What outcome(s) does <strong>\"${this.escapeHtml(this.session.behaviourLabel)}\"</strong> produce?\r\n          </p>\r\n\r\n          ${addedCount > 0 ? `\r\n            <div class=\"added-items\">\r\n              <h4>Added outcomes (${addedCount}):</h4>\r\n              <ul class=\"outcome-chips\">\r\n                ${this.session.outcomes.map((o) => `\r\n                  <li class=\"outcome-chip\">\r\n                    <span>${this.escapeHtml(o.outcomeLabel)}</span>\r\n                    <button type=\"button\" class=\"chip-remove\" data-outcome-id=\"${o.outcomeId}\" title=\"Remove\">×</button>\r\n                  </li>\r\n                `).join('')}\r\n              </ul>\r\n            </div>\r\n          ` : ''}\r\n\r\n          <div class=\"ladder-form\">\r\n            <div class=\"form-group\">\r\n              <label for=\"outcome-input\">Create new outcome</label>\r\n              <div class=\"input-row\">\r\n                <input \r\n                  type=\"text\" \r\n                  id=\"outcome-input\" \r\n                  class=\"form-input\" \r\n                  placeholder=\"e.g., Reduced anxiety, Better sleep...\"\r\n                  autocomplete=\"off\"\r\n                />\r\n                <button type=\"button\" class=\"btn btn-primary\" id=\"btn-add-outcome\">\r\n                  Add\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n            ${availableOutcomes.length > 0 ? `\r\n              <div class=\"divider-text\">\r\n                <span>or link existing</span>\r\n              </div>\r\n\r\n              <div class=\"form-group\">\r\n                <label>Link to existing outcome</label>\r\n                <ul class=\"selectable-list\" id=\"outcome-list\">\r\n                  ${availableOutcomes.map((o) => `\r\n                    <li class=\"selectable-item\" data-id=\"${o.id}\">\r\n                      <span class=\"item-label\">${this.escapeHtml(o.label)}</span>\r\n                    </li>\r\n                  `).join('')}\r\n                </ul>\r\n              </div>\r\n            ` : ''}\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"ladder-actions\">\r\n          <button type=\"button\" class=\"btn btn-secondary\" id=\"btn-back\">\r\n            Back\r\n          </button>\r\n          <button type=\"button\" class=\"btn btn-secondary\" id=\"btn-exit\">\r\n            Exit Early\r\n          </button>\r\n          ${addedCount > 0 ? `\r\n            <button type=\"button\" class=\"btn btn-primary\" id=\"btn-next\">\r\n              Continue →\r\n            </button>\r\n          ` : ''}\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    this.bindAddOutcomesEvents();\r\n  }\r\n\r\n  private renderExplainOutcome(): void {\r\n    const pendingOutcome = getNextUnexplainedOutcome(this.session);\r\n    if (!pendingOutcome) {\r\n      this.goToStep('complete');\r\n      return;\r\n    }\r\n\r\n    const outcomeId = pendingOutcome.outcomeId;\r\n    const linkableValues = getLinkableValues(this.network, outcomeId);\r\n    const availableValues = linkableValues.filter((v) => !v.alreadyLinked);\r\n    const remainingCount = countUnexplainedOutcomes(this.session);\r\n\r\n    this.container.innerHTML = `\r\n      <div class=\"ladder-panel\">\r\n        <div class=\"ladder-header\">\r\n          <h2>Why Ladder</h2>\r\n          <p class=\"ladder-subtitle\">Exploring: <strong>${this.escapeHtml(this.session.behaviourLabel)}</strong></p>\r\n        </div>\r\n\r\n        <div class=\"ladder-step\">\r\n          <div class=\"step-indicator\">\r\n            <span class=\"step-number\">3</span>\r\n            <span class=\"step-label\">Explain Outcomes</span>\r\n          </div>\r\n\r\n          <p class=\"ladder-prompt\">\r\n            Why does <strong>\"${this.escapeHtml(pendingOutcome.outcomeLabel)}\"</strong> matter to you?\r\n          </p>\r\n\r\n          <p class=\"ladder-hint\">\r\n            Link to a value (terminal goal) or chain to another outcome (intermediate step).\r\n            <br/>\r\n            <small>${remainingCount} outcome${remainingCount !== 1 ? 's' : ''} left to explain</small>\r\n          </p>\r\n\r\n          <div class=\"ladder-form\">\r\n            <div class=\"form-group\">\r\n              <label for=\"value-input\">Add as new value</label>\r\n              <div class=\"input-row\">\r\n                <input \r\n                  type=\"text\" \r\n                  id=\"value-input\" \r\n                  class=\"form-input\" \r\n                  placeholder=\"e.g., Health, Peace of mind, Achievement...\"\r\n                  autocomplete=\"off\"\r\n                />\r\n                <button type=\"button\" class=\"btn btn-primary\" id=\"btn-add-value\">\r\n                  Add Value\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n            ${availableValues.length > 0 ? `\r\n              <div class=\"divider-text\">\r\n                <span>or link to existing value</span>\r\n              </div>\r\n\r\n              <div class=\"form-group\">\r\n                <ul class=\"selectable-list\" id=\"value-list\">\r\n                  ${availableValues.map((v) => `\r\n                    <li class=\"selectable-item\" data-id=\"${v.id}\">\r\n                      <span class=\"item-label\">${this.escapeHtml(v.label)}</span>\r\n                    </li>\r\n                  `).join('')}\r\n                </ul>\r\n              </div>\r\n            ` : ''}\r\n\r\n            <div class=\"divider-text\">\r\n              <span>or chain to another outcome</span>\r\n            </div>\r\n\r\n            <div class=\"form-group\">\r\n              <label for=\"chain-input\">Create intermediate outcome</label>\r\n              <div class=\"input-row\">\r\n                <input \r\n                  type=\"text\" \r\n                  id=\"chain-input\" \r\n                  class=\"form-input\" \r\n                  placeholder=\"e.g., Another effect that leads to a value...\"\r\n                  autocomplete=\"off\"\r\n                />\r\n                <button type=\"button\" class=\"btn btn-secondary\" id=\"btn-chain-outcome\">\r\n                  Chain Outcome\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"ladder-actions\">\r\n          <button type=\"button\" class=\"btn btn-secondary\" id=\"btn-back\">\r\n            Back\r\n          </button>\r\n          <button type=\"button\" class=\"btn btn-secondary\" id=\"btn-skip\">\r\n            Skip This Outcome\r\n          </button>\r\n          <button type=\"button\" class=\"btn btn-secondary\" id=\"btn-exit\">\r\n            Exit Early\r\n          </button>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    this.bindExplainOutcomeEvents(pendingOutcome);\r\n  }\r\n\r\n  private renderComplete(): void {\r\n    const outcomeCount = this.session.outcomes.length;\r\n    const valueCount = this.session.valueIds.length;\r\n    const unexplainedCount = countUnexplainedOutcomes(this.session);\r\n\r\n    this.container.innerHTML = `\r\n      <div class=\"ladder-panel\">\r\n        <div class=\"ladder-header\">\r\n          <h2>Why Ladder Complete!</h2>\r\n        </div>\r\n\r\n        <div class=\"ladder-summary\">\r\n          <div class=\"summary-item\">\r\n            <span class=\"summary-icon\">✓</span>\r\n            <span class=\"summary-text\">\r\n              Explored <strong>${this.escapeHtml(this.session.behaviourLabel)}</strong>\r\n            </span>\r\n          </div>\r\n\r\n          <div class=\"summary-item\">\r\n            <span class=\"summary-icon\">${outcomeCount > 0 ? '✓' : '○'}</span>\r\n            <span class=\"summary-text\">\r\n              ${outcomeCount} outcome${outcomeCount !== 1 ? 's' : ''} added\r\n            </span>\r\n          </div>\r\n\r\n          <div class=\"summary-item\">\r\n            <span class=\"summary-icon\">${valueCount > 0 ? '✓' : '○'}</span>\r\n            <span class=\"summary-text\">\r\n              ${valueCount} value${valueCount !== 1 ? 's' : ''} linked\r\n            </span>\r\n          </div>\r\n\r\n          ${unexplainedCount > 0 ? `\r\n            <div class=\"summary-item warning\">\r\n              <span class=\"summary-icon\">⚠</span>\r\n              <span class=\"summary-text\">\r\n                ${unexplainedCount} outcome${unexplainedCount !== 1 ? 's' : ''} left unexplained\r\n              </span>\r\n            </div>\r\n          ` : ''}\r\n        </div>\r\n\r\n        <div class=\"ladder-actions\">\r\n          <button type=\"button\" class=\"btn btn-secondary\" id=\"btn-another\">\r\n            Add Another Behaviour\r\n          </button>\r\n          <button type=\"button\" class=\"btn btn-primary\" id=\"btn-done\">\r\n            Done\r\n          </button>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    this.bindCompleteEvents();\r\n  }\r\n\r\n  // ============================================================================\r\n  // Event Binding\r\n  // ============================================================================\r\n\r\n  private bindSelectBehaviourEvents(): void {\r\n    const input = this.container.querySelector('#behaviour-input') as HTMLInputElement;\r\n    const createBtn = this.container.querySelector('#btn-create-behaviour') as HTMLButtonElement;\r\n    const cancelBtn = this.container.querySelector('#btn-cancel') as HTMLButtonElement;\r\n    const list = this.container.querySelector('#behaviour-list');\r\n\r\n    // Create new behaviour\r\n    createBtn.addEventListener('click', () => {\r\n      const label = input.value.trim();\r\n      if (label !== '') {\r\n        this.createBehaviour(label);\r\n      }\r\n    });\r\n\r\n    input.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Enter') {\r\n        const label = input.value.trim();\r\n        if (label !== '') {\r\n          this.createBehaviour(label);\r\n        }\r\n      }\r\n    });\r\n\r\n    // Select existing behaviour\r\n    if (list) {\r\n      list.querySelectorAll('.selectable-item').forEach((item) => {\r\n        item.addEventListener('click', () => {\r\n          const id = (item as HTMLElement).dataset.id;\r\n          if (id !== undefined) {\r\n            this.selectBehaviour(id);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    // Cancel\r\n    cancelBtn.addEventListener('click', () => {\r\n      this.callbacks.onExit(this.session);\r\n    });\r\n  }\r\n\r\n  private bindAddOutcomesEvents(): void {\r\n    const input = this.container.querySelector('#outcome-input') as HTMLInputElement;\r\n    const addBtn = this.container.querySelector('#btn-add-outcome') as HTMLButtonElement;\r\n    const backBtn = this.container.querySelector('#btn-back') as HTMLButtonElement;\r\n    const exitBtn = this.container.querySelector('#btn-exit') as HTMLButtonElement;\r\n    const nextBtn = this.container.querySelector('#btn-next');\r\n    const list = this.container.querySelector('#outcome-list');\r\n\r\n    // Create new outcome\r\n    addBtn.addEventListener('click', () => {\r\n      const label = input.value.trim();\r\n      if (label !== '') {\r\n        this.createOutcome(label);\r\n        input.value = '';\r\n        input.focus();\r\n      }\r\n    });\r\n\r\n    input.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Enter') {\r\n        const label = input.value.trim();\r\n        if (label !== '') {\r\n          this.createOutcome(label);\r\n          input.value = '';\r\n        }\r\n      }\r\n    });\r\n\r\n    // Link existing outcome\r\n    if (list) {\r\n      list.querySelectorAll('.selectable-item').forEach((item) => {\r\n        item.addEventListener('click', () => {\r\n          const id = (item as HTMLElement).dataset.id;\r\n          if (id !== undefined) {\r\n            this.linkOutcome(id);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    // Remove outcome chip\r\n    this.container.querySelectorAll('.chip-remove').forEach((btn) => {\r\n      btn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        const outcomeId = (btn as HTMLElement).dataset.outcomeId;\r\n        if (outcomeId !== undefined) {\r\n          this.removeOutcome(outcomeId);\r\n        }\r\n      });\r\n    });\r\n\r\n    // Navigation\r\n    backBtn.addEventListener('click', () => {\r\n      this.goToStep('select-behaviour');\r\n    });\r\n\r\n    exitBtn.addEventListener('click', () => {\r\n      this.exitEarly();\r\n    });\r\n\r\n    if (nextBtn) {\r\n      nextBtn.addEventListener('click', () => {\r\n        this.goToStep('explain-outcome');\r\n      });\r\n    }\r\n  }\r\n\r\n  private bindExplainOutcomeEvents(pendingOutcome: PendingOutcome): void {\r\n    const valueInput = this.container.querySelector('#value-input') as HTMLInputElement;\r\n    const addValueBtn = this.container.querySelector('#btn-add-value') as HTMLButtonElement;\r\n    const chainInput = this.container.querySelector('#chain-input') as HTMLInputElement;\r\n    const chainBtn = this.container.querySelector('#btn-chain-outcome') as HTMLButtonElement;\r\n    const backBtn = this.container.querySelector('#btn-back') as HTMLButtonElement;\r\n    const skipBtn = this.container.querySelector('#btn-skip') as HTMLButtonElement;\r\n    const exitBtn = this.container.querySelector('#btn-exit') as HTMLButtonElement;\r\n    const valueList = this.container.querySelector('#value-list');\r\n\r\n    // Create new value\r\n    addValueBtn.addEventListener('click', () => {\r\n      const label = valueInput.value.trim();\r\n      if (label !== '') {\r\n        this.createValue(label, pendingOutcome);\r\n      }\r\n    });\r\n\r\n    valueInput.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Enter') {\r\n        const label = valueInput.value.trim();\r\n        if (label !== '') {\r\n          this.createValue(label, pendingOutcome);\r\n        }\r\n      }\r\n    });\r\n\r\n    // Link existing value\r\n    if (valueList) {\r\n      valueList.querySelectorAll('.selectable-item').forEach((item) => {\r\n        item.addEventListener('click', () => {\r\n          const id = (item as HTMLElement).dataset.id;\r\n          if (id !== undefined) {\r\n            this.linkValue(id, pendingOutcome);\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    // Chain to another outcome\r\n    chainBtn.addEventListener('click', () => {\r\n      const label = chainInput.value.trim();\r\n      if (label !== '') {\r\n        this.chainOutcome(label, pendingOutcome);\r\n      }\r\n    });\r\n\r\n    chainInput.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Enter') {\r\n        const label = chainInput.value.trim();\r\n        if (label !== '') {\r\n          this.chainOutcome(label, pendingOutcome);\r\n        }\r\n      }\r\n    });\r\n\r\n    // Navigation\r\n    backBtn.addEventListener('click', () => {\r\n      this.goToStep('add-outcomes');\r\n    });\r\n\r\n    skipBtn.addEventListener('click', () => {\r\n      this.skipOutcome(pendingOutcome);\r\n    });\r\n\r\n    exitBtn.addEventListener('click', () => {\r\n      this.exitEarly();\r\n    });\r\n  }\r\n\r\n  private bindCompleteEvents(): void {\r\n    const anotherBtn = this.container.querySelector('#btn-another') as HTMLButtonElement;\r\n    const doneBtn = this.container.querySelector('#btn-done') as HTMLButtonElement;\r\n\r\n    anotherBtn.addEventListener('click', () => {\r\n      this.session.completed = true;\r\n      this.callbacks.onComplete(this.session);\r\n      this.reset();\r\n    });\r\n\r\n    doneBtn.addEventListener('click', () => {\r\n      this.session.completed = true;\r\n      this.callbacks.onComplete(this.session);\r\n    });\r\n  }\r\n\r\n  // ============================================================================\r\n  // Actions\r\n  // ============================================================================\r\n\r\n  private goToStep(step: LadderStep): void {\r\n    this.session.currentStep = step;\r\n    this.render();\r\n  }\r\n\r\n  private createBehaviour(label: string): void {\r\n    const behaviour = this.callbacks.onCreateBehaviour(label);\r\n    this.session.behaviourId = behaviour.id;\r\n    this.session.behaviourLabel = behaviour.label;\r\n    this.goToStep('add-outcomes');\r\n  }\r\n\r\n  private selectBehaviour(id: string): void {\r\n    const behaviour = this.network.behaviours.find((b) => b.id === id);\r\n    if (behaviour) {\r\n      this.callbacks.onSelectBehaviour(id);\r\n      this.session.behaviourId = id;\r\n      this.session.behaviourLabel = behaviour.label;\r\n      this.goToStep('add-outcomes');\r\n    }\r\n  }\r\n\r\n  private createOutcome(label: string): void {\r\n    if (this.session.behaviourId === null) return;\r\n\r\n    const outcome = this.callbacks.onCreateOutcome(label, this.session.behaviourId);\r\n    this.session.outcomes.push({\r\n      outcomeId: outcome.id,\r\n      outcomeLabel: outcome.label,\r\n      explained: false,\r\n    });\r\n    this.render();\r\n  }\r\n\r\n  private linkOutcome(outcomeId: string): void {\r\n    if (this.session.behaviourId === null) return;\r\n\r\n    const outcome = this.network.outcomes.find((o) => o.id === outcomeId);\r\n    if (outcome) {\r\n      this.callbacks.onLinkOutcome(outcomeId, this.session.behaviourId);\r\n      this.session.outcomes.push({\r\n        outcomeId: outcome.id,\r\n        outcomeLabel: outcome.label,\r\n        explained: false,\r\n      });\r\n      this.render();\r\n    }\r\n  }\r\n\r\n  private removeOutcome(outcomeId: string): void {\r\n    this.session.outcomes = this.session.outcomes.filter((o) => o.outcomeId !== outcomeId);\r\n    this.render();\r\n  }\r\n\r\n  private createValue(label: string, pendingOutcome: PendingOutcome): void {\r\n    const value = this.callbacks.onCreateValue(label, pendingOutcome.outcomeId);\r\n    this.session.valueIds.push(value.id);\r\n    this.markOutcomeExplained(pendingOutcome);\r\n  }\r\n\r\n  private linkValue(valueId: string, pendingOutcome: PendingOutcome): void {\r\n    this.callbacks.onLinkValue(valueId, pendingOutcome.outcomeId);\r\n    if (!this.session.valueIds.includes(valueId)) {\r\n      this.session.valueIds.push(valueId);\r\n    }\r\n    this.markOutcomeExplained(pendingOutcome);\r\n  }\r\n\r\n  private chainOutcome(label: string, pendingOutcome: PendingOutcome): void {\r\n    // Create a new intermediate outcome linked to the current outcome\r\n    // This creates an outcome-to-outcome chain (conceptually, though we model as behaviour->outcome->value)\r\n    // For MVP, we'll treat this as creating a new outcome and marking current as explained\r\n    const newOutcome = this.callbacks.onChainOutcome(label, pendingOutcome.outcomeId);\r\n    \r\n    // Add the new outcome to pending list (it also needs to be explained)\r\n    this.session.outcomes.push({\r\n      outcomeId: newOutcome.id,\r\n      outcomeLabel: newOutcome.label,\r\n      explained: false,\r\n    });\r\n    \r\n    // Mark the original outcome as explained (it chains to the new one)\r\n    this.markOutcomeExplained(pendingOutcome);\r\n  }\r\n\r\n  private markOutcomeExplained(pendingOutcome: PendingOutcome): void {\r\n    const index = this.session.outcomes.findIndex((o) => o.outcomeId === pendingOutcome.outcomeId);\r\n    if (index !== -1) {\r\n      const outcome = this.session.outcomes[index];\r\n      if (outcome) {\r\n        outcome.explained = true;\r\n      }\r\n    }\r\n\r\n    // Move to next unexplained or complete\r\n    const next = getNextUnexplainedOutcome(this.session);\r\n    if (next) {\r\n      this.session.currentOutcomeIndex = this.session.outcomes.findIndex(\r\n        (o) => o.outcomeId === next.outcomeId\r\n      );\r\n      this.render();\r\n    } else {\r\n      this.goToStep('complete');\r\n    }\r\n  }\r\n\r\n  private skipOutcome(pendingOutcome: PendingOutcome): void {\r\n    // Leave outcome unexplained but move on\r\n    const currentIndex = this.session.outcomes.findIndex(\r\n      (o) => o.outcomeId === pendingOutcome.outcomeId\r\n    );\r\n    this.session.currentOutcomeIndex = currentIndex + 1;\r\n\r\n    const next = getNextUnexplainedOutcome(this.session);\r\n    if (next) {\r\n      this.render();\r\n    } else {\r\n      this.goToStep('complete');\r\n    }\r\n  }\r\n\r\n  private exitEarly(): void {\r\n    this.session.completed = false;\r\n    this.callbacks.onExit(this.session);\r\n  }\r\n\r\n  // ============================================================================\r\n  // Utilities\r\n  // ============================================================================\r\n\r\n  private escapeHtml(text: string): string {\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n}\r\n","/**\r\n * Validation Types\r\n *\r\n * Types for the validation engine and warning management.\r\n */\r\n\r\nimport type { WarningType, ValidationWarning } from '@/types';\r\n\r\n// ============================================================================\r\n// Warning Severity\r\n// ============================================================================\r\n\r\nexport type WarningSeverity = 'error' | 'warning' | 'info';\r\n\r\n/**\r\n * Extended warning with severity and related nodes.\r\n */\r\nexport interface Warning extends ValidationWarning {\r\n  severity: WarningSeverity;\r\n  relatedNodeIds: string[];\r\n  suggestion?: string;\r\n}\r\n\r\n// ============================================================================\r\n// Validation Result\r\n// ============================================================================\r\n\r\nexport interface ValidationResult {\r\n  /** All detected warnings */\r\n  warnings: Warning[];\r\n  /** Warnings by type */\r\n  byType: Record<WarningType, Warning[]>;\r\n  /** Warnings by node ID */\r\n  byNodeId: Record<string, Warning[]>;\r\n  /** Summary counts */\r\n  counts: {\r\n    total: number;\r\n    byType: Record<WarningType, number>;\r\n    bySeverity: Record<WarningSeverity, number>;\r\n    active: number; // Not snoozed or dismissed\r\n    snoozed: number;\r\n    dismissed: number;\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Snooze/Dismiss State\r\n// ============================================================================\r\n\r\nexport interface WarningState {\r\n  /** Warning ID -> snooze expiration (ISO 8601) */\r\n  snoozed: Record<string, string>;\r\n  /** Warning ID -> dismissed flag */\r\n  dismissed: Record<string, boolean>;\r\n}\r\n\r\nexport const DEFAULT_SNOOZE_DURATION_MS = 24 * 60 * 60 * 1000; // 24 hours\r\n\r\n// ============================================================================\r\n// Validation Callbacks\r\n// ============================================================================\r\n\r\nexport interface ValidationCallbacks {\r\n  onSnooze: (warningId: string) => void;\r\n  onDismiss: (warningId: string) => void;\r\n  onUndismiss: (warningId: string) => void;\r\n  onNavigateToNode: (nodeId: string) => void;\r\n}\r\n\r\n// ============================================================================\r\n// Conflict Detection Types\r\n// ============================================================================\r\n\r\nexport interface OutcomeConflict {\r\n  behaviourId: string;\r\n  behaviourLabel: string;\r\n  outcomeId: string;\r\n  outcomeLabel: string;\r\n  valence: 'negative';\r\n}\r\n\r\nexport interface ValueConflict {\r\n  behaviourId: string;\r\n  behaviourLabel: string;\r\n  positiveValues: Array<{ id: string; label: string }>;\r\n  negativeValues: Array<{ id: string; label: string }>;\r\n}\r\n\r\n// ============================================================================\r\n// Path Analysis Types\r\n// ============================================================================\r\n\r\nexport interface PathToValue {\r\n  behaviourId: string;\r\n  outcomeId: string;\r\n  valueId: string;\r\n  valence: 'positive' | 'negative';\r\n  /** Combined weight from behaviour->outcome->value */\r\n  weight: number;\r\n}\r\n\r\n// ============================================================================\r\n// Helper Functions\r\n// ============================================================================\r\n\r\n/**\r\n * Generate a unique warning ID based on type and node.\r\n */\r\nexport function generateWarningId(type: WarningType, nodeId: string): string {\r\n  return `w-${type}-${nodeId}`;\r\n}\r\n\r\n/**\r\n * Get severity for a warning type.\r\n */\r\nexport function getSeverity(type: WarningType): WarningSeverity {\r\n  switch (type) {\r\n    case 'orphan-value':\r\n      return 'warning';\r\n    case 'unexplained-behaviour':\r\n      return 'info';\r\n    case 'floating-outcome':\r\n      return 'info';\r\n    case 'outcome-level-conflict':\r\n      return 'warning';\r\n    case 'value-level-conflict':\r\n      return 'error';\r\n    default:\r\n      return 'info';\r\n  }\r\n}\r\n\r\n/**\r\n * Get human-readable label for warning type.\r\n */\r\nexport function getWarningTypeLabel(type: WarningType): string {\r\n  switch (type) {\r\n    case 'orphan-value':\r\n      return 'Orphan Value';\r\n    case 'unexplained-behaviour':\r\n      return 'Unexplained Behaviour';\r\n    case 'floating-outcome':\r\n      return 'Floating Outcome';\r\n    case 'outcome-level-conflict':\r\n      return 'Outcome Conflict';\r\n    case 'value-level-conflict':\r\n      return 'Value Conflict';\r\n    default:\r\n      return 'Unknown';\r\n  }\r\n}\r\n\r\n/**\r\n * Check if a warning is currently active (not snoozed or dismissed).\r\n */\r\nexport function isWarningActive(warning: Warning, state: WarningState): boolean {\r\n  if (state.dismissed[warning.id] === true) {\r\n    return false;\r\n  }\r\n  const snoozedUntil = state.snoozed[warning.id];\r\n  if (snoozedUntil !== undefined && snoozedUntil !== '') {\r\n    return new Date(snoozedUntil) < new Date();\r\n  }\r\n  return true;\r\n}\r\n\r\n/**\r\n * Create an empty validation result.\r\n */\r\nexport function createEmptyValidationResult(): ValidationResult {\r\n  return {\r\n    warnings: [],\r\n    byType: {\r\n      'orphan-value': [],\r\n      'unexplained-behaviour': [],\r\n      'floating-outcome': [],\r\n      'outcome-level-conflict': [],\r\n      'value-level-conflict': [],\r\n    },\r\n    byNodeId: {},\r\n    counts: {\r\n      total: 0,\r\n      byType: {\r\n        'orphan-value': 0,\r\n        'unexplained-behaviour': 0,\r\n        'floating-outcome': 0,\r\n        'outcome-level-conflict': 0,\r\n        'value-level-conflict': 0,\r\n      },\r\n      bySeverity: {\r\n        error: 0,\r\n        warning: 0,\r\n        info: 0,\r\n      },\r\n      active: 0,\r\n      snoozed: 0,\r\n      dismissed: 0,\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Create empty warning state.\r\n */\r\nexport function createEmptyWarningState(): WarningState {\r\n  return {\r\n    snoozed: {},\r\n    dismissed: {},\r\n  };\r\n}\r\n","/**\r\n * Validation Engine\r\n *\r\n * Core validation logic for detecting structural issues in the network.\r\n */\r\n\r\nimport type {\r\n  Network,\r\n  Behaviour,\r\n  Outcome,\r\n  Value,\r\n  BehaviourOutcomeLink,\r\n  OutcomeValueLink,\r\n} from '@/types';\r\n\r\nimport {\r\n  Warning,\r\n  WarningState,\r\n  ValidationResult,\r\n  PathToValue,\r\n  OutcomeConflict,\r\n  ValueConflict,\r\n  createEmptyValidationResult,\r\n  generateWarningId,\r\n  getSeverity,\r\n  isWarningActive,\r\n} from './types';\r\n\r\n// ============================================================================\r\n// Helper Functions\r\n// ============================================================================\r\n\r\n/**\r\n * Get all behaviour-outcome links from the network.\r\n */\r\nfunction getBehaviourOutcomeLinks(network: Network): BehaviourOutcomeLink[] {\r\n  return network.links.filter(\r\n    (link): link is BehaviourOutcomeLink => link.type === 'behaviour-outcome'\r\n  );\r\n}\r\n\r\n/**\r\n * Get all outcome-value links from the network.\r\n */\r\nfunction getOutcomeValueLinks(network: Network): OutcomeValueLink[] {\r\n  return network.links.filter(\r\n    (link): link is OutcomeValueLink => link.type === 'outcome-value'\r\n  );\r\n}\r\n\r\n/**\r\n * Find a behaviour by ID.\r\n */\r\nfunction findBehaviour(network: Network, id: string): Behaviour | undefined {\r\n  return network.behaviours.find((b) => b.id === id);\r\n}\r\n\r\n/**\r\n * Find an outcome by ID.\r\n */\r\nfunction findOutcome(network: Network, id: string): Outcome | undefined {\r\n  return network.outcomes.find((o) => o.id === id);\r\n}\r\n\r\n/**\r\n * Find a value by ID.\r\n */\r\nfunction findValue(network: Network, id: string): Value | undefined {\r\n  return network.values.find((v) => v.id === id);\r\n}\r\n\r\n// ============================================================================\r\n// Orphan Values Detection (V-1)\r\n// ============================================================================\r\n\r\n/**\r\n * Detect values with no incoming path from any behaviour.\r\n * A value is an orphan if:\r\n * - No outcome links to it, OR\r\n * - All outcomes that link to it have no behaviour links\r\n */\r\nexport function detectOrphanValues(network: Network): Warning[] {\r\n  const warnings: Warning[] = [];\r\n  const boLinks = getBehaviourOutcomeLinks(network);\r\n  const ovLinks = getOutcomeValueLinks(network);\r\n\r\n  // Build set of outcomes that have incoming behaviour links\r\n  const outcomeIdsWithBehaviours = new Set(boLinks.map((l) => l.targetId));\r\n\r\n  // For each value, check if it has a path from a behaviour\r\n  for (const value of network.values) {\r\n    // Get outcomes that link to this value\r\n    const incomingOutcomeIds = ovLinks\r\n      .filter((l) => l.targetId === value.id)\r\n      .map((l) => l.sourceId);\r\n\r\n    // Check if any of those outcomes have a behaviour link\r\n    const hasPathFromBehaviour = incomingOutcomeIds.some((outcomeId) =>\r\n      outcomeIdsWithBehaviours.has(outcomeId)\r\n    );\r\n\r\n    if (!hasPathFromBehaviour) {\r\n      warnings.push({\r\n        id: generateWarningId('orphan-value', value.id),\r\n        type: 'orphan-value',\r\n        nodeId: value.id,\r\n        message: `\"${value.label}\" has no connection from any behaviour`,\r\n        severity: getSeverity('orphan-value'),\r\n        relatedNodeIds: incomingOutcomeIds,\r\n        suggestion: 'Connect this value to an outcome, or use Why Ladder to trace a behaviour to this value.',\r\n      });\r\n    }\r\n  }\r\n\r\n  return warnings;\r\n}\r\n\r\n// ============================================================================\r\n// Unexplained Behaviours Detection (V-2)\r\n// ============================================================================\r\n\r\n/**\r\n * Detect behaviours with no outgoing links.\r\n */\r\nexport function detectUnexplainedBehaviours(network: Network): Warning[] {\r\n  const warnings: Warning[] = [];\r\n  const boLinks = getBehaviourOutcomeLinks(network);\r\n\r\n  // Build set of behaviours that have outgoing links\r\n  const behaviourIdsWithLinks = new Set(boLinks.map((l) => l.sourceId));\r\n\r\n  for (const behaviour of network.behaviours) {\r\n    if (!behaviourIdsWithLinks.has(behaviour.id)) {\r\n      warnings.push({\r\n        id: generateWarningId('unexplained-behaviour', behaviour.id),\r\n        type: 'unexplained-behaviour',\r\n        nodeId: behaviour.id,\r\n        message: `\"${behaviour.label}\" has no outcomes linked`,\r\n        severity: getSeverity('unexplained-behaviour'),\r\n        relatedNodeIds: [],\r\n        suggestion: 'Use Why Ladder to explore what outcomes this behaviour produces.',\r\n      });\r\n    }\r\n  }\r\n\r\n  return warnings;\r\n}\r\n\r\n// ============================================================================\r\n// Floating Outcomes Detection (V-3)\r\n// ============================================================================\r\n\r\n/**\r\n * Detect outcomes with no downstream links to values.\r\n */\r\nexport function detectFloatingOutcomes(network: Network): Warning[] {\r\n  const warnings: Warning[] = [];\r\n  const ovLinks = getOutcomeValueLinks(network);\r\n\r\n  // Build set of outcomes that have downstream links\r\n  const outcomeIdsWithDownstream = new Set(ovLinks.map((l) => l.sourceId));\r\n\r\n  for (const outcome of network.outcomes) {\r\n    if (!outcomeIdsWithDownstream.has(outcome.id)) {\r\n      warnings.push({\r\n        id: generateWarningId('floating-outcome', outcome.id),\r\n        type: 'floating-outcome',\r\n        nodeId: outcome.id,\r\n        message: `\"${outcome.label}\" is not connected to any value`,\r\n        severity: getSeverity('floating-outcome'),\r\n        relatedNodeIds: [],\r\n        suggestion: 'Ask \"Why does this outcome matter?\" to connect it to a value.',\r\n      });\r\n    }\r\n  }\r\n\r\n  return warnings;\r\n}\r\n\r\n// ============================================================================\r\n// Outcome-Level Conflicts Detection (V-4)\r\n// ============================================================================\r\n\r\n/**\r\n * Detect behaviours with negative behaviour→outcome links.\r\n * These represent immediate harm caused by a behaviour.\r\n */\r\nexport function detectOutcomeLevelConflicts(network: Network): Warning[] {\r\n  const warnings: Warning[] = [];\r\n  const boLinks = getBehaviourOutcomeLinks(network);\r\n\r\n  // Group negative links by behaviour\r\n  const negativeByBehaviour = new Map<string, BehaviourOutcomeLink[]>();\r\n  for (const link of boLinks) {\r\n    if (link.valence === 'negative') {\r\n      const existing = negativeByBehaviour.get(link.sourceId) ?? [];\r\n      existing.push(link);\r\n      negativeByBehaviour.set(link.sourceId, existing);\r\n    }\r\n  }\r\n\r\n  for (const [behaviourId, negativeLinks] of negativeByBehaviour) {\r\n    const behaviour = findBehaviour(network, behaviourId);\r\n    if (!behaviour) continue;\r\n\r\n    const negativeOutcomes = negativeLinks\r\n      .map((l) => {\r\n        const outcome = findOutcome(network, l.targetId);\r\n        return outcome ? { id: outcome.id, label: outcome.label } : null;\r\n      })\r\n      .filter((o): o is { id: string; label: string } => o !== null);\r\n\r\n    if (negativeOutcomes.length > 0) {\r\n      const outcomeNames = negativeOutcomes.map((o) => `\"${o.label}\"`).join(', ');\r\n      warnings.push({\r\n        id: generateWarningId('outcome-level-conflict', behaviourId),\r\n        type: 'outcome-level-conflict',\r\n        nodeId: behaviourId,\r\n        message: `\"${behaviour.label}\" has negative effects on: ${outcomeNames}`,\r\n        severity: getSeverity('outcome-level-conflict'),\r\n        relatedNodeIds: negativeOutcomes.map((o) => o.id),\r\n        suggestion: 'Consider whether the benefits outweigh the costs, or find alternatives.',\r\n      });\r\n    }\r\n  }\r\n\r\n  return warnings;\r\n}\r\n\r\n// ============================================================================\r\n// Value-Level Conflicts Detection (V-5)\r\n// ============================================================================\r\n\r\n/**\r\n * Compute all paths from behaviours to values with their effective valence.\r\n */\r\nexport function computePathsToValues(network: Network): PathToValue[] {\r\n  const paths: PathToValue[] = [];\r\n  const boLinks = getBehaviourOutcomeLinks(network);\r\n  const ovLinks = getOutcomeValueLinks(network);\r\n\r\n  // For each behaviour->outcome link\r\n  for (const boLink of boLinks) {\r\n    // Find all outcome->value links from this outcome\r\n    const downstreamLinks = ovLinks.filter((l) => l.sourceId === boLink.targetId);\r\n\r\n    for (const ovLink of downstreamLinks) {\r\n      // Determine effective valence (negative * negative = positive, etc.)\r\n      const effectiveValence =\r\n        boLink.valence === ovLink.valence ? 'positive' : 'negative';\r\n\r\n      // Compute weight based on reliability and strength\r\n      const reliabilityWeight = getReliabilityWeight(boLink.reliability);\r\n      const strengthWeight = getStrengthWeight(ovLink.strength);\r\n      const valenceMultiplier = effectiveValence === 'positive' ? 1 : -1;\r\n      const weight = reliabilityWeight * strengthWeight * valenceMultiplier;\r\n\r\n      paths.push({\r\n        behaviourId: boLink.sourceId,\r\n        outcomeId: boLink.targetId,\r\n        valueId: ovLink.targetId,\r\n        valence: effectiveValence,\r\n        weight,\r\n      });\r\n    }\r\n  }\r\n\r\n  return paths;\r\n}\r\n\r\n/**\r\n * Convert reliability to numeric weight.\r\n */\r\nfunction getReliabilityWeight(reliability: string): number {\r\n  switch (reliability) {\r\n    case 'always':\r\n      return 1.0;\r\n    case 'usually':\r\n      return 0.75;\r\n    case 'sometimes':\r\n      return 0.5;\r\n    case 'rarely':\r\n      return 0.25;\r\n    default:\r\n      return 0.5;\r\n  }\r\n}\r\n\r\n/**\r\n * Convert strength to numeric weight.\r\n */\r\nfunction getStrengthWeight(strength: string): number {\r\n  switch (strength) {\r\n    case 'strong':\r\n      return 1.0;\r\n    case 'moderate':\r\n      return 0.6;\r\n    case 'weak':\r\n      return 0.3;\r\n    default:\r\n      return 0.5;\r\n  }\r\n}\r\n\r\n/**\r\n * Detect behaviours with mixed positive/negative downstream effects on values.\r\n * A value-level conflict occurs when a behaviour helps some values while hurting others.\r\n */\r\nexport function detectValueLevelConflicts(network: Network): Warning[] {\r\n  const warnings: Warning[] = [];\r\n  const paths = computePathsToValues(network);\r\n\r\n  // Group paths by behaviour\r\n  const pathsByBehaviour = new Map<string, PathToValue[]>();\r\n  for (const path of paths) {\r\n    const existing = pathsByBehaviour.get(path.behaviourId) ?? [];\r\n    existing.push(path);\r\n    pathsByBehaviour.set(path.behaviourId, existing);\r\n  }\r\n\r\n  for (const [behaviourId, behaviourPaths] of pathsByBehaviour) {\r\n    const behaviour = findBehaviour(network, behaviourId);\r\n    if (!behaviour) continue;\r\n\r\n    // Get unique values affected positively and negatively\r\n    const positiveValueIds = new Set<string>();\r\n    const negativeValueIds = new Set<string>();\r\n\r\n    for (const path of behaviourPaths) {\r\n      if (path.valence === 'positive') {\r\n        positiveValueIds.add(path.valueId);\r\n      } else {\r\n        negativeValueIds.add(path.valueId);\r\n      }\r\n    }\r\n\r\n    // Check if there's a conflict (both positive and negative effects)\r\n    if (positiveValueIds.size > 0 && negativeValueIds.size > 0) {\r\n      const positiveValues = Array.from(positiveValueIds)\r\n        .map((id) => findValue(network, id))\r\n        .filter((v): v is Value => v !== undefined)\r\n        .map((v) => ({ id: v.id, label: v.label }));\r\n\r\n      const negativeValues = Array.from(negativeValueIds)\r\n        .map((id) => findValue(network, id))\r\n        .filter((v): v is Value => v !== undefined)\r\n        .map((v) => ({ id: v.id, label: v.label }));\r\n\r\n      const positiveNames = positiveValues.map((v) => `\"${v.label}\"`).join(', ');\r\n      const negativeNames = negativeValues.map((v) => `\"${v.label}\"`).join(', ');\r\n\r\n      warnings.push({\r\n        id: generateWarningId('value-level-conflict', behaviourId),\r\n        type: 'value-level-conflict',\r\n        nodeId: behaviourId,\r\n        message: `\"${behaviour.label}\" creates a trade-off: helps ${positiveNames} but hurts ${negativeNames}`,\r\n        severity: getSeverity('value-level-conflict'),\r\n        relatedNodeIds: [...positiveValueIds, ...negativeValueIds],\r\n        suggestion: 'Consider whether this trade-off aligns with your priorities.',\r\n      });\r\n    }\r\n  }\r\n\r\n  return warnings;\r\n}\r\n\r\n// ============================================================================\r\n// Main Validation Function\r\n// ============================================================================\r\n\r\n/**\r\n * Run all validation checks and return a comprehensive result.\r\n */\r\nexport function validateNetwork(network: Network, state?: WarningState): ValidationResult {\r\n  const result = createEmptyValidationResult();\r\n  const warningState = state ?? { snoozed: {}, dismissed: {} };\r\n\r\n  // Collect all warnings\r\n  const allWarnings = [\r\n    ...detectOrphanValues(network),\r\n    ...detectUnexplainedBehaviours(network),\r\n    ...detectFloatingOutcomes(network),\r\n    ...detectOutcomeLevelConflicts(network),\r\n    ...detectValueLevelConflicts(network),\r\n  ];\r\n\r\n  result.warnings = allWarnings;\r\n\r\n  // Build indexes\r\n  for (const warning of allWarnings) {\r\n    // By type\r\n    result.byType[warning.type].push(warning);\r\n\r\n    // By node ID\r\n    result.byNodeId[warning.nodeId] ??= [];\r\n    const nodeWarnings = result.byNodeId[warning.nodeId];\r\n    if (nodeWarnings !== undefined) {\r\n      nodeWarnings.push(warning);\r\n    }\r\n\r\n    // Counts\r\n    result.counts.total++;\r\n    result.counts.byType[warning.type]++;\r\n    result.counts.bySeverity[warning.severity]++;\r\n\r\n    // Active/snoozed/dismissed\r\n    const snoozedUntil = warningState.snoozed[warning.id];\r\n    if (warningState.dismissed[warning.id] === true) {\r\n      result.counts.dismissed++;\r\n    } else if (snoozedUntil !== undefined && snoozedUntil !== '' && new Date(snoozedUntil) > new Date()) {\r\n      result.counts.snoozed++;\r\n    } else {\r\n      result.counts.active++;\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Get active warnings only (not snoozed or dismissed).\r\n */\r\nexport function getActiveWarnings(result: ValidationResult, state: WarningState): Warning[] {\r\n  return result.warnings.filter((w) => isWarningActive(w, state));\r\n}\r\n\r\n/**\r\n * Get warnings for a specific node.\r\n */\r\nexport function getWarningsForNode(result: ValidationResult, nodeId: string): Warning[] {\r\n  return result.byNodeId[nodeId] ?? [];\r\n}\r\n\r\n/**\r\n * Get conflict details for a behaviour.\r\n */\r\nexport function getConflictDetails(\r\n  network: Network,\r\n  behaviourId: string\r\n): { outcomeConflicts: OutcomeConflict[]; valueConflict: ValueConflict | null } {\r\n  const boLinks = getBehaviourOutcomeLinks(network);\r\n  const behaviour = findBehaviour(network, behaviourId);\r\n\r\n  if (!behaviour) {\r\n    return { outcomeConflicts: [], valueConflict: null };\r\n  }\r\n\r\n  // Outcome-level conflicts\r\n  const outcomeConflicts: OutcomeConflict[] = boLinks\r\n    .filter((l) => l.sourceId === behaviourId && l.valence === 'negative')\r\n    .map((l) => {\r\n      const outcome = findOutcome(network, l.targetId);\r\n      return outcome\r\n        ? {\r\n            behaviourId,\r\n            behaviourLabel: behaviour.label,\r\n            outcomeId: outcome.id,\r\n            outcomeLabel: outcome.label,\r\n            valence: 'negative' as const,\r\n          }\r\n        : null;\r\n    })\r\n    .filter((c): c is OutcomeConflict => c !== null);\r\n\r\n  // Value-level conflict\r\n  const paths = computePathsToValues(network).filter((p) => p.behaviourId === behaviourId);\r\n  const positiveValues: Array<{ id: string; label: string }> = [];\r\n  const negativeValues: Array<{ id: string; label: string }> = [];\r\n  const seenPositive = new Set<string>();\r\n  const seenNegative = new Set<string>();\r\n\r\n  for (const path of paths) {\r\n    const value = findValue(network, path.valueId);\r\n    if (!value) continue;\r\n\r\n    if (path.valence === 'positive' && !seenPositive.has(path.valueId)) {\r\n      positiveValues.push({ id: value.id, label: value.label });\r\n      seenPositive.add(path.valueId);\r\n    } else if (path.valence === 'negative' && !seenNegative.has(path.valueId)) {\r\n      negativeValues.push({ id: value.id, label: value.label });\r\n      seenNegative.add(path.valueId);\r\n    }\r\n  }\r\n\r\n  const valueConflict =\r\n    positiveValues.length > 0 && negativeValues.length > 0\r\n      ? {\r\n          behaviourId,\r\n          behaviourLabel: behaviour.label,\r\n          positiveValues,\r\n          negativeValues,\r\n        }\r\n      : null;\r\n\r\n  return { outcomeConflicts, valueConflict };\r\n}\r\n","/**\r\n * Validation Panel Component\r\n *\r\n * Displays network validation warnings with snooze/dismiss functionality.\r\n */\r\n\r\nimport type { Network } from '@/types';\r\nimport {\r\n  Warning,\r\n  WarningState,\r\n  ValidationResult,\r\n  ValidationCallbacks,\r\n  validateNetwork,\r\n  getActiveWarnings,\r\n  createEmptyWarningState,\r\n  DEFAULT_SNOOZE_DURATION_MS,\r\n} from '@/validation';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface ValidationPanelOptions {\r\n  network: Network;\r\n  warningState?: WarningState;\r\n  callbacks: ValidationCallbacks;\r\n  showDismissed?: boolean;\r\n}\r\n\r\n// ============================================================================\r\n// Component\r\n// ============================================================================\r\n\r\nexport class ValidationPanel {\r\n  private container: HTMLElement;\r\n  private network: Network;\r\n  private warningState: WarningState;\r\n  private callbacks: ValidationCallbacks;\r\n  private showDismissed: boolean;\r\n  private result: ValidationResult | null = null;\r\n  private expandedTypes: Set<string> = new Set();\r\n\r\n  constructor(container: HTMLElement, options: ValidationPanelOptions) {\r\n    this.container = container;\r\n    this.network = options.network;\r\n    this.warningState = options.warningState ?? createEmptyWarningState();\r\n    this.callbacks = options.callbacks;\r\n    this.showDismissed = options.showDismissed ?? false;\r\n\r\n    this.render();\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Public Methods\r\n  // ==========================================================================\r\n\r\n  public setNetwork(network: Network): void {\r\n    this.network = network;\r\n    this.result = null;\r\n    this.render();\r\n  }\r\n\r\n  public setWarningState(state: WarningState): void {\r\n    this.warningState = state;\r\n    this.render();\r\n  }\r\n\r\n  public getValidationResult(): ValidationResult {\r\n    this.result ??= validateNetwork(this.network, this.warningState);\r\n    return this.result;\r\n  }\r\n\r\n  public refresh(): void {\r\n    this.result = null;\r\n    this.render();\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Rendering\r\n  // ==========================================================================\r\n\r\n  private render(): void {\r\n    const result = this.getValidationResult();\r\n    const activeWarnings = getActiveWarnings(result, this.warningState);\r\n\r\n    this.container.innerHTML = `\r\n      <div class=\"validation-panel\">\r\n        ${this.renderHeader(result, activeWarnings.length)}\r\n        ${this.renderSummary(result)}\r\n        ${this.renderWarningGroups(result)}\r\n      </div>\r\n    `;\r\n\r\n    this.bindEvents();\r\n  }\r\n\r\n  private renderHeader(_result: ValidationResult, activeCount: number): string {\r\n    const statusIcon = activeCount === 0 ? '✓' : '⚠';\r\n    const statusClass = activeCount === 0 ? 'status-ok' : 'status-warning';\r\n\r\n    return `\r\n      <div class=\"validation-header\">\r\n        <div class=\"validation-status ${statusClass}\">\r\n          <span class=\"status-icon\">${statusIcon}</span>\r\n          <span class=\"status-text\">\r\n            ${activeCount === 0 ? 'No issues' : `${activeCount} issue${activeCount === 1 ? '' : 's'}`}\r\n          </span>\r\n        </div>\r\n        <div class=\"validation-actions\">\r\n          <button class=\"btn btn-small\" id=\"btn-refresh-validation\" title=\"Re-run validation\">\r\n            ↻\r\n          </button>\r\n          <label class=\"toggle-label\">\r\n            <input type=\"checkbox\" id=\"chk-show-dismissed\" ${this.showDismissed ? 'checked' : ''}>\r\n            Show dismissed\r\n          </label>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderSummary(result: ValidationResult): string {\r\n    const counts = result.counts;\r\n    \r\n    if (counts.total === 0) {\r\n      return `\r\n        <div class=\"validation-summary validation-empty\">\r\n          <p>Your network is well-connected! 🎉</p>\r\n        </div>\r\n      `;\r\n    }\r\n\r\n    return `\r\n      <div class=\"validation-summary\">\r\n        <div class=\"summary-counts\">\r\n          ${counts.bySeverity.error > 0 ? `<span class=\"count-badge error\">${counts.bySeverity.error} conflicts</span>` : ''}\r\n          ${counts.bySeverity.warning > 0 ? `<span class=\"count-badge warning\">${counts.bySeverity.warning} warnings</span>` : ''}\r\n          ${counts.bySeverity.info > 0 ? `<span class=\"count-badge info\">${counts.bySeverity.info} suggestions</span>` : ''}\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  private renderWarningGroups(result: ValidationResult): string {\r\n    const groups = [\r\n      { type: 'value-level-conflict' as const, label: 'Value Conflicts', severity: 'error' },\r\n      { type: 'outcome-level-conflict' as const, label: 'Outcome Conflicts', severity: 'warning' },\r\n      { type: 'orphan-value' as const, label: 'Orphan Values', severity: 'warning' },\r\n      { type: 'unexplained-behaviour' as const, label: 'Unexplained Behaviours', severity: 'info' },\r\n      { type: 'floating-outcome' as const, label: 'Floating Outcomes', severity: 'info' },\r\n    ];\r\n\r\n    let html = '<div class=\"warning-groups\">';\r\n\r\n    for (const group of groups) {\r\n      const warnings = this.filterWarnings(result.byType[group.type]);\r\n      if (warnings.length === 0) continue;\r\n\r\n      const isExpanded = this.expandedTypes.has(group.type);\r\n      \r\n      html += `\r\n        <div class=\"warning-group ${group.severity}\">\r\n          <div class=\"group-header\" data-type=\"${group.type}\">\r\n            <span class=\"group-icon\">${isExpanded ? '▼' : '▶'}</span>\r\n            <span class=\"group-label\">${group.label}</span>\r\n            <span class=\"group-count\">${warnings.length}</span>\r\n          </div>\r\n          ${isExpanded ? this.renderWarningList(warnings) : ''}\r\n        </div>\r\n      `;\r\n    }\r\n\r\n    html += '</div>';\r\n    return html;\r\n  }\r\n\r\n  private filterWarnings(warnings: Warning[]): Warning[] {\r\n    return warnings.filter((w) => {\r\n      const isDismissed = this.warningState.dismissed[w.id] === true;\r\n      const snoozedUntil = this.warningState.snoozed[w.id];\r\n      const isSnoozed = snoozedUntil !== undefined && snoozedUntil !== '' && new Date(snoozedUntil) > new Date();\r\n\r\n      if (!this.showDismissed && isDismissed) return false;\r\n      if (!this.showDismissed && isSnoozed) return false;\r\n      return true;\r\n    });\r\n  }\r\n\r\n  private renderWarningList(warnings: Warning[]): string {\r\n    if (warnings.length === 0) {\r\n      return '<div class=\"warning-list-empty\">No issues</div>';\r\n    }\r\n\r\n    let html = '<div class=\"warning-list\">';\r\n    for (const warning of warnings) {\r\n      html += this.renderWarningItem(warning);\r\n    }\r\n    html += '</div>';\r\n    return html;\r\n  }\r\n\r\n  private renderWarningItem(warning: Warning): string {\r\n    const isDismissed = this.warningState.dismissed[warning.id] === true;\r\n    const snoozedUntil = this.warningState.snoozed[warning.id];\r\n    const isSnoozed = snoozedUntil !== undefined && snoozedUntil !== '' && new Date(snoozedUntil) > new Date();\r\n\r\n    const statusClass = isDismissed ? 'dismissed' : isSnoozed ? 'snoozed' : 'active';\r\n\r\n    return `\r\n      <div class=\"warning-item ${statusClass}\" data-warning-id=\"${warning.id}\">\r\n        <div class=\"warning-content\">\r\n          <div class=\"warning-message\">${warning.message}</div>\r\n          ${warning.suggestion !== undefined && warning.suggestion !== '' ? `<div class=\"warning-suggestion\">${warning.suggestion}</div>` : ''}\r\n          ${isSnoozed && snoozedUntil !== undefined ? `<div class=\"warning-status\">Snoozed until ${new Date(snoozedUntil).toLocaleString()}</div>` : ''}\r\n          ${isDismissed ? '<div class=\"warning-status\">Dismissed</div>' : ''}\r\n        </div>\r\n        <div class=\"warning-actions\">\r\n          <button class=\"btn-icon btn-navigate\" data-node-id=\"${warning.nodeId}\" title=\"Go to node\">\r\n            👁\r\n          </button>\r\n          ${!isDismissed && !isSnoozed ? `\r\n            <button class=\"btn-icon btn-snooze\" data-warning-id=\"${warning.id}\" title=\"Snooze for 24h\">\r\n              💤\r\n            </button>\r\n            <button class=\"btn-icon btn-dismiss\" data-warning-id=\"${warning.id}\" title=\"Dismiss\">\r\n              ✕\r\n            </button>\r\n          ` : ''}\r\n          ${isDismissed ? `\r\n            <button class=\"btn-icon btn-undismiss\" data-warning-id=\"${warning.id}\" title=\"Restore\">\r\n              ↩\r\n            </button>\r\n          ` : ''}\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  // ==========================================================================\r\n  // Event Handling\r\n  // ==========================================================================\r\n\r\n  private bindEvents(): void {\r\n    // Refresh button\r\n    this.container.querySelector('#btn-refresh-validation')?.addEventListener('click', () => {\r\n      this.refresh();\r\n    });\r\n\r\n    // Show dismissed checkbox\r\n    this.container.querySelector('#chk-show-dismissed')?.addEventListener('change', (e) => {\r\n      this.showDismissed = (e.target as HTMLInputElement).checked;\r\n      this.render();\r\n    });\r\n\r\n    // Group headers (expand/collapse)\r\n    this.container.querySelectorAll('.group-header').forEach((header) => {\r\n      header.addEventListener('click', (e) => {\r\n        const type = (e.currentTarget as HTMLElement).dataset.type;\r\n        if (type !== undefined && type !== '') {\r\n          if (this.expandedTypes.has(type)) {\r\n            this.expandedTypes.delete(type);\r\n          } else {\r\n            this.expandedTypes.add(type);\r\n          }\r\n          this.render();\r\n        }\r\n      });\r\n    });\r\n\r\n    // Navigate buttons\r\n    this.container.querySelectorAll('.btn-navigate').forEach((btn) => {\r\n      btn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        const nodeId = (e.currentTarget as HTMLElement).dataset.nodeId;\r\n        if (nodeId !== undefined && nodeId !== '') {\r\n          this.callbacks.onNavigateToNode(nodeId);\r\n        }\r\n      });\r\n    });\r\n\r\n    // Snooze buttons\r\n    this.container.querySelectorAll('.btn-snooze').forEach((btn) => {\r\n      btn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        const warningId = (e.currentTarget as HTMLElement).dataset.warningId;\r\n        if (warningId !== undefined && warningId !== '') {\r\n          // Set snooze time\r\n          const snoozeUntil = new Date(Date.now() + DEFAULT_SNOOZE_DURATION_MS).toISOString();\r\n          this.warningState.snoozed[warningId] = snoozeUntil;\r\n          this.callbacks.onSnooze(warningId);\r\n          this.render();\r\n        }\r\n      });\r\n    });\r\n\r\n    // Dismiss buttons\r\n    this.container.querySelectorAll('.btn-dismiss').forEach((btn) => {\r\n      btn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        const warningId = (e.currentTarget as HTMLElement).dataset.warningId;\r\n        if (warningId !== undefined && warningId !== '') {\r\n          this.warningState.dismissed[warningId] = true;\r\n          this.callbacks.onDismiss(warningId);\r\n          this.render();\r\n        }\r\n      });\r\n    });\r\n\r\n    // Undismiss buttons\r\n    this.container.querySelectorAll('.btn-undismiss').forEach((btn) => {\r\n      btn.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        const warningId = (e.currentTarget as HTMLElement).dataset.warningId;\r\n        if (warningId !== undefined && warningId !== '') {\r\n          delete this.warningState.dismissed[warningId];\r\n          this.callbacks.onUndismiss(warningId);\r\n          this.render();\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n","/**\r\n * Welcome Screen Component\r\n * First-run experience for new users\r\n */\r\n\r\nexport interface WelcomeScreenCallbacks {\r\n  onGetStarted: () => void;\r\n  onImportData: () => void;\r\n}\r\n\r\nexport class WelcomeScreen {\r\n  private container: HTMLElement;\r\n  private element: HTMLElement | null = null;\r\n  private callbacks: WelcomeScreenCallbacks;\r\n\r\n  constructor(container: HTMLElement, callbacks: WelcomeScreenCallbacks) {\r\n    this.container = container;\r\n    this.callbacks = callbacks;\r\n  }\r\n\r\n  show(): void {\r\n    if (this.element !== null) {\r\n      this.element.classList.remove('hidden');\r\n      const existingStartButton = this.element.querySelector<HTMLButtonElement>('#btn-welcome-start');\r\n      existingStartButton?.focus();\r\n      return;\r\n    }\r\n\r\n    this.element = document.createElement('div');\r\n    this.element.className = 'welcome-screen';\r\n    this.element.setAttribute('role', 'dialog');\r\n    this.element.setAttribute('aria-labelledby', 'welcome-title');\r\n    this.element.innerHTML = `\r\n      <div class=\"welcome-content\">\r\n        <h1 id=\"welcome-title\" class=\"welcome-title\">Welcome to M-E Net</h1>\r\n        <p class=\"welcome-subtitle\">Map your behaviours to what truly matters</p>\r\n        \r\n        <div class=\"welcome-description\">\r\n          <p>M-E Net helps you understand <strong>why</strong> you do what you do by connecting:</p>\r\n          <ul class=\"welcome-list\">\r\n            <li><strong>Behaviours</strong> — The actions you take</li>\r\n            <li><strong>Outcomes</strong> — The effects they produce</li>\r\n            <li><strong>Values</strong> — What ultimately matters to you</li>\r\n          </ul>\r\n          <p>Discover which behaviours are most leveraged, which values are fragile, and where trade-offs exist.</p>\r\n        </div>\r\n\r\n        <div class=\"welcome-actions\">\r\n          <button id=\"btn-welcome-start\" class=\"btn btn-primary\" aria-label=\"Start mapping your first behaviour\">\r\n            Start with a Behaviour\r\n          </button>\r\n          <button id=\"btn-welcome-import\" class=\"btn btn-secondary\" aria-label=\"Import existing network data\">\r\n            Import Existing Data\r\n          </button>\r\n        </div>\r\n\r\n        <p class=\"welcome-hint\">Tip: Use the Why Ladder mode to quickly build your network</p>\r\n      </div>\r\n    `;\r\n\r\n    this.container.appendChild(this.element);\r\n\r\n    // Wire event handlers\r\n    const startBtn = this.element.querySelector<HTMLButtonElement>('#btn-welcome-start');\r\n    const importBtn = this.element.querySelector<HTMLButtonElement>('#btn-welcome-import');\r\n\r\n    if (startBtn !== null) {\r\n      startBtn.addEventListener('click', () => {\r\n        this.hide();\r\n        this.callbacks.onGetStarted();\r\n      });\r\n    }\r\n\r\n    if (importBtn !== null) {\r\n      importBtn.addEventListener('click', () => {\r\n        this.hide();\r\n        this.callbacks.onImportData();\r\n      });\r\n    }\r\n\r\n    // Focus the primary action\r\n    startBtn?.focus();\r\n  }\r\n\r\n  hide(): void {\r\n    if (this.element !== null) {\r\n      this.element.classList.add('hidden');\r\n    }\r\n  }\r\n\r\n  destroy(): void {\r\n    if (this.element !== null) {\r\n      this.element.remove();\r\n      this.element = null;\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Utility functions for ID generation and timestamps\r\n */\r\n\r\n/**\r\n * Generate a unique identifier with a prefix\r\n */\r\nexport function generateId(prefix: 'b' | 'o' | 'v' | 'l' | 'w'): string {\r\n  const timestamp = Date.now().toString(36);\r\n  const random = Math.random().toString(36).substring(2, 8);\r\n  return `${prefix}-${timestamp}-${random}`;\r\n}\r\n\r\n/**\r\n * Get current ISO 8601 timestamp\r\n */\r\nexport function now(): string {\r\n  return new Date().toISOString();\r\n}\r\n\r\n/**\r\n * Check if a string is a valid ISO 8601 date\r\n */\r\nexport function isValidISODate(dateString: string): boolean {\r\n  const date = new Date(dateString);\r\n  return !isNaN(date.getTime()) && dateString === date.toISOString();\r\n}\r\n","/**\r\n * Behaviour CRUD Operations\r\n *\r\n * Functions for creating, reading, updating, and deleting Behaviours.\r\n */\r\n\r\nimport type { Behaviour, Network, Cost, Frequency } from '@/types';\r\nimport { generateId, now } from '@/utils/id';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface CreateBehaviourInput {\r\n  label: string;\r\n  frequency: Frequency;\r\n  cost: Cost;\r\n  contextTags?: string[];\r\n  notes?: string;\r\n}\r\n\r\nexport interface UpdateBehaviourInput {\r\n  label?: string;\r\n  frequency?: Frequency;\r\n  cost?: Cost;\r\n  contextTags?: string[];\r\n  notes?: string;\r\n}\r\n\r\nexport interface CrudResult<T> {\r\n  success: boolean;\r\n  data?: T;\r\n  error?: string;\r\n}\r\n\r\n// ============================================================================\r\n// Create\r\n// ============================================================================\r\n\r\n/**\r\n * Add a new behaviour to the network.\r\n * Returns the updated network and the new behaviour.\r\n */\r\nexport function addBehaviour(\r\n  network: Network,\r\n  input: CreateBehaviourInput\r\n): CrudResult<{ network: Network; behaviour: Behaviour }> {\r\n  // Validate label\r\n  const labelValidation = validateLabel(input.label, network);\r\n  if (!labelValidation.valid) {\r\n    return { success: false, error: labelValidation.error };\r\n  }\r\n\r\n  const behaviour: Behaviour = {\r\n    id: generateId('b'),\r\n    type: 'behaviour',\r\n    label: input.label.trim(),\r\n    frequency: input.frequency,\r\n    cost: input.cost,\r\n    contextTags: input.contextTags ?? [],\r\n    notes: input.notes,\r\n    createdAt: now(),\r\n    updatedAt: now(),\r\n  };\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    behaviours: [...network.behaviours, behaviour],\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork, behaviour },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Read\r\n// ============================================================================\r\n\r\n/**\r\n * Find a behaviour by ID.\r\n */\r\nexport function getBehaviourById(network: Network, id: string): Behaviour | undefined {\r\n  return network.behaviours.find((b) => b.id === id);\r\n}\r\n\r\n/**\r\n * Find a behaviour by label (case-insensitive).\r\n */\r\nexport function getBehaviourByLabel(network: Network, label: string): Behaviour | undefined {\r\n  const normalised = label.trim().toLowerCase();\r\n  return network.behaviours.find((b) => b.label.toLowerCase() === normalised);\r\n}\r\n\r\n/**\r\n * Get all behaviours.\r\n */\r\nexport function getAllBehaviours(network: Network): Behaviour[] {\r\n  return network.behaviours;\r\n}\r\n\r\n/**\r\n * Get behaviours filtered by context tag.\r\n */\r\nexport function getBehavioursByTag(network: Network, tag: string): Behaviour[] {\r\n  const normalised = tag.trim().toLowerCase();\r\n  return network.behaviours.filter((b) =>\r\n    b.contextTags.some((t) => t.toLowerCase() === normalised)\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// Update\r\n// ============================================================================\r\n\r\n/**\r\n * Update an existing behaviour.\r\n * Returns the updated network and behaviour.\r\n */\r\nexport function updateBehaviour(\r\n  network: Network,\r\n  id: string,\r\n  input: UpdateBehaviourInput\r\n): CrudResult<{ network: Network; behaviour: Behaviour }> {\r\n  const existingIndex = network.behaviours.findIndex((b) => b.id === id);\r\n  if (existingIndex === -1) {\r\n    return { success: false, error: `Behaviour with id \"${id}\" not found` };\r\n  }\r\n\r\n  const existing = network.behaviours[existingIndex]!;\r\n\r\n  // Validate label uniqueness if changing label\r\n  if (input.label !== undefined && input.label.trim().toLowerCase() !== existing.label.toLowerCase()) {\r\n    const labelValidation = validateLabel(input.label, network);\r\n    if (!labelValidation.valid) {\r\n      return { success: false, error: labelValidation.error };\r\n    }\r\n  }\r\n\r\n  const updated: Behaviour = {\r\n    ...existing,\r\n    label: input.label?.trim() ?? existing.label,\r\n    frequency: input.frequency ?? existing.frequency,\r\n    cost: input.cost ?? existing.cost,\r\n    contextTags: input.contextTags ?? existing.contextTags,\r\n    notes: input.notes ?? existing.notes,\r\n    updatedAt: now(),\r\n  };\r\n\r\n  const updatedBehaviours = [...network.behaviours];\r\n  updatedBehaviours[existingIndex] = updated;\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    behaviours: updatedBehaviours,\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork, behaviour: updated },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Delete\r\n// ============================================================================\r\n\r\n/**\r\n * Delete a behaviour and all its incident links.\r\n * Returns the updated network.\r\n */\r\nexport function deleteBehaviour(\r\n  network: Network,\r\n  id: string\r\n): CrudResult<{ network: Network }> {\r\n  const existingIndex = network.behaviours.findIndex((b) => b.id === id);\r\n  if (existingIndex === -1) {\r\n    return { success: false, error: `Behaviour with id \"${id}\" not found` };\r\n  }\r\n\r\n  // Remove behaviour\r\n  const updatedBehaviours = network.behaviours.filter((b) => b.id !== id);\r\n\r\n  // Cascade delete: remove all links where this behaviour is the source\r\n  const updatedLinks = network.links.filter((link) => link.sourceId !== id);\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    behaviours: updatedBehaviours,\r\n    links: updatedLinks,\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Validation\r\n// ============================================================================\r\n\r\ninterface ValidationResult {\r\n  valid: boolean;\r\n  error?: string;\r\n}\r\n\r\n/**\r\n * Validate behaviour label (non-empty, unique within behaviours).\r\n */\r\nfunction validateLabel(label: string, network: Network): ValidationResult {\r\n  const trimmed = label.trim();\r\n\r\n  if (trimmed.length === 0) {\r\n    return { valid: false, error: 'Label cannot be empty' };\r\n  }\r\n\r\n  if (trimmed.length > 100) {\r\n    return { valid: false, error: 'Label cannot exceed 100 characters' };\r\n  }\r\n\r\n  // Check uniqueness (case-insensitive)\r\n  const exists = network.behaviours.some(\r\n    (b) => b.label.toLowerCase() === trimmed.toLowerCase()\r\n  );\r\n  if (exists) {\r\n    return { valid: false, error: `A behaviour with label \"${trimmed}\" already exists` };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n","/**\r\n * Network Factory for M-E Net\r\n *\r\n * Provides functions for creating and working with Network objects.\r\n */\r\n\r\nimport type { Network } from '@/types';\r\n\r\n// ============================================================================\r\n// Constants\r\n// ============================================================================\r\n\r\nconst CURRENT_VERSION = '1.0.0';\r\n\r\n// ============================================================================\r\n// Factory\r\n// ============================================================================\r\n\r\n/**\r\n * Create a new empty network with the correct structure.\r\n */\r\nexport function createEmptyNetwork(): Network {\r\n  return {\r\n    version: CURRENT_VERSION,\r\n    behaviours: [],\r\n    outcomes: [],\r\n    values: [],\r\n    links: [],\r\n  };\r\n}\r\n\r\n/**\r\n * Create a network with initial data (useful for testing and import).\r\n */\r\nexport function createNetwork(partial: Partial<Network> = {}): Network {\r\n  return {\r\n    version: partial.version ?? CURRENT_VERSION,\r\n    behaviours: partial.behaviours ?? [],\r\n    outcomes: partial.outcomes ?? [],\r\n    values: partial.values ?? [],\r\n    links: partial.links ?? [],\r\n    exportedAt: partial.exportedAt,\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Queries\r\n// ============================================================================\r\n\r\n/**\r\n * Check if a network is empty (no nodes).\r\n */\r\nexport function isNetworkEmpty(network: Network): boolean {\r\n  return (\r\n    network.behaviours.length === 0 &&\r\n    network.outcomes.length === 0 &&\r\n    network.values.length === 0\r\n  );\r\n}\r\n\r\n/**\r\n * Get total node count.\r\n */\r\nexport function getNodeCount(network: Network): number {\r\n  return network.behaviours.length + network.outcomes.length + network.values.length;\r\n}\r\n\r\n/**\r\n * Get total link count.\r\n */\r\nexport function getLinkCount(network: Network): number {\r\n  return network.links.length;\r\n}\r\n\r\n/**\r\n * Get network statistics summary.\r\n */\r\nexport interface NetworkStats {\r\n  behaviours: number;\r\n  outcomes: number;\r\n  values: number;\r\n  links: number;\r\n  totalNodes: number;\r\n}\r\n\r\nexport function getNetworkStats(network: Network): NetworkStats {\r\n  return {\r\n    behaviours: network.behaviours.length,\r\n    outcomes: network.outcomes.length,\r\n    values: network.values.length,\r\n    links: network.links.length,\r\n    totalNodes: getNodeCount(network),\r\n  };\r\n}\r\n","/**\r\n * Persistence Layer for M-E Net\r\n *\r\n * Handles saving and loading network data to/from localStorage.\r\n * See docs/data-model.md for the Network structure.\r\n */\r\n\r\nimport type { Network } from '@/types';\r\n\r\nimport { createEmptyNetwork } from './network';\r\n\r\n// ============================================================================\r\n// Constants\r\n// ============================================================================\r\n\r\nconst STORAGE_KEY = 'me-net-network';\r\nconst CURRENT_VERSION = '1.0.0';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface StorageResult<T> {\r\n  success: boolean;\r\n  data?: T;\r\n  error?: string;\r\n}\r\n\r\n// ============================================================================\r\n// Save\r\n// ============================================================================\r\n\r\n/**\r\n * Save a network to localStorage.\r\n * Adds version metadata for future migration support.\r\n */\r\nexport function saveNetwork(network: Network): StorageResult<void> {\r\n  try {\r\n    const networkWithVersion: Network = {\r\n      ...network,\r\n      version: CURRENT_VERSION,\r\n    };\r\n    const json = JSON.stringify(networkWithVersion);\r\n    localStorage.setItem(STORAGE_KEY, json);\r\n    return { success: true };\r\n  } catch (error) {\r\n    // Handle quota exceeded or other storage errors\r\n    const message = error instanceof Error ? error.message : 'Unknown storage error';\r\n    return { success: false, error: `Failed to save network: ${message}` };\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Load\r\n// ============================================================================\r\n\r\n/**\r\n * Load a network from localStorage.\r\n * Returns an empty network if no data exists.\r\n * Returns an error if data is corrupted.\r\n */\r\nexport function loadNetwork(): StorageResult<Network> {\r\n  try {\r\n    const json = localStorage.getItem(STORAGE_KEY);\r\n\r\n    // No existing data - return empty network\r\n    if (json === null) {\r\n      return { success: true, data: createEmptyNetwork() };\r\n    }\r\n\r\n    // Parse JSON\r\n    const parsed: unknown = JSON.parse(json);\r\n\r\n    // Validate structure\r\n    const validation = validateNetworkStructure(parsed);\r\n    if (!validation.valid) {\r\n      return { success: false, error: `Invalid network data: ${validation.error}` };\r\n    }\r\n\r\n    return { success: true, data: parsed as Network };\r\n  } catch (error) {\r\n    // JSON parse error or other issues\r\n    const message = error instanceof Error ? error.message : 'Unknown error';\r\n    return { success: false, error: `Failed to load network: ${message}` };\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Clear\r\n// ============================================================================\r\n\r\n/**\r\n * Clear all network data from localStorage.\r\n */\r\nexport function clearNetwork(): StorageResult<void> {\r\n  try {\r\n    localStorage.removeItem(STORAGE_KEY);\r\n    return { success: true };\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Unknown error';\r\n    return { success: false, error: `Failed to clear network: ${message}` };\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Validation\r\n// ============================================================================\r\n\r\ninterface ValidationResult {\r\n  valid: boolean;\r\n  error?: string;\r\n}\r\n\r\n/**\r\n * Validate that parsed JSON has the required Network structure.\r\n * Does not validate individual entity attributes (that's for CRUD layer).\r\n */\r\nexport function validateNetworkStructure(data: unknown): ValidationResult {\r\n  if (data === null || typeof data !== 'object') {\r\n    return { valid: false, error: 'Data must be an object' };\r\n  }\r\n\r\n  const obj = data as Record<string, unknown>;\r\n\r\n  // Check required arrays exist\r\n  if (!Array.isArray(obj.behaviours)) {\r\n    return { valid: false, error: 'Missing or invalid \"behaviours\" array' };\r\n  }\r\n  if (!Array.isArray(obj.outcomes)) {\r\n    return { valid: false, error: 'Missing or invalid \"outcomes\" array' };\r\n  }\r\n  if (!Array.isArray(obj.values)) {\r\n    return { valid: false, error: 'Missing or invalid \"values\" array' };\r\n  }\r\n  if (!Array.isArray(obj.links)) {\r\n    return { valid: false, error: 'Missing or invalid \"links\" array' };\r\n  }\r\n\r\n  // Check version exists (string)\r\n  if (typeof obj.version !== 'string') {\r\n    return { valid: false, error: 'Missing or invalid \"version\" string' };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\n// ============================================================================\r\n// Export for testing\r\n// ============================================================================\r\n\r\nexport const STORAGE_KEY_FOR_TESTING = STORAGE_KEY;\r\n","/**\r\n * Export & Import Module for M-E Net\r\n *\r\n * Handles network data export to JSON files, summary report generation,\r\n * and import with validation. See spec.md requirements E-1 through E-3.\r\n */\r\n\r\nimport type { Network, Node } from '@/types';\r\n\r\nimport { createNetwork } from './network';\r\nimport { validateNetworkStructure } from './storage';\r\n\r\n// ============================================================================\r\n// Constants\r\n// ============================================================================\r\n\r\nconst APP_VERSION = '1.0.0';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface ExportedNetwork extends Network {\r\n  exportedAt: string;\r\n  version: string;\r\n}\r\n\r\nexport interface ImportResult {\r\n  success: boolean;\r\n  network?: Network;\r\n  error?: string;\r\n}\r\n\r\nexport interface SummaryReportData {\r\n  generatedAt: string;\r\n  version: string;\r\n  stats: {\r\n    behaviours: number;\r\n    outcomes: number;\r\n    values: number;\r\n    links: number;\r\n  };\r\n  topLeverageBehaviours: Array<{\r\n    label: string;\r\n    score: number;\r\n    supportedValues: string[];\r\n    viaOutcomes: string[];\r\n  }>;\r\n  orphanValues: Array<{\r\n    label: string;\r\n  }>;\r\n  conflictBehaviours: Array<{\r\n    label: string;\r\n    conflictIndex: number;\r\n    positiveValues: string[];\r\n    negativeValues: string[];\r\n  }>;\r\n  suggestions: string[];\r\n}\r\n\r\n// ============================================================================\r\n// Export Network JSON\r\n// ============================================================================\r\n\r\n/**\r\n * Prepare network data for export with timestamp and version.\r\n */\r\nexport function prepareNetworkForExport(network: Network): ExportedNetwork {\r\n  return {\r\n    ...network,\r\n    version: APP_VERSION,\r\n    exportedAt: new Date().toISOString(),\r\n  };\r\n}\r\n\r\n/**\r\n * Serialize network to JSON string for export.\r\n */\r\nexport function serializeNetwork(network: Network): string {\r\n  const exportData = prepareNetworkForExport(network);\r\n  return JSON.stringify(exportData, null, 2);\r\n}\r\n\r\n/**\r\n * Generate a filename for the exported network.\r\n */\r\nexport function generateExportFilename(prefix: string = 'me-net'): string {\r\n  const now = new Date();\r\n  const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD\r\n  const timeStr = now.toISOString().slice(11, 19).replace(/:/g, '-'); // HH-MM-SS\r\n  return `${prefix}-${dateStr}-${timeStr}.json`;\r\n}\r\n\r\n/**\r\n * Trigger browser download of network JSON file.\r\n */\r\nexport function downloadNetworkAsJson(network: Network): void {\r\n  const json = serializeNetwork(network);\r\n  const blob = new Blob([json], { type: 'application/json' });\r\n  const url = URL.createObjectURL(blob);\r\n\r\n  const a = document.createElement('a');\r\n  a.href = url;\r\n  a.download = generateExportFilename();\r\n  document.body.appendChild(a);\r\n  a.click();\r\n  document.body.removeChild(a);\r\n  URL.revokeObjectURL(url);\r\n}\r\n\r\n// ============================================================================\r\n// Import Network JSON\r\n// ============================================================================\r\n\r\n/**\r\n * Parse and validate imported JSON string.\r\n */\r\nexport function parseNetworkJson(jsonString: string): ImportResult {\r\n  try {\r\n    const parsed: unknown = JSON.parse(jsonString);\r\n\r\n    // Validate structure\r\n    const validation = validateNetworkStructure(parsed);\r\n    if (!validation.valid) {\r\n      return { success: false, error: `Invalid network structure: ${validation.error}` };\r\n    }\r\n\r\n    // Additional validation for entity structure\r\n    const obj = parsed as Record<string, unknown>;\r\n    const entityValidation = validateEntityStructures(obj);\r\n    if (!entityValidation.valid) {\r\n      return { success: false, error: entityValidation.error };\r\n    }\r\n\r\n    // Create network from parsed data\r\n    const network = createNetwork({\r\n      version: obj.version as string,\r\n      exportedAt: obj.exportedAt as string | undefined,\r\n      behaviours: obj.behaviours as Network['behaviours'],\r\n      outcomes: obj.outcomes as Network['outcomes'],\r\n      values: obj.values as Network['values'],\r\n      links: obj.links as Network['links'],\r\n    });\r\n\r\n    return { success: true, network };\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Unknown parse error';\r\n    return { success: false, error: `Failed to parse JSON: ${message}` };\r\n  }\r\n}\r\n\r\n/**\r\n * Validate that entity arrays contain properly structured items.\r\n */\r\nfunction validateEntityStructures(data: Record<string, unknown>): { valid: boolean; error?: string } {\r\n  // Validate behaviours\r\n  const behaviours = data.behaviours as unknown[];\r\n  for (let i = 0; i < behaviours.length; i++) {\r\n    const b = behaviours[i] as Record<string, unknown>;\r\n    const bId = b.id;\r\n    const bLabel = b.label;\r\n    if (typeof bId !== 'string' || bId === '') {\r\n      return { valid: false, error: `Behaviour at index ${i} missing valid id` };\r\n    }\r\n    if (typeof bLabel !== 'string' || bLabel === '') {\r\n      return { valid: false, error: `Behaviour \"${bId}\" missing valid label` };\r\n    }\r\n    if (b.type !== 'behaviour') {\r\n      return { valid: false, error: `Behaviour \"${bId}\" has invalid type` };\r\n    }\r\n  }\r\n\r\n  // Validate outcomes\r\n  const outcomes = data.outcomes as unknown[];\r\n  for (let i = 0; i < outcomes.length; i++) {\r\n    const o = outcomes[i] as Record<string, unknown>;\r\n    const oId = o.id;\r\n    const oLabel = o.label;\r\n    if (typeof oId !== 'string' || oId === '') {\r\n      return { valid: false, error: `Outcome at index ${i} missing valid id` };\r\n    }\r\n    if (typeof oLabel !== 'string' || oLabel === '') {\r\n      return { valid: false, error: `Outcome \"${oId}\" missing valid label` };\r\n    }\r\n    if (o.type !== 'outcome') {\r\n      return { valid: false, error: `Outcome \"${oId}\" has invalid type` };\r\n    }\r\n  }\r\n\r\n  // Validate values\r\n  const values = data.values as unknown[];\r\n  for (let i = 0; i < values.length; i++) {\r\n    const v = values[i] as Record<string, unknown>;\r\n    const vId = v.id;\r\n    const vLabel = v.label;\r\n    if (typeof vId !== 'string' || vId === '') {\r\n      return { valid: false, error: `Value at index ${i} missing valid id` };\r\n    }\r\n    if (typeof vLabel !== 'string' || vLabel === '') {\r\n      return { valid: false, error: `Value \"${vId}\" missing valid label` };\r\n    }\r\n    if (v.type !== 'value') {\r\n      return { valid: false, error: `Value \"${vId}\" has invalid type` };\r\n    }\r\n  }\r\n\r\n  // Validate links\r\n  const links = data.links as unknown[];\r\n  for (let i = 0; i < links.length; i++) {\r\n    const l = links[i] as Record<string, unknown>;\r\n    const lId = l.id;\r\n    const lSourceId = l.sourceId;\r\n    const lTargetId = l.targetId;\r\n    if (typeof lId !== 'string' || lId === '') {\r\n      return { valid: false, error: `Link at index ${i} missing valid id` };\r\n    }\r\n    if (typeof lSourceId !== 'string' || lSourceId === '') {\r\n      return { valid: false, error: `Link \"${lId}\" missing valid sourceId` };\r\n    }\r\n    if (typeof lTargetId !== 'string' || lTargetId === '') {\r\n      return { valid: false, error: `Link \"${lId}\" missing valid targetId` };\r\n    }\r\n    if (l.type !== 'behaviour-outcome' && l.type !== 'outcome-value') {\r\n      return { valid: false, error: `Link \"${lId}\" has invalid type` };\r\n    }\r\n    if (l.valence !== 'positive' && l.valence !== 'negative') {\r\n      return { valid: false, error: `Link \"${lId}\" has invalid valence` };\r\n    }\r\n  }\r\n\r\n  // Validate referential integrity\r\n  const nodeIds = new Set<string>();\r\n  for (const b of behaviours) {\r\n    nodeIds.add((b as Record<string, unknown>).id as string);\r\n  }\r\n  for (const o of outcomes) {\r\n    nodeIds.add((o as Record<string, unknown>).id as string);\r\n  }\r\n  for (const v of values) {\r\n    nodeIds.add((v as Record<string, unknown>).id as string);\r\n  }\r\n\r\n  for (const l of links) {\r\n    const link = l as Record<string, unknown>;\r\n    const linkId = link.id as string;\r\n    const linkSourceId = link.sourceId as string;\r\n    const linkTargetId = link.targetId as string;\r\n    if (!nodeIds.has(linkSourceId)) {\r\n      return { valid: false, error: `Link \"${linkId}\" references non-existent source \"${linkSourceId}\"` };\r\n    }\r\n    if (!nodeIds.has(linkTargetId)) {\r\n      return { valid: false, error: `Link \"${linkId}\" references non-existent target \"${linkTargetId}\"` };\r\n    }\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n\r\n/**\r\n * Read file and parse as network JSON.\r\n */\r\nexport function importNetworkFromFile(file: File): Promise<ImportResult> {\r\n  return new Promise((resolve) => {\r\n    const reader = new FileReader();\r\n\r\n    reader.onload = (event): void => {\r\n      const content = event.target?.result;\r\n      if (typeof content !== 'string') {\r\n        resolve({ success: false, error: 'Failed to read file content' });\r\n        return;\r\n      }\r\n      resolve(parseNetworkJson(content));\r\n    };\r\n\r\n    reader.onerror = (): void => {\r\n      resolve({ success: false, error: 'Failed to read file' });\r\n    };\r\n\r\n    reader.readAsText(file);\r\n  });\r\n}\r\n\r\n// ============================================================================\r\n// Summary Report Generation\r\n// ============================================================================\r\n\r\n/**\r\n * Generate summary report data from network and analysis.\r\n */\r\nexport function generateSummaryReportData(\r\n  network: Network,\r\n  topLeverage: Array<{\r\n    behaviour: { label: string };\r\n    metrics: { leverageScore: number };\r\n    supportedValues: Array<{ label: string }>;\r\n    viaOutcomes: string[];\r\n  }>,\r\n  orphanValues: Array<{ value: { label: string } }>,\r\n  conflictBehaviours: Array<{\r\n    behaviour: { label: string };\r\n    metrics: { conflictIndex: number };\r\n    positiveValues: Array<{ label: string }>;\r\n    negativeValues: Array<{ label: string }>;\r\n  }>\r\n): SummaryReportData {\r\n  const suggestions: string[] = [];\r\n\r\n  // Generate suggestions based on analysis\r\n  if (orphanValues.length > 0) {\r\n    suggestions.push(\r\n      `You have ${orphanValues.length} orphan value${orphanValues.length > 1 ? 's' : ''} with no supporting behaviours. Consider using Why Ladder to connect behaviours to these values.`\r\n    );\r\n  }\r\n\r\n  if (conflictBehaviours.length > 0) {\r\n    suggestions.push(\r\n      `You have ${conflictBehaviours.length} behaviour${conflictBehaviours.length > 1 ? 's' : ''} with conflicting effects. Review these trade-offs and consider if alternatives exist.`\r\n    );\r\n  }\r\n\r\n  const unexplainedBehaviours = network.behaviours.filter(\r\n    (b) => !network.links.some((l) => l.sourceId === b.id)\r\n  );\r\n  if (unexplainedBehaviours.length > 0) {\r\n    suggestions.push(\r\n      `You have ${unexplainedBehaviours.length} behaviour${unexplainedBehaviours.length > 1 ? 's' : ''} without outcomes. Use Why Ladder to explore why you do these.`\r\n    );\r\n  }\r\n\r\n  const floatingOutcomes = network.outcomes.filter(\r\n    (o) => !network.links.some((l) => l.type === 'outcome-value' && l.sourceId === o.id)\r\n  );\r\n  if (floatingOutcomes.length > 0) {\r\n    suggestions.push(\r\n      `You have ${floatingOutcomes.length} outcome${floatingOutcomes.length > 1 ? 's' : ''} not connected to any value. Ask \"Why does this matter?\" to connect them.`\r\n    );\r\n  }\r\n\r\n  const topBehaviour = topLeverage[0];\r\n  if (topBehaviour !== undefined && topBehaviour.metrics.leverageScore > 0) {\r\n    suggestions.push(\r\n      `Your highest-leverage behaviour is \"${topBehaviour.behaviour.label}\". Consider prioritising this action.`\r\n    );\r\n  }\r\n\r\n  if (suggestions.length === 0) {\r\n    suggestions.push('Your network looks complete! Continue refining link attributes for more accurate insights.');\r\n  }\r\n\r\n  return {\r\n    generatedAt: new Date().toISOString(),\r\n    version: APP_VERSION,\r\n    stats: {\r\n      behaviours: network.behaviours.length,\r\n      outcomes: network.outcomes.length,\r\n      values: network.values.length,\r\n      links: network.links.length,\r\n    },\r\n    topLeverageBehaviours: topLeverage.map((item) => ({\r\n      label: item.behaviour.label,\r\n      score: Math.round(item.metrics.leverageScore * 100) / 100,\r\n      supportedValues: item.supportedValues.map((v) => v.label),\r\n      viaOutcomes: item.viaOutcomes,\r\n    })),\r\n    orphanValues: orphanValues.map((item) => ({ label: item.value.label })),\r\n    conflictBehaviours: conflictBehaviours.map((item) => ({\r\n      label: item.behaviour.label,\r\n      conflictIndex: Math.round(item.metrics.conflictIndex * 100) / 100,\r\n      positiveValues: item.positiveValues.map((v) => v.label),\r\n      negativeValues: item.negativeValues.map((v) => v.label),\r\n    })),\r\n    suggestions,\r\n  };\r\n}\r\n\r\n/**\r\n * Format summary report as Markdown.\r\n */\r\nexport function formatSummaryReportAsMarkdown(data: SummaryReportData): string {\r\n  const lines: string[] = [];\r\n\r\n  lines.push('# M-E Net Summary Report');\r\n  lines.push('');\r\n  lines.push(`> Generated: ${new Date(data.generatedAt).toLocaleString()}`);\r\n  lines.push(`> Version: ${data.version}`);\r\n  lines.push('');\r\n\r\n  // Network Statistics\r\n  lines.push('## Network Statistics');\r\n  lines.push('');\r\n  lines.push(`- **Behaviours:** ${data.stats.behaviours}`);\r\n  lines.push(`- **Outcomes:** ${data.stats.outcomes}`);\r\n  lines.push(`- **Values:** ${data.stats.values}`);\r\n  lines.push(`- **Links:** ${data.stats.links}`);\r\n  lines.push('');\r\n\r\n  // Top Leverage Behaviours\r\n  lines.push('## Top Leverage Behaviours');\r\n  lines.push('');\r\n  if (data.topLeverageBehaviours.length === 0) {\r\n    lines.push('_No behaviours with positive leverage found._');\r\n  } else {\r\n    for (const item of data.topLeverageBehaviours) {\r\n      lines.push(`### ${item.label}`);\r\n      lines.push('');\r\n      lines.push(`- **Leverage Score:** ${item.score}`);\r\n      lines.push(`- **Supports Values:** ${item.supportedValues.join(', ') || 'None'}`);\r\n      lines.push(`- **Via Outcomes:** ${item.viaOutcomes.join(', ') || 'None'}`);\r\n      lines.push('');\r\n    }\r\n  }\r\n\r\n  // Orphan Values\r\n  lines.push('## Orphan Values');\r\n  lines.push('');\r\n  if (data.orphanValues.length === 0) {\r\n    lines.push('_All values are connected to behaviours. Great job!_');\r\n  } else {\r\n    lines.push('These values have no supporting behaviours:');\r\n    lines.push('');\r\n    for (const item of data.orphanValues) {\r\n      lines.push(`- ${item.label}`);\r\n    }\r\n  }\r\n  lines.push('');\r\n\r\n  // Conflict Behaviours\r\n  lines.push('## Conflict Behaviours');\r\n  lines.push('');\r\n  if (data.conflictBehaviours.length === 0) {\r\n    lines.push('_No conflicting behaviours detected._');\r\n  } else {\r\n    for (const item of data.conflictBehaviours) {\r\n      lines.push(`### ${item.label}`);\r\n      lines.push('');\r\n      lines.push(`- **Conflict Index:** ${item.conflictIndex}`);\r\n      lines.push(`- **Helps:** ${item.positiveValues.join(', ')}`);\r\n      lines.push(`- **Hurts:** ${item.negativeValues.join(', ')}`);\r\n      lines.push('');\r\n    }\r\n  }\r\n\r\n  // Suggestions\r\n  lines.push('## Suggested Next Steps');\r\n  lines.push('');\r\n  for (const suggestion of data.suggestions) {\r\n    lines.push(`- ${suggestion}`);\r\n  }\r\n  lines.push('');\r\n\r\n  lines.push('---');\r\n  lines.push('_Generated by M-E Net_');\r\n\r\n  return lines.join('\\n');\r\n}\r\n\r\n/**\r\n * Generate a filename for the summary report.\r\n */\r\nexport function generateReportFilename(): string {\r\n  const now = new Date();\r\n  const dateStr = now.toISOString().slice(0, 10);\r\n  return `me-net-report-${dateStr}.md`;\r\n}\r\n\r\n/**\r\n * Trigger browser download of summary report.\r\n */\r\nexport function downloadSummaryReport(\r\n  network: Network,\r\n  topLeverage: Array<{\r\n    behaviour: { label: string };\r\n    metrics: { leverageScore: number };\r\n    supportedValues: Array<{ label: string }>;\r\n    viaOutcomes: string[];\r\n  }>,\r\n  orphanValues: Array<{ value: { label: string } }>,\r\n  conflictBehaviours: Array<{\r\n    behaviour: { label: string };\r\n    metrics: { conflictIndex: number };\r\n    positiveValues: Array<{ label: string }>;\r\n    negativeValues: Array<{ label: string }>;\r\n  }>\r\n): void {\r\n  const data = generateSummaryReportData(network, topLeverage, orphanValues, conflictBehaviours);\r\n  const markdown = formatSummaryReportAsMarkdown(data);\r\n  const blob = new Blob([markdown], { type: 'text/markdown' });\r\n  const url = URL.createObjectURL(blob);\r\n\r\n  const a = document.createElement('a');\r\n  a.href = url;\r\n  a.download = generateReportFilename();\r\n  document.body.appendChild(a);\r\n  a.click();\r\n  document.body.removeChild(a);\r\n  URL.revokeObjectURL(url);\r\n}\r\n\r\n// ============================================================================\r\n// Comparison Utilities (for round-trip testing)\r\n// ============================================================================\r\n\r\n/**\r\n * Compare two networks for equality (ignoring exportedAt).\r\n */\r\nexport function networksAreEqual(a: Network, b: Network): boolean {\r\n  // Compare counts\r\n  if (a.behaviours.length !== b.behaviours.length) return false;\r\n  if (a.outcomes.length !== b.outcomes.length) return false;\r\n  if (a.values.length !== b.values.length) return false;\r\n  if (a.links.length !== b.links.length) return false;\r\n\r\n  // Compare behaviours by id\r\n  const aBehavioursById = new Map(a.behaviours.map((x) => [x.id, x]));\r\n  for (const bBehaviour of b.behaviours) {\r\n    const aBehaviour = aBehavioursById.get(bBehaviour.id);\r\n    if (!aBehaviour) return false;\r\n    if (!nodesAreEqual(aBehaviour, bBehaviour)) return false;\r\n  }\r\n\r\n  // Compare outcomes by id\r\n  const aOutcomesById = new Map(a.outcomes.map((x) => [x.id, x]));\r\n  for (const bOutcome of b.outcomes) {\r\n    const aOutcome = aOutcomesById.get(bOutcome.id);\r\n    if (!aOutcome) return false;\r\n    if (!nodesAreEqual(aOutcome, bOutcome)) return false;\r\n  }\r\n\r\n  // Compare values by id\r\n  const aValuesById = new Map(a.values.map((x) => [x.id, x]));\r\n  for (const bValue of b.values) {\r\n    const aValue = aValuesById.get(bValue.id);\r\n    if (!aValue) return false;\r\n    if (!nodesAreEqual(aValue, bValue)) return false;\r\n  }\r\n\r\n  // Compare links by id\r\n  const aLinksById = new Map(a.links.map((x) => [x.id, x]));\r\n  for (const bLink of b.links) {\r\n    const aLink = aLinksById.get(bLink.id);\r\n    if (!aLink) return false;\r\n    if (JSON.stringify(aLink) !== JSON.stringify(bLink)) return false;\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\n/**\r\n * Compare two nodes for equality.\r\n */\r\nfunction nodesAreEqual(a: Node, b: Node): boolean {\r\n  // Deep equality check (stringify handles nested objects like contextTags)\r\n  return JSON.stringify(a) === JSON.stringify(b);\r\n}\r\n","/**\r\n * Link CRUD Operations\r\n *\r\n * Functions for creating, reading, updating, and deleting Links.\r\n * Enforces layer constraints: Behaviour→Outcome or Outcome→Value only.\r\n */\r\n\r\nimport type {\r\n  Network,\r\n  Link,\r\n  BehaviourOutcomeLink,\r\n  OutcomeValueLink,\r\n  Valence,\r\n  Reliability,\r\n  Strength,\r\n} from '@/types';\r\nimport { generateId, now } from '@/utils/id';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface CreateBehaviourOutcomeLinkInput {\r\n  sourceId: string; // Behaviour ID\r\n  targetId: string; // Outcome ID\r\n  valence: Valence;\r\n  reliability: Reliability;\r\n}\r\n\r\nexport interface CreateOutcomeValueLinkInput {\r\n  sourceId: string; // Outcome ID\r\n  targetId: string; // Value ID\r\n  valence: Valence;\r\n  strength: Strength;\r\n}\r\n\r\nexport interface UpdateBehaviourOutcomeLinkInput {\r\n  valence?: Valence;\r\n  reliability?: Reliability;\r\n}\r\n\r\nexport interface UpdateOutcomeValueLinkInput {\r\n  valence?: Valence;\r\n  strength?: Strength;\r\n}\r\n\r\nexport interface CrudResult<T> {\r\n  success: boolean;\r\n  data?: T;\r\n  error?: string;\r\n}\r\n\r\n// ============================================================================\r\n// Create\r\n// ============================================================================\r\n\r\n/**\r\n * Add a Behaviour→Outcome link.\r\n */\r\nexport function addBehaviourOutcomeLink(\r\n  network: Network,\r\n  input: CreateBehaviourOutcomeLinkInput\r\n): CrudResult<{ network: Network; link: BehaviourOutcomeLink }> {\r\n  // Validate source is a Behaviour\r\n  const behaviour = network.behaviours.find((b) => b.id === input.sourceId);\r\n  if (!behaviour) {\r\n    return { success: false, error: `Behaviour with id \"${input.sourceId}\" not found` };\r\n  }\r\n\r\n  // Validate target is an Outcome\r\n  const outcome = network.outcomes.find((o) => o.id === input.targetId);\r\n  if (!outcome) {\r\n    return { success: false, error: `Outcome with id \"${input.targetId}\" not found` };\r\n  }\r\n\r\n  // Check for duplicate link\r\n  const existingLink = network.links.find(\r\n    (l) => l.sourceId === input.sourceId && l.targetId === input.targetId\r\n  );\r\n  if (existingLink) {\r\n    return {\r\n      success: false,\r\n      error: `A link from \"${behaviour.label}\" to \"${outcome.label}\" already exists`,\r\n    };\r\n  }\r\n\r\n  const link: BehaviourOutcomeLink = {\r\n    id: generateId('l'),\r\n    type: 'behaviour-outcome',\r\n    sourceId: input.sourceId,\r\n    targetId: input.targetId,\r\n    valence: input.valence,\r\n    reliability: input.reliability,\r\n    createdAt: now(),\r\n    updatedAt: now(),\r\n  };\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    links: [...network.links, link],\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork, link },\r\n  };\r\n}\r\n\r\n/**\r\n * Add an Outcome→Value link.\r\n */\r\nexport function addOutcomeValueLink(\r\n  network: Network,\r\n  input: CreateOutcomeValueLinkInput\r\n): CrudResult<{ network: Network; link: OutcomeValueLink }> {\r\n  // Validate source is an Outcome\r\n  const outcome = network.outcomes.find((o) => o.id === input.sourceId);\r\n  if (!outcome) {\r\n    return { success: false, error: `Outcome with id \"${input.sourceId}\" not found` };\r\n  }\r\n\r\n  // Validate target is a Value\r\n  const value = network.values.find((v) => v.id === input.targetId);\r\n  if (!value) {\r\n    return { success: false, error: `Value with id \"${input.targetId}\" not found` };\r\n  }\r\n\r\n  // Check for duplicate link\r\n  const existingLink = network.links.find(\r\n    (l) => l.sourceId === input.sourceId && l.targetId === input.targetId\r\n  );\r\n  if (existingLink) {\r\n    return {\r\n      success: false,\r\n      error: `A link from \"${outcome.label}\" to \"${value.label}\" already exists`,\r\n    };\r\n  }\r\n\r\n  const link: OutcomeValueLink = {\r\n    id: generateId('l'),\r\n    type: 'outcome-value',\r\n    sourceId: input.sourceId,\r\n    targetId: input.targetId,\r\n    valence: input.valence,\r\n    strength: input.strength,\r\n    createdAt: now(),\r\n    updatedAt: now(),\r\n  };\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    links: [...network.links, link],\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork, link },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Read\r\n// ============================================================================\r\n\r\n/**\r\n * Find a link by ID.\r\n */\r\nexport function getLinkById(network: Network, id: string): Link | undefined {\r\n  return network.links.find((l) => l.id === id);\r\n}\r\n\r\n/**\r\n * Get all links.\r\n */\r\nexport function getAllLinks(network: Network): Link[] {\r\n  return network.links;\r\n}\r\n\r\n/**\r\n * Get all links of a specific type.\r\n */\r\nexport function getLinksByType(\r\n  network: Network,\r\n  type: 'behaviour-outcome' | 'outcome-value'\r\n): Link[] {\r\n  return network.links.filter((l) => l.type === type);\r\n}\r\n\r\n/**\r\n * Get all outgoing links from a node.\r\n */\r\nexport function getOutgoingLinks(network: Network, nodeId: string): Link[] {\r\n  return network.links.filter((l) => l.sourceId === nodeId);\r\n}\r\n\r\n/**\r\n * Get all incoming links to a node.\r\n */\r\nexport function getIncomingLinks(network: Network, nodeId: string): Link[] {\r\n  return network.links.filter((l) => l.targetId === nodeId);\r\n}\r\n\r\n/**\r\n * Get links by valence.\r\n */\r\nexport function getLinksByValence(network: Network, valence: Valence): Link[] {\r\n  return network.links.filter((l) => l.valence === valence);\r\n}\r\n\r\n/**\r\n * Find link between two specific nodes.\r\n */\r\nexport function getLinkBetween(\r\n  network: Network,\r\n  sourceId: string,\r\n  targetId: string\r\n): Link | undefined {\r\n  return network.links.find((l) => l.sourceId === sourceId && l.targetId === targetId);\r\n}\r\n\r\n// ============================================================================\r\n// Update\r\n// ============================================================================\r\n\r\n/**\r\n * Update a Behaviour→Outcome link.\r\n */\r\nexport function updateBehaviourOutcomeLink(\r\n  network: Network,\r\n  id: string,\r\n  input: UpdateBehaviourOutcomeLinkInput\r\n): CrudResult<{ network: Network; link: BehaviourOutcomeLink }> {\r\n  const existingIndex = network.links.findIndex((l) => l.id === id);\r\n  if (existingIndex === -1) {\r\n    return { success: false, error: `Link with id \"${id}\" not found` };\r\n  }\r\n\r\n  const existingLink = network.links[existingIndex]!;\r\n  if (existingLink.type !== 'behaviour-outcome') {\r\n    return { success: false, error: `Link \"${id}\" is not a behaviour-outcome link` };\r\n  }\r\n\r\n  // Explicitly construct the updated link to satisfy type checker\r\n  const narrowedLink: BehaviourOutcomeLink = existingLink;\r\n  const updated: BehaviourOutcomeLink = {\r\n    id: narrowedLink.id,\r\n    type: 'behaviour-outcome',\r\n    sourceId: narrowedLink.sourceId,\r\n    targetId: narrowedLink.targetId,\r\n    valence: input.valence ?? narrowedLink.valence,\r\n    reliability: input.reliability ?? narrowedLink.reliability,\r\n    createdAt: narrowedLink.createdAt,\r\n    updatedAt: now(),\r\n  };\r\n\r\n  const updatedLinks = [...network.links];\r\n  updatedLinks[existingIndex] = updated;\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    links: updatedLinks,\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork, link: updated },\r\n  };\r\n}\r\n\r\n/**\r\n * Update an Outcome→Value link.\r\n */\r\nexport function updateOutcomeValueLink(\r\n  network: Network,\r\n  id: string,\r\n  input: UpdateOutcomeValueLinkInput\r\n): CrudResult<{ network: Network; link: OutcomeValueLink }> {\r\n  const existingIndex = network.links.findIndex((l) => l.id === id);\r\n  if (existingIndex === -1) {\r\n    return { success: false, error: `Link with id \"${id}\" not found` };\r\n  }\r\n\r\n  const existingLink = network.links[existingIndex]!;\r\n  if (existingLink.type !== 'outcome-value') {\r\n    return { success: false, error: `Link \"${id}\" is not an outcome-value link` };\r\n  }\r\n\r\n  // Explicitly construct the updated link to satisfy type checker\r\n  const narrowedLink: OutcomeValueLink = existingLink;\r\n  const updated: OutcomeValueLink = {\r\n    id: narrowedLink.id,\r\n    type: 'outcome-value',\r\n    sourceId: narrowedLink.sourceId,\r\n    targetId: narrowedLink.targetId,\r\n    valence: input.valence ?? narrowedLink.valence,\r\n    strength: input.strength ?? narrowedLink.strength,\r\n    createdAt: narrowedLink.createdAt,\r\n    updatedAt: now(),\r\n  };\r\n\r\n  const updatedLinks = [...network.links];\r\n  updatedLinks[existingIndex] = updated;\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    links: updatedLinks,\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork, link: updated },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Delete\r\n// ============================================================================\r\n\r\n/**\r\n * Delete a link by ID.\r\n */\r\nexport function deleteLink(\r\n  network: Network,\r\n  id: string\r\n): CrudResult<{ network: Network }> {\r\n  const existingIndex = network.links.findIndex((l) => l.id === id);\r\n  if (existingIndex === -1) {\r\n    return { success: false, error: `Link with id \"${id}\" not found` };\r\n  }\r\n\r\n  const updatedLinks = network.links.filter((l) => l.id !== id);\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    links: updatedLinks,\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork },\r\n  };\r\n}\r\n\r\n/**\r\n * Delete all links between two nodes.\r\n */\r\nexport function deleteLinkBetween(\r\n  network: Network,\r\n  sourceId: string,\r\n  targetId: string\r\n): CrudResult<{ network: Network }> {\r\n  const updatedLinks = network.links.filter(\r\n    (l) => !(l.sourceId === sourceId && l.targetId === targetId)\r\n  );\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    links: updatedLinks,\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork },\r\n  };\r\n}\r\n","/**\r\n * Outcome CRUD Operations\r\n *\r\n * Functions for creating, reading, updating, and deleting Outcomes.\r\n */\r\n\r\nimport type { Outcome, Network } from '@/types';\r\nimport { generateId, now } from '@/utils/id';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface CreateOutcomeInput {\r\n  label: string;\r\n  notes?: string;\r\n}\r\n\r\nexport interface UpdateOutcomeInput {\r\n  label?: string;\r\n  notes?: string;\r\n}\r\n\r\nexport interface CrudResult<T> {\r\n  success: boolean;\r\n  data?: T;\r\n  error?: string;\r\n}\r\n\r\n// ============================================================================\r\n// Create\r\n// ============================================================================\r\n\r\n/**\r\n * Add a new outcome to the network.\r\n * Returns the updated network and the new outcome.\r\n */\r\nexport function addOutcome(\r\n  network: Network,\r\n  input: CreateOutcomeInput\r\n): CrudResult<{ network: Network; outcome: Outcome }> {\r\n  // Validate label\r\n  const labelValidation = validateLabel(input.label, network);\r\n  if (!labelValidation.valid) {\r\n    return { success: false, error: labelValidation.error };\r\n  }\r\n\r\n  const outcome: Outcome = {\r\n    id: generateId('o'),\r\n    type: 'outcome',\r\n    label: input.label.trim(),\r\n    notes: input.notes,\r\n    createdAt: now(),\r\n    updatedAt: now(),\r\n  };\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    outcomes: [...network.outcomes, outcome],\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork, outcome },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Read\r\n// ============================================================================\r\n\r\n/**\r\n * Find an outcome by ID.\r\n */\r\nexport function getOutcomeById(network: Network, id: string): Outcome | undefined {\r\n  return network.outcomes.find((o) => o.id === id);\r\n}\r\n\r\n/**\r\n * Find an outcome by label (case-insensitive).\r\n */\r\nexport function getOutcomeByLabel(network: Network, label: string): Outcome | undefined {\r\n  const normalised = label.trim().toLowerCase();\r\n  return network.outcomes.find((o) => o.label.toLowerCase() === normalised);\r\n}\r\n\r\n/**\r\n * Get all outcomes.\r\n */\r\nexport function getAllOutcomes(network: Network): Outcome[] {\r\n  return network.outcomes;\r\n}\r\n\r\n// ============================================================================\r\n// Update\r\n// ============================================================================\r\n\r\n/**\r\n * Update an existing outcome.\r\n * Returns the updated network and outcome.\r\n */\r\nexport function updateOutcome(\r\n  network: Network,\r\n  id: string,\r\n  input: UpdateOutcomeInput\r\n): CrudResult<{ network: Network; outcome: Outcome }> {\r\n  const existingIndex = network.outcomes.findIndex((o) => o.id === id);\r\n  if (existingIndex === -1) {\r\n    return { success: false, error: `Outcome with id \"${id}\" not found` };\r\n  }\r\n\r\n  const existing = network.outcomes[existingIndex]!;\r\n\r\n  // Validate label uniqueness if changing label\r\n  if (input.label !== undefined && input.label.trim().toLowerCase() !== existing.label.toLowerCase()) {\r\n    const labelValidation = validateLabel(input.label, network);\r\n    if (!labelValidation.valid) {\r\n      return { success: false, error: labelValidation.error };\r\n    }\r\n  }\r\n\r\n  const updated: Outcome = {\r\n    ...existing,\r\n    label: input.label?.trim() ?? existing.label,\r\n    notes: input.notes ?? existing.notes,\r\n    updatedAt: now(),\r\n  };\r\n\r\n  const updatedOutcomes = [...network.outcomes];\r\n  updatedOutcomes[existingIndex] = updated;\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    outcomes: updatedOutcomes,\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork, outcome: updated },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Delete\r\n// ============================================================================\r\n\r\n/**\r\n * Delete an outcome and all its incident links.\r\n * Returns the updated network.\r\n */\r\nexport function deleteOutcome(\r\n  network: Network,\r\n  id: string\r\n): CrudResult<{ network: Network }> {\r\n  const existingIndex = network.outcomes.findIndex((o) => o.id === id);\r\n  if (existingIndex === -1) {\r\n    return { success: false, error: `Outcome with id \"${id}\" not found` };\r\n  }\r\n\r\n  // Remove outcome\r\n  const updatedOutcomes = network.outcomes.filter((o) => o.id !== id);\r\n\r\n  // Cascade delete: remove all links where this outcome is source OR target\r\n  const updatedLinks = network.links.filter(\r\n    (link) => link.sourceId !== id && link.targetId !== id\r\n  );\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    outcomes: updatedOutcomes,\r\n    links: updatedLinks,\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Validation\r\n// ============================================================================\r\n\r\ninterface ValidationResult {\r\n  valid: boolean;\r\n  error?: string;\r\n}\r\n\r\n/**\r\n * Validate outcome label (non-empty, unique within outcomes).\r\n */\r\nfunction validateLabel(label: string, network: Network): ValidationResult {\r\n  const trimmed = label.trim();\r\n\r\n  if (trimmed.length === 0) {\r\n    return { valid: false, error: 'Label cannot be empty' };\r\n  }\r\n\r\n  if (trimmed.length > 100) {\r\n    return { valid: false, error: 'Label cannot exceed 100 characters' };\r\n  }\r\n\r\n  // Check uniqueness (case-insensitive)\r\n  const exists = network.outcomes.some(\r\n    (o) => o.label.toLowerCase() === trimmed.toLowerCase()\r\n  );\r\n  if (exists) {\r\n    return { valid: false, error: `An outcome with label \"${trimmed}\" already exists` };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n","/**\r\n * Value CRUD Operations\r\n *\r\n * Functions for creating, reading, updating, and deleting Values.\r\n */\r\n\r\nimport type { Value, Network, Importance, Neglect } from '@/types';\r\nimport { generateId, now } from '@/utils/id';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\nexport interface CreateValueInput {\r\n  label: string;\r\n  importance: Importance;\r\n  neglect: Neglect;\r\n  notes?: string;\r\n}\r\n\r\nexport interface UpdateValueInput {\r\n  label?: string;\r\n  importance?: Importance;\r\n  neglect?: Neglect;\r\n  notes?: string;\r\n}\r\n\r\nexport interface CrudResult<T> {\r\n  success: boolean;\r\n  data?: T;\r\n  error?: string;\r\n}\r\n\r\n// ============================================================================\r\n// Create\r\n// ============================================================================\r\n\r\n/**\r\n * Add a new value to the network.\r\n * Returns the updated network and the new value.\r\n */\r\nexport function addValue(\r\n  network: Network,\r\n  input: CreateValueInput\r\n): CrudResult<{ network: Network; value: Value }> {\r\n  // Validate label\r\n  const labelValidation = validateLabel(input.label, network);\r\n  if (!labelValidation.valid) {\r\n    return { success: false, error: labelValidation.error };\r\n  }\r\n\r\n  const value: Value = {\r\n    id: generateId('v'),\r\n    type: 'value',\r\n    label: input.label.trim(),\r\n    importance: input.importance,\r\n    neglect: input.neglect,\r\n    notes: input.notes,\r\n    createdAt: now(),\r\n    updatedAt: now(),\r\n  };\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    values: [...network.values, value],\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork, value },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Read\r\n// ============================================================================\r\n\r\n/**\r\n * Find a value by ID.\r\n */\r\nexport function getValueById(network: Network, id: string): Value | undefined {\r\n  return network.values.find((v) => v.id === id);\r\n}\r\n\r\n/**\r\n * Find a value by label (case-insensitive).\r\n */\r\nexport function getValueByLabel(network: Network, label: string): Value | undefined {\r\n  const normalised = label.trim().toLowerCase();\r\n  return network.values.find((v) => v.label.toLowerCase() === normalised);\r\n}\r\n\r\n/**\r\n * Get all values.\r\n */\r\nexport function getAllValues(network: Network): Value[] {\r\n  return network.values;\r\n}\r\n\r\n/**\r\n * Get values filtered by importance level.\r\n */\r\nexport function getValuesByImportance(network: Network, importance: Importance): Value[] {\r\n  return network.values.filter((v) => v.importance === importance);\r\n}\r\n\r\n/**\r\n * Get values filtered by neglect level.\r\n */\r\nexport function getValuesByNeglect(network: Network, neglect: Neglect): Value[] {\r\n  return network.values.filter((v) => v.neglect === neglect);\r\n}\r\n\r\n// ============================================================================\r\n// Update\r\n// ============================================================================\r\n\r\n/**\r\n * Update an existing value.\r\n * Returns the updated network and value.\r\n */\r\nexport function updateValue(\r\n  network: Network,\r\n  id: string,\r\n  input: UpdateValueInput\r\n): CrudResult<{ network: Network; value: Value }> {\r\n  const existingIndex = network.values.findIndex((v) => v.id === id);\r\n  if (existingIndex === -1) {\r\n    return { success: false, error: `Value with id \"${id}\" not found` };\r\n  }\r\n\r\n  const existing = network.values[existingIndex]!;\r\n\r\n  // Validate label uniqueness if changing label\r\n  if (input.label !== undefined && input.label.trim().toLowerCase() !== existing.label.toLowerCase()) {\r\n    const labelValidation = validateLabel(input.label, network);\r\n    if (!labelValidation.valid) {\r\n      return { success: false, error: labelValidation.error };\r\n    }\r\n  }\r\n\r\n  const updated: Value = {\r\n    ...existing,\r\n    label: input.label?.trim() ?? existing.label,\r\n    importance: input.importance ?? existing.importance,\r\n    neglect: input.neglect ?? existing.neglect,\r\n    notes: input.notes ?? existing.notes,\r\n    updatedAt: now(),\r\n  };\r\n\r\n  const updatedValues = [...network.values];\r\n  updatedValues[existingIndex] = updated;\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    values: updatedValues,\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork, value: updated },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Delete\r\n// ============================================================================\r\n\r\n/**\r\n * Delete a value and all its incident links.\r\n * Returns the updated network.\r\n */\r\nexport function deleteValue(\r\n  network: Network,\r\n  id: string\r\n): CrudResult<{ network: Network }> {\r\n  const existingIndex = network.values.findIndex((v) => v.id === id);\r\n  if (existingIndex === -1) {\r\n    return { success: false, error: `Value with id \"${id}\" not found` };\r\n  }\r\n\r\n  // Remove value\r\n  const updatedValues = network.values.filter((v) => v.id !== id);\r\n\r\n  // Cascade delete: remove all links where this value is the target\r\n  const updatedLinks = network.links.filter((link) => link.targetId !== id);\r\n\r\n  const updatedNetwork: Network = {\r\n    ...network,\r\n    values: updatedValues,\r\n    links: updatedLinks,\r\n  };\r\n\r\n  return {\r\n    success: true,\r\n    data: { network: updatedNetwork },\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Validation\r\n// ============================================================================\r\n\r\ninterface ValidationResult {\r\n  valid: boolean;\r\n  error?: string;\r\n}\r\n\r\n/**\r\n * Validate value label (non-empty, unique within values).\r\n */\r\nfunction validateLabel(label: string, network: Network): ValidationResult {\r\n  const trimmed = label.trim();\r\n\r\n  if (trimmed.length === 0) {\r\n    return { valid: false, error: 'Label cannot be empty' };\r\n  }\r\n\r\n  if (trimmed.length > 100) {\r\n    return { valid: false, error: 'Label cannot exceed 100 characters' };\r\n  }\r\n\r\n  // Check uniqueness (case-insensitive)\r\n  const exists = network.values.some(\r\n    (v) => v.label.toLowerCase() === trimmed.toLowerCase()\r\n  );\r\n  if (exists) {\r\n    return { valid: false, error: `A value with label \"${trimmed}\" already exists` };\r\n  }\r\n\r\n  return { valid: true };\r\n}\r\n","/**\r\n * M-E Net Application Entry Point\r\n */\r\n\r\nimport './styles/main.css';\r\n\r\nimport { EmptyState } from './components/empty';\r\nimport { FilterPanel, type FilterState } from './components/filters';\r\nimport {\r\n  BehaviourForm,\r\n  BehaviourFormData,\r\n  LinkForm,\r\n  LinkFormData,\r\n  LinkType,\r\n  NodeDetailPanel,\r\n  OutcomeForm,\r\n  OutcomeFormData,\r\n  ValueForm,\r\n  ValueFormData,\r\n  behaviourToFormData,\r\n  outcomeToFormData,\r\n  valueToFormData,\r\n} from './components/forms';\r\nimport { NetworkGraph } from './components/graph';\r\nimport { InsightsPanel } from './components/insights';\r\nimport { LadderSession, WhyLadder } from './components/ladder';\r\nimport { ValidationPanel } from './components/validation';\r\nimport { WelcomeScreen } from './components/welcome';\r\nimport { addBehaviour, deleteBehaviour, updateBehaviour } from './data/behaviours';\r\nimport {\r\n  downloadNetworkAsJson,\r\n  downloadSummaryReport,\r\n  importNetworkFromFile,\r\n} from './data/export';\r\nimport {\r\n  addBehaviourOutcomeLink,\r\n  addOutcomeValueLink,\r\n  deleteLink,\r\n  updateBehaviourOutcomeLink,\r\n  updateOutcomeValueLink,\r\n} from './data/links';\r\nimport { createEmptyNetwork, isNetworkEmpty } from './data/network';\r\nimport { addOutcome, deleteOutcome, updateOutcome } from './data/outcomes';\r\nimport { loadNetwork, saveNetwork } from './data/storage';\r\nimport { addValue, deleteValue, updateValue } from './data/values';\r\nimport {\r\n  getConflictBehaviours,\r\n  getFragileValues,\r\n  getTopLeverageBehaviours,\r\n} from './metrics';\r\nimport type { Behaviour, Link, Network, Node, Outcome, Value } from './types';\r\nimport { WarningState, createEmptyWarningState } from './validation';\r\n\r\n// ============================================================================\r\n// Application State\r\n// ============================================================================\r\n\r\ninterface AppState {\r\n  network: Network;\r\n  selectedNodeId: string | null;\r\n  formMode: 'none' | 'create-behaviour' | 'create-outcome' | 'create-value' | 'create-link' | 'edit-node' | 'edit-link' | 'why-ladder';\r\n  editingNode: Node | null;\r\n  editingLink: Link | null;\r\n  linkType: LinkType | null;\r\n  preselectedSourceId: string | null;\r\n  preselectedTargetId: string | null;\r\n  ladderBehaviourId: string | null;\r\n}\r\n\r\nconst state: AppState = {\r\n  network: createEmptyNetwork(),\r\n  selectedNodeId: null,\r\n  formMode: 'none',\r\n  editingNode: null,\r\n  editingLink: null,\r\n  linkType: null,\r\n  preselectedSourceId: null,\r\n  preselectedTargetId: null,\r\n  ladderBehaviourId: null,\r\n};\r\n\r\nlet graph: NetworkGraph | null = null;\r\nlet detailPanel: NodeDetailPanel | null = null;\r\nlet whyLadderInstance: WhyLadder | null = null;\r\nlet validationPanel: ValidationPanel | null = null;\r\nlet insightsPanel: InsightsPanel | null = null;\r\nlet filterPanel: FilterPanel | null = null;\r\nlet warningState: WarningState = createEmptyWarningState();\r\nlet welcomeScreen: WelcomeScreen | null = null;\r\nlet emptyState: EmptyState | null = null;\r\nlet messagesContainer: HTMLElement | null = null;\r\nlet hasDismissedWelcome = false;\r\n\r\nconst WARNING_STATE_KEY = 'me-net-warnings';\r\nconst WELCOME_DISMISSED_KEY = 'me-net-welcome-dismissed';\r\nconst MESSAGE_TIMEOUT_MS = 8000;\r\n\r\ntype MessageType = 'info' | 'success' | 'error';\r\n\r\n// ============================================================================\r\n// Warning State Persistence\r\n// ============================================================================\r\n\r\nfunction loadWarningState(): WarningState {\r\n  try {\r\n    const data = localStorage.getItem(WARNING_STATE_KEY);\r\n    if (data !== null && data !== '') {\r\n      return JSON.parse(data) as WarningState;\r\n    }\r\n  } catch {\r\n    // Ignore parse errors\r\n  }\r\n  return createEmptyWarningState();\r\n}\r\n\r\nfunction saveWarningState(): void {\r\n  try {\r\n    localStorage.setItem(WARNING_STATE_KEY, JSON.stringify(warningState));\r\n  } catch {\r\n    // Ignore storage errors\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Messaging & Onboarding Helpers\r\n// ============================================================================\r\n\r\nfunction showAppMessage(type: MessageType, message: string): void {\r\n  if (!messagesContainer) return;\r\n\r\n  const messageEl = document.createElement('div');\r\n  messageEl.className = `app-message app-message-${type}`;\r\n  messageEl.setAttribute('role', type === 'error' ? 'alert' : 'status');\r\n\r\n  const textSpan = document.createElement('span');\r\n  textSpan.textContent = message;\r\n  messageEl.appendChild(textSpan);\r\n\r\n  const dismissButton = document.createElement('button');\r\n  dismissButton.type = 'button';\r\n  dismissButton.className = 'app-message-close';\r\n  dismissButton.setAttribute('aria-label', 'Dismiss message');\r\n  dismissButton.textContent = '×';\r\n  dismissButton.addEventListener('click', () => {\r\n    messageEl.remove();\r\n  });\r\n\r\n  messageEl.appendChild(dismissButton);\r\n  messagesContainer.appendChild(messageEl);\r\n\r\n  window.setTimeout(() => {\r\n    if (messageEl.parentElement === messagesContainer) {\r\n      messageEl.remove();\r\n    }\r\n  }, MESSAGE_TIMEOUT_MS);\r\n}\r\n\r\nfunction loadWelcomeState(): void {\r\n  try {\r\n    hasDismissedWelcome = localStorage.getItem(WELCOME_DISMISSED_KEY) === 'true';\r\n  } catch {\r\n    hasDismissedWelcome = false;\r\n  }\r\n}\r\n\r\nfunction setWelcomeDismissed(): void {\r\n  if (hasDismissedWelcome) return;\r\n  hasDismissedWelcome = true;\r\n  try {\r\n    localStorage.setItem(WELCOME_DISMISSED_KEY, 'true');\r\n  } catch {\r\n    // Ignore storage errors\r\n  }\r\n  welcomeScreen?.hide();\r\n}\r\n\r\nfunction updateWelcomeVisibility(): void {\r\n  if (!welcomeScreen) return;\r\n  if (!hasDismissedWelcome && isNetworkEmpty(state.network)) {\r\n    welcomeScreen.show();\r\n  } else {\r\n    welcomeScreen.hide();\r\n  }\r\n}\r\n\r\nfunction updateEmptyStateVisibility(): void {\r\n  if (!emptyState) return;\r\n  if (!hasDismissedWelcome && isNetworkEmpty(state.network)) {\r\n    emptyState.hide();\r\n    return;\r\n  }\r\n  if (isNetworkEmpty(state.network)) {\r\n    emptyState.show();\r\n  } else {\r\n    emptyState.hide();\r\n  }\r\n}\r\n\r\nfunction triggerImportDialog(): void {\r\n  document.getElementById('import-file-input')?.click();\r\n}\r\n\r\nfunction handleWelcomeStart(): void {\r\n  setWelcomeDismissed();\r\n  emptyState?.hide();\r\n  showCreateBehaviourForm();\r\n}\r\n\r\nfunction handleWelcomeImport(): void {\r\n  setWelcomeDismissed();\r\n  emptyState?.hide();\r\n  triggerImportDialog();\r\n}\r\n\r\nfunction handleEmptyStateAddBehaviour(): void {\r\n  setWelcomeDismissed();\r\n  emptyState?.hide();\r\n  showCreateBehaviourForm();\r\n}\r\n\r\nfunction handleEmptyStateWhyLadder(): void {\r\n  setWelcomeDismissed();\r\n  emptyState?.hide();\r\n  showWhyLadder();\r\n}\r\n\r\nfunction handleEmptyStateImport(): void {\r\n  setWelcomeDismissed();\r\n  emptyState?.hide();\r\n  triggerImportDialog();\r\n}\r\n\r\n// ============================================================================\r\n// State Management\r\n// ============================================================================\r\n\r\nfunction updateNetwork(newNetwork: Network): void {\r\n  state.network = newNetwork;\r\n  const saveResult = saveNetwork(newNetwork);\r\n  if (!saveResult.success && saveResult.error) {\r\n    showAppMessage('error', saveResult.error);\r\n  }\r\n  graph?.setNetwork(newNetwork);\r\n  detailPanel?.setNetwork(newNetwork);\r\n  validationPanel?.setNetwork(newNetwork);\r\n  insightsPanel?.setNetwork(newNetwork);\r\n  filterPanel?.setNetwork(newNetwork);\r\n  if (!hasDismissedWelcome && !isNetworkEmpty(newNetwork)) {\r\n    setWelcomeDismissed();\r\n  }\r\n  // Clear ladder instance when network changes externally (if active)\r\n  if (whyLadderInstance) {\r\n    whyLadderInstance = null;\r\n  }\r\n  updateEmptyStateVisibility();\r\n  updateWelcomeVisibility();\r\n}\r\n\r\nfunction selectNode(nodeId: string | null): void {\r\n  state.selectedNodeId = nodeId;\r\n  if (nodeId !== null && nodeId !== '') {\r\n    graph?.selectNode(nodeId);\r\n    const node = findNode(nodeId);\r\n    if (node) {\r\n      detailPanel?.show(node);\r\n    }\r\n  } else {\r\n    graph?.clearSelection();\r\n    detailPanel?.hide();\r\n  }\r\n}\r\n\r\nfunction findNode(id: string): Node | undefined {\r\n  return (\r\n    state.network.behaviours.find((b) => b.id === id) ??\r\n    state.network.outcomes.find((o) => o.id === id) ??\r\n    state.network.values.find((v) => v.id === id)\r\n  );\r\n}\r\n\r\nfunction findLink(id: string): Link | undefined {\r\n  return state.network.links.find((l) => l.id === id);\r\n}\r\n\r\n// ============================================================================\r\n// Form Handlers\r\n// ============================================================================\r\n\r\nfunction showCreateBehaviourForm(): void {\r\n  state.formMode = 'create-behaviour';\r\n  renderSidebar();\r\n}\r\n\r\nfunction showCreateOutcomeForm(): void {\r\n  state.formMode = 'create-outcome';\r\n  renderSidebar();\r\n}\r\n\r\nfunction showCreateValueForm(): void {\r\n  state.formMode = 'create-value';\r\n  renderSidebar();\r\n}\r\n\r\nfunction showCreateLinkForm(linkType: LinkType, preselectedSourceId?: string, preselectedTargetId?: string): void {\r\n  state.formMode = 'create-link';\r\n  state.linkType = linkType;\r\n  state.preselectedSourceId = preselectedSourceId ?? null;\r\n  state.preselectedTargetId = preselectedTargetId ?? null;\r\n  renderSidebar();\r\n}\r\n\r\nfunction showEditNodeForm(node: Node): void {\r\n  state.formMode = 'edit-node';\r\n  state.editingNode = node;\r\n  renderSidebar();\r\n}\r\n\r\nfunction showEditLinkForm(link: Link): void {\r\n  state.formMode = 'edit-link';\r\n  state.editingLink = link;\r\n  state.linkType = link.type;\r\n  renderSidebar();\r\n}\r\n\r\nfunction showWhyLadder(behaviourId?: string): void {\r\n  state.formMode = 'why-ladder';\r\n  state.ladderBehaviourId = behaviourId ?? null;\r\n  renderSidebar();\r\n}\r\n\r\nfunction hideForm(): void {\r\n  state.formMode = 'none';\r\n  state.editingNode = null;\r\n  state.editingLink = null;\r\n  state.linkType = null;\r\n  state.preselectedSourceId = null;\r\n  state.preselectedTargetId = null;\r\n  state.ladderBehaviourId = null;\r\n  whyLadderInstance = null;\r\n  renderSidebar();\r\n  updateEmptyStateVisibility();\r\n}\r\n\r\n// ============================================================================\r\n// Why Ladder Handlers\r\n// ============================================================================\r\n\r\nfunction handleLadderCreateBehaviour(label: string): Behaviour {\r\n  const result = addBehaviour(state.network, {\r\n    label,\r\n    frequency: 'occasionally',\r\n    cost: 'low',\r\n    contextTags: [],\r\n  });\r\n  if (result.success && result.data) {\r\n    updateNetwork(result.data.network);\r\n    return result.data.behaviour;\r\n  }\r\n  throw new Error('Failed to create behaviour');\r\n}\r\n\r\nfunction handleLadderCreateOutcome(label: string, behaviourId: string): Outcome {\r\n  // Create the outcome\r\n  const outcomeResult = addOutcome(state.network, { label });\r\n  if (!outcomeResult.success || !outcomeResult.data) {\r\n    throw new Error('Failed to create outcome');\r\n  }\r\n\r\n  // Link it to the behaviour\r\n  const linkResult = addBehaviourOutcomeLink(outcomeResult.data.network, {\r\n    sourceId: behaviourId,\r\n    targetId: outcomeResult.data.outcome.id,\r\n    valence: 'positive',\r\n    reliability: 'usually',\r\n  });\r\n  if (linkResult.success && linkResult.data) {\r\n    updateNetwork(linkResult.data.network);\r\n  }\r\n\r\n  return outcomeResult.data.outcome;\r\n}\r\n\r\nfunction handleLadderLinkOutcome(outcomeId: string, behaviourId: string): void {\r\n  const result = addBehaviourOutcomeLink(state.network, {\r\n    sourceId: behaviourId,\r\n    targetId: outcomeId,\r\n    valence: 'positive',\r\n    reliability: 'usually',\r\n  });\r\n  if (result.success && result.data) {\r\n    updateNetwork(result.data.network);\r\n  }\r\n}\r\n\r\nfunction handleLadderCreateValue(label: string, outcomeId: string): Value {\r\n  // Create the value\r\n  const valueResult = addValue(state.network, {\r\n    label,\r\n    importance: 'high',\r\n    neglect: 'adequately-met',\r\n  });\r\n  if (!valueResult.success || !valueResult.data) {\r\n    throw new Error('Failed to create value');\r\n  }\r\n\r\n  // Link it to the outcome\r\n  const linkResult = addOutcomeValueLink(valueResult.data.network, {\r\n    sourceId: outcomeId,\r\n    targetId: valueResult.data.value.id,\r\n    valence: 'positive',\r\n    strength: 'moderate',\r\n  });\r\n  if (linkResult.success && linkResult.data) {\r\n    updateNetwork(linkResult.data.network);\r\n  }\r\n\r\n  return valueResult.data.value;\r\n}\r\n\r\nfunction handleLadderLinkValue(valueId: string, outcomeId: string): void {\r\n  const result = addOutcomeValueLink(state.network, {\r\n    sourceId: outcomeId,\r\n    targetId: valueId,\r\n    valence: 'positive',\r\n    strength: 'moderate',\r\n  });\r\n  if (result.success && result.data) {\r\n    updateNetwork(result.data.network);\r\n  }\r\n}\r\n\r\nfunction handleLadderChainOutcome(label: string, _parentOutcomeId: string): Outcome {\r\n  // For MVP, we create a new outcome that will need to be explained\r\n  // The parent outcome is marked as explained when chaining\r\n  // In a full implementation, we might create outcome-to-outcome links\r\n  const outcomeResult = addOutcome(state.network, { label });\r\n  if (!outcomeResult.success || !outcomeResult.data) {\r\n    throw new Error('Failed to create chained outcome');\r\n  }\r\n  updateNetwork(outcomeResult.data.network);\r\n  return outcomeResult.data.outcome;\r\n}\r\n\r\nfunction handleLadderComplete(_session: LadderSession): void {\r\n  hideForm();\r\n}\r\n\r\nfunction handleLadderExit(_session: LadderSession): void {\r\n  hideForm();\r\n}\r\n\r\n// ============================================================================\r\n// CRUD Operations\r\n// ============================================================================\r\n\r\nfunction handleSaveBehaviour(data: BehaviourFormData): void {\r\n  if (state.formMode === 'edit-node' && state.editingNode?.type === 'behaviour') {\r\n    const result = updateBehaviour(state.network, state.editingNode.id, {\r\n      label: data.label,\r\n      frequency: data.frequency,\r\n      cost: data.cost,\r\n      contextTags: data.contextTags,\r\n      notes: data.notes || undefined,\r\n    });\r\n    if (result.success && result.data) {\r\n      updateNetwork(result.data.network);\r\n      selectNode(state.editingNode.id);\r\n    }\r\n  } else {\r\n    const result = addBehaviour(state.network, {\r\n      label: data.label,\r\n      frequency: data.frequency,\r\n      cost: data.cost,\r\n      contextTags: data.contextTags,\r\n      notes: data.notes || undefined,\r\n    });\r\n    if (result.success && result.data) {\r\n      updateNetwork(result.data.network);\r\n      selectNode(result.data.behaviour.id);\r\n    }\r\n  }\r\n  hideForm();\r\n}\r\n\r\nfunction handleSaveOutcome(data: OutcomeFormData): void {\r\n  if (state.formMode === 'edit-node' && state.editingNode?.type === 'outcome') {\r\n    const result = updateOutcome(state.network, state.editingNode.id, {\r\n      label: data.label,\r\n      notes: data.notes || undefined,\r\n    });\r\n    if (result.success && result.data) {\r\n      updateNetwork(result.data.network);\r\n      selectNode(state.editingNode.id);\r\n    }\r\n  } else {\r\n    const result = addOutcome(state.network, {\r\n      label: data.label,\r\n      notes: data.notes || undefined,\r\n    });\r\n    if (result.success && result.data) {\r\n      updateNetwork(result.data.network);\r\n      selectNode(result.data.outcome.id);\r\n    }\r\n  }\r\n  hideForm();\r\n}\r\n\r\nfunction handleSaveValue(data: ValueFormData): void {\r\n  if (state.formMode === 'edit-node' && state.editingNode?.type === 'value') {\r\n    const result = updateValue(state.network, state.editingNode.id, {\r\n      label: data.label,\r\n      importance: data.importance,\r\n      neglect: data.neglect,\r\n      notes: data.notes || undefined,\r\n    });\r\n    if (result.success && result.data) {\r\n      updateNetwork(result.data.network);\r\n      selectNode(state.editingNode.id);\r\n    }\r\n  } else {\r\n    const result = addValue(state.network, {\r\n      label: data.label,\r\n      importance: data.importance,\r\n      neglect: data.neglect,\r\n      notes: data.notes || undefined,\r\n    });\r\n    if (result.success && result.data) {\r\n      updateNetwork(result.data.network);\r\n      selectNode(result.data.value.id);\r\n    }\r\n  }\r\n  hideForm();\r\n}\r\n\r\nfunction handleSaveLink(data: LinkFormData): void {\r\n  if (state.formMode === 'edit-link' && state.editingLink) {\r\n    if (data.type === 'behaviour-outcome') {\r\n      const result = updateBehaviourOutcomeLink(state.network, state.editingLink.id, {\r\n        valence: data.valence,\r\n        reliability: data.reliability,\r\n      });\r\n      if (result.success && result.data) {\r\n        updateNetwork(result.data.network);\r\n      }\r\n    } else {\r\n      const result = updateOutcomeValueLink(state.network, state.editingLink.id, {\r\n        valence: data.valence,\r\n        strength: data.strength,\r\n      });\r\n      if (result.success && result.data) {\r\n        updateNetwork(result.data.network);\r\n      }\r\n    }\r\n  } else {\r\n    if (data.type === 'behaviour-outcome') {\r\n      const result = addBehaviourOutcomeLink(state.network, {\r\n        sourceId: data.sourceId,\r\n        targetId: data.targetId,\r\n        valence: data.valence,\r\n        reliability: data.reliability,\r\n      });\r\n      if (result.success && result.data) {\r\n        updateNetwork(result.data.network);\r\n      }\r\n    } else {\r\n      const result = addOutcomeValueLink(state.network, {\r\n        sourceId: data.sourceId,\r\n        targetId: data.targetId,\r\n        valence: data.valence,\r\n        strength: data.strength,\r\n      });\r\n      if (result.success && result.data) {\r\n        updateNetwork(result.data.network);\r\n      }\r\n    }\r\n  }\r\n  hideForm();\r\n}\r\n\r\nfunction handleDeleteNode(node: Node): void {\r\n  let result;\r\n  switch (node.type) {\r\n    case 'behaviour':\r\n      result = deleteBehaviour(state.network, node.id);\r\n      break;\r\n    case 'outcome':\r\n      result = deleteOutcome(state.network, node.id);\r\n      break;\r\n    case 'value':\r\n      result = deleteValue(state.network, node.id);\r\n      break;\r\n  }\r\n  if (result?.success && result.data) {\r\n    updateNetwork(result.data.network);\r\n    selectNode(null);\r\n  }\r\n  hideForm();\r\n}\r\n\r\nfunction handleDeleteLink(linkId: string): void {\r\n  const result = deleteLink(state.network, linkId);\r\n  if (result.success && result.data) {\r\n    updateNetwork(result.data.network);\r\n  }\r\n}\r\n\r\n/**\r\n * Handle filter state changes from FilterPanel.\r\n */\r\nfunction handleFilterChange(filter: FilterState): void {\r\n  if (!graph) return;\r\n\r\n  // Apply node type visibility\r\n  graph.setNodeTypeVisibility('behaviour', filter.nodeTypes.behaviour);\r\n  graph.setNodeTypeVisibility('outcome', filter.nodeTypes.outcome);\r\n  graph.setNodeTypeVisibility('value', filter.nodeTypes.value);\r\n\r\n  // Apply valence visibility\r\n  graph.setValenceVisibility('positive', filter.valence.positive);\r\n  graph.setValenceVisibility('negative', filter.valence.negative);\r\n\r\n  // Apply search query\r\n  graph.setSearchQuery(filter.searchQuery);\r\n\r\n  // Apply highlight mode\r\n  applyHighlightMode(filter.highlightMode);\r\n}\r\n\r\n/**\r\n * Apply highlight mode to the graph.\r\n */\r\nfunction applyHighlightMode(mode: FilterState['highlightMode']): void {\r\n  if (!graph) return;\r\n\r\n  if (mode === 'none') {\r\n    graph.clearHighlights();\r\n    return;\r\n  }\r\n\r\n  let nodeIds: Set<string>;\r\n\r\n  const collectDownstreamFromBehaviour = (behaviourId: string): Set<string> => {\r\n    const ids = new Set<string>();\r\n    ids.add(behaviourId);\r\n\r\n    // Behaviour -> Outcome\r\n    const outcomeIds = state.network.links\r\n      .filter((l) => l.type === 'behaviour-outcome' && l.sourceId === behaviourId)\r\n      .map((l) => l.targetId);\r\n    for (const outcomeId of outcomeIds) {\r\n      ids.add(outcomeId);\r\n    }\r\n\r\n    // Outcome -> Value\r\n    for (const outcomeId of outcomeIds) {\r\n      const valueIds = state.network.links\r\n        .filter((l) => l.type === 'outcome-value' && l.sourceId === outcomeId)\r\n        .map((l) => l.targetId);\r\n      for (const valueId of valueIds) {\r\n        ids.add(valueId);\r\n      }\r\n    }\r\n\r\n    return ids;\r\n  };\r\n\r\n  const collectUpstreamToValue = (valueId: string): Set<string> => {\r\n    const ids = new Set<string>();\r\n    ids.add(valueId);\r\n\r\n    // Outcome -> Value (incoming)\r\n    const outcomeIds = state.network.links\r\n      .filter((l) => l.type === 'outcome-value' && l.targetId === valueId)\r\n      .map((l) => l.sourceId);\r\n    for (const outcomeId of outcomeIds) {\r\n      ids.add(outcomeId);\r\n    }\r\n\r\n    // Behaviour -> Outcome (incoming)\r\n    for (const outcomeId of outcomeIds) {\r\n      const behaviourIds = state.network.links\r\n        .filter((l) => l.type === 'behaviour-outcome' && l.targetId === outcomeId)\r\n        .map((l) => l.sourceId);\r\n      for (const behaviourId of behaviourIds) {\r\n        ids.add(behaviourId);\r\n      }\r\n    }\r\n\r\n    return ids;\r\n  };\r\n\r\n  switch (mode) {\r\n    case 'leverage': {\r\n      const topBehaviours = getTopLeverageBehaviours(state.network, 5);\r\n      nodeIds = new Set();\r\n      for (const item of topBehaviours) {\r\n        for (const id of collectDownstreamFromBehaviour(item.behaviour.id)) {\r\n          nodeIds.add(id);\r\n        }\r\n      }\r\n      break;\r\n    }\r\n    case 'fragile': {\r\n      const fragileValues = getFragileValues(state.network);\r\n      nodeIds = new Set();\r\n      for (const item of fragileValues) {\r\n        for (const id of collectUpstreamToValue(item.value.id)) {\r\n          nodeIds.add(id);\r\n        }\r\n      }\r\n      break;\r\n    }\r\n    case 'conflicts': {\r\n      const conflicts = getConflictBehaviours(state.network);\r\n      nodeIds = new Set();\r\n      for (const item of conflicts) {\r\n        for (const id of collectDownstreamFromBehaviour(item.behaviour.id)) {\r\n          nodeIds.add(id);\r\n        }\r\n      }\r\n      break;\r\n    }\r\n    default:\r\n      nodeIds = new Set();\r\n  }\r\n\r\n  graph.setHighlightedNodes(nodeIds);\r\n}\r\n\r\n// ============================================================================\r\n// Export / Import Handlers\r\n// ============================================================================\r\n\r\nfunction handleExportJson(): void {\r\n  downloadNetworkAsJson(state.network);\r\n}\r\n\r\nfunction handleExportReport(): void {\r\n  const topLeverage = getTopLeverageBehaviours(state.network, 5);\r\n  const fragileValues = getFragileValues(state.network);\r\n  const conflictBehaviours = getConflictBehaviours(state.network);\r\n\r\n  downloadSummaryReport(state.network, topLeverage, fragileValues, conflictBehaviours);\r\n}\r\n\r\nfunction handleImportFile(event: Event): void {\r\n  const input = event.target as HTMLInputElement;\r\n  const file = input.files?.[0];\r\n  if (!file) return;\r\n\r\n  void importNetworkFromFile(file).then((result) => {\r\n    if (result.success && result.network) {\r\n      // Confirm before replacing\r\n      const nodeCount =\r\n        result.network.behaviours.length +\r\n        result.network.outcomes.length +\r\n        result.network.values.length;\r\n      const linkCount = result.network.links.length;\r\n\r\n      const confirmed = confirm(\r\n        `Import network with ${nodeCount} nodes and ${linkCount} links?\\n\\nThis will replace your current network.`\r\n      );\r\n\r\n      if (confirmed) {\r\n        updateNetwork(result.network);\r\n        // Re-render UI\r\n        renderSidebar();\r\n        showAppMessage('success', 'Network imported successfully.');\r\n      }\r\n    } else {\r\n      showAppMessage('error', result.error ?? 'Import failed due to an unknown error.');\r\n    }\r\n\r\n    // Reset file input so same file can be imported again\r\n    input.value = '';\r\n  });\r\n}\r\n\r\n// ============================================================================\r\n// Rendering\r\n// ============================================================================\r\n\r\nfunction renderSidebar(): void {\r\n  const sidebar = document.getElementById('sidebar');\r\n  if (sidebar === null) return;\r\n\r\n  const formContainer = sidebar.querySelector<HTMLElement>('.sidebar-form-container');\r\n  if (formContainer === null) return;\r\n\r\n  // Clear previous form\r\n  formContainer.innerHTML = '';\r\n\r\n  switch (state.formMode) {\r\n    case 'create-behaviour':\r\n      new BehaviourForm(formContainer, {\r\n        mode: 'create',\r\n        network: state.network,\r\n        callbacks: {\r\n          onSave: handleSaveBehaviour,\r\n          onCancel: hideForm,\r\n        },\r\n      });\r\n      break;\r\n\r\n    case 'create-outcome':\r\n      new OutcomeForm(formContainer, {\r\n        mode: 'create',\r\n        network: state.network,\r\n        callbacks: {\r\n          onSave: handleSaveOutcome,\r\n          onCancel: hideForm,\r\n        },\r\n      });\r\n      break;\r\n\r\n    case 'create-value':\r\n      new ValueForm(formContainer, {\r\n        mode: 'create',\r\n        network: state.network,\r\n        callbacks: {\r\n          onSave: handleSaveValue,\r\n          onCancel: hideForm,\r\n        },\r\n      });\r\n      break;\r\n\r\n    case 'create-link':\r\n      if (state.linkType) {\r\n        new LinkForm(formContainer, {\r\n          mode: 'create',\r\n          linkType: state.linkType,\r\n          network: state.network,\r\n          preselectedSourceId: state.preselectedSourceId ?? undefined,\r\n          preselectedTargetId: state.preselectedTargetId ?? undefined,\r\n          callbacks: {\r\n            onSave: handleSaveLink,\r\n            onCancel: hideForm,\r\n          },\r\n        });\r\n      }\r\n      break;\r\n\r\n    case 'edit-node':\r\n      if (state.editingNode) {\r\n        switch (state.editingNode.type) {\r\n          case 'behaviour':\r\n            new BehaviourForm(formContainer, {\r\n              mode: 'edit',\r\n              network: state.network,\r\n              initialData: behaviourToFormData(state.editingNode),\r\n              callbacks: {\r\n                onSave: handleSaveBehaviour,\r\n                onCancel: hideForm,\r\n                onDelete: (): void => handleDeleteNode(state.editingNode!),\r\n              },\r\n            });\r\n            break;\r\n          case 'outcome':\r\n            new OutcomeForm(formContainer, {\r\n              mode: 'edit',\r\n              network: state.network,\r\n              initialData: outcomeToFormData(state.editingNode),\r\n              callbacks: {\r\n                onSave: handleSaveOutcome,\r\n                onCancel: hideForm,\r\n                onDelete: (): void => handleDeleteNode(state.editingNode!),\r\n              },\r\n            });\r\n            break;\r\n          case 'value':\r\n            new ValueForm(formContainer, {\r\n              mode: 'edit',\r\n              network: state.network,\r\n              initialData: valueToFormData(state.editingNode),\r\n              callbacks: {\r\n                onSave: handleSaveValue,\r\n                onCancel: hideForm,\r\n                onDelete: (): void => handleDeleteNode(state.editingNode!),\r\n              },\r\n            });\r\n            break;\r\n        }\r\n      }\r\n      break;\r\n\r\n    case 'edit-link':\r\n      if (state.editingLink !== null && state.linkType !== null) {\r\n        new LinkForm(formContainer, {\r\n          mode: 'edit',\r\n          linkType: state.linkType,\r\n          network: state.network,\r\n          initialData:\r\n            state.editingLink.type === 'behaviour-outcome'\r\n              ? {\r\n                  type: 'behaviour-outcome',\r\n                  sourceId: state.editingLink.sourceId,\r\n                  targetId: state.editingLink.targetId,\r\n                  valence: state.editingLink.valence,\r\n                  reliability: state.editingLink.reliability,\r\n                }\r\n              : {\r\n                  type: 'outcome-value',\r\n                  sourceId: state.editingLink.sourceId,\r\n                  targetId: state.editingLink.targetId,\r\n                  valence: state.editingLink.valence,\r\n                  strength: state.editingLink.strength,\r\n                },\r\n          callbacks: {\r\n            onSave: handleSaveLink,\r\n            onCancel: hideForm,\r\n            onDelete: (): void => {\r\n              handleDeleteLink(state.editingLink!.id);\r\n              hideForm();\r\n            },\r\n          },\r\n        });\r\n      }\r\n      break;\r\n\r\n    case 'why-ladder':\r\n      // Initialize Why Ladder guided capture mode\r\n      whyLadderInstance = new WhyLadder(formContainer, {\r\n        network: state.network,\r\n        initialBehaviourId: state.ladderBehaviourId ?? undefined,\r\n        callbacks: {\r\n          onCreateBehaviour: handleLadderCreateBehaviour,\r\n          onSelectBehaviour: (_id: string): void => {\r\n            // Track selected behaviour in state\r\n          },\r\n          onCreateOutcome: handleLadderCreateOutcome,\r\n          onLinkOutcome: handleLadderLinkOutcome,\r\n          onCreateValue: handleLadderCreateValue,\r\n          onLinkValue: handleLadderLinkValue,\r\n          onChainOutcome: handleLadderChainOutcome,\r\n          onComplete: handleLadderComplete,\r\n          onExit: handleLadderExit,\r\n        },\r\n      });\r\n      break;\r\n\r\n    default:\r\n      // Show add buttons when no form is active\r\n      formContainer.innerHTML = `\r\n        <div class=\"sidebar-placeholder\">\r\n          <p>Add nodes to build your network:</p>\r\n          <div class=\"add-buttons\">\r\n            <button class=\"btn btn-behaviour\" id=\"btn-add-behaviour\" aria-label=\"Add behaviour\">Add Behaviour</button>\r\n            <button class=\"btn btn-outcome\" id=\"btn-add-outcome\" aria-label=\"Add outcome\">Add Outcome</button>\r\n            <button class=\"btn btn-value\" id=\"btn-add-value\" aria-label=\"Add value\">Add Value</button>\r\n          </div>\r\n          <hr class=\"sidebar-divider\" />\r\n          <p>Add connections:</p>\r\n          <div class=\"add-buttons\">\r\n            <button class=\"btn btn-link\" id=\"btn-add-bo-link\" aria-label=\"Add behaviour to outcome link\">Behaviour → Outcome Link</button>\r\n            <button class=\"btn btn-link\" id=\"btn-add-ov-link\" aria-label=\"Add outcome to value link\">Outcome → Value Link</button>\r\n          </div>\r\n          <hr class=\"sidebar-divider\" />\r\n          <p>Guided capture:</p>\r\n          <div class=\"add-buttons\">\r\n            <button class=\"btn btn-ladder\" id=\"btn-why-ladder\" aria-label=\"Start Why Ladder capture\">🪜 Why Ladder</button>\r\n          </div>\r\n        </div>\r\n      `;\r\n\r\n      // Bind add buttons\r\n      document.getElementById('btn-add-behaviour')?.addEventListener('click', showCreateBehaviourForm);\r\n      document.getElementById('btn-add-outcome')?.addEventListener('click', showCreateOutcomeForm);\r\n      document.getElementById('btn-add-value')?.addEventListener('click', showCreateValueForm);\r\n      document.getElementById('btn-add-bo-link')?.addEventListener('click', () => showCreateLinkForm('behaviour-outcome'));\r\n      document.getElementById('btn-add-ov-link')?.addEventListener('click', () => showCreateLinkForm('outcome-value'));\r\n      document.getElementById('btn-why-ladder')?.addEventListener('click', () => showWhyLadder());\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// Initialization\r\n// ============================================================================\r\n\r\nfunction init(): void {\r\n  const app = document.getElementById('app');\r\n  if (!app) return;\r\n  loadWelcomeState();\r\n\r\n  // Create app structure with sidebar\r\n  app.innerHTML = `\r\n    <div class=\"app-container\">\r\n      <header class=\"app-header\" role=\"banner\">\r\n        <h1>M-E Net</h1>\r\n        <p class=\"subtitle\">Means–Ends Network</p>\r\n        <div class=\"toolbar\" role=\"toolbar\" aria-label=\"Graph controls\">\r\n          <button id=\"btn-fit\" class=\"btn\" aria-label=\"Fit entire network to view\">Fit to View</button>\r\n          <button id=\"btn-reset\" class=\"btn\" aria-label=\"Reset zoom level\">Reset Zoom</button>\r\n          <span class=\"toolbar-separator\"></span>\r\n          <button id=\"btn-export-json\" class=\"btn btn-export\" aria-label=\"Export network as JSON\">Export JSON</button>\r\n          <button id=\"btn-export-report\" class=\"btn btn-export\" aria-label=\"Export summary report\">Export Report</button>\r\n          <button id=\"btn-import\" class=\"btn btn-import\" aria-label=\"Import network data\">Import</button>\r\n          <input type=\"file\" id=\"import-file-input\" accept=\".json\" style=\"display: none;\" aria-hidden=\"true\" />\r\n        </div>\r\n      </header>\r\n      <div id=\"app-messages\" class=\"app-messages\" role=\"region\" aria-live=\"polite\" aria-atomic=\"false\"></div>\r\n      <main class=\"app-main\" role=\"main\" aria-label=\"Network workspace\">\r\n        <aside id=\"sidebar\" class=\"sidebar\" aria-label=\"Network controls\">\r\n          <div class=\"sidebar-content\">\r\n            <h2 class=\"sidebar-title\">Filters</h2>\r\n            <div class=\"sidebar-filter-container\"></div>\r\n            <hr class=\"sidebar-divider\" />\r\n            <h2 class=\"sidebar-title\">Add / Edit</h2>\r\n            <div class=\"sidebar-form-container\"></div>\r\n            <hr class=\"sidebar-divider\" />\r\n            <h2 class=\"sidebar-title\">Validation</h2>\r\n            <div class=\"sidebar-validation-container\"></div>\r\n            <hr class=\"sidebar-divider\" />\r\n            <h2 class=\"sidebar-title\">Insights</h2>\r\n            <div class=\"sidebar-insights-container\"></div>\r\n          </div>\r\n        </aside>\r\n        <div id=\"graph-container\" class=\"graph-container\" role=\"region\" aria-label=\"Network diagram\"></div>\r\n        <aside id=\"detail-panel\" class=\"detail-panel hidden\" aria-label=\"Node details panel\"></aside>\r\n      </main>\r\n      <div id=\"overlay-root\" class=\"overlay-root\" aria-live=\"assertive\"></div>\r\n    </div>\r\n  `;\r\n  messagesContainer = document.getElementById('app-messages');\r\n\r\n  // Initialize graph\r\n  const graphContainer = document.getElementById('graph-container');\r\n  if (!graphContainer) return;\r\n\r\n  const overlayRoot = document.getElementById('overlay-root');\r\n  if (overlayRoot) {\r\n    welcomeScreen = new WelcomeScreen(overlayRoot, {\r\n      onGetStarted: handleWelcomeStart,\r\n      onImportData: handleWelcomeImport,\r\n    });\r\n  }\r\n\r\n  emptyState = new EmptyState(graphContainer, {\r\n    onAddBehaviour: handleEmptyStateAddBehaviour,\r\n    onStartWhyLadder: handleEmptyStateWhyLadder,\r\n    onImportData: handleEmptyStateImport,\r\n  });\r\n\r\n  const rect = graphContainer.getBoundingClientRect();\r\n  graph = new NetworkGraph(graphContainer, {\r\n    width: rect.width || 800,\r\n    height: rect.height || 600,\r\n  });\r\n\r\n  // Load network data\r\n  const result = loadNetwork();\r\n  if (!result.success && result.error) {\r\n    showAppMessage('error', result.error);\r\n  }\r\n  state.network = result.success && result.data ? result.data : createEmptyNetwork();\r\n  graph.setNetwork(state.network);\r\n  if (!isNetworkEmpty(state.network)) {\r\n    setWelcomeDismissed();\r\n  }\r\n  updateEmptyStateVisibility();\r\n  updateWelcomeVisibility();\r\n\r\n  // Load warning state\r\n  warningState = loadWarningState();\r\n\r\n  // Initialize detail panel\r\n  const detailPanelEl = document.getElementById('detail-panel');\r\n  if (detailPanelEl) {\r\n    detailPanel = new NodeDetailPanel(detailPanelEl, {\r\n      network: state.network,\r\n      callbacks: {\r\n        onEdit: (node): void => showEditNodeForm(node),\r\n        onDelete: (node): void => handleDeleteNode(node),\r\n        onAddLink: (nodeId, direction): void => {\r\n          const node = findNode(nodeId);\r\n          if (!node) return;\r\n\r\n          if (node.type === 'behaviour' && direction === 'outgoing') {\r\n            showCreateLinkForm('behaviour-outcome', nodeId);\r\n          } else if (node.type === 'outcome') {\r\n            if (direction === 'incoming') {\r\n              showCreateLinkForm('behaviour-outcome', undefined, nodeId);\r\n            } else {\r\n              showCreateLinkForm('outcome-value', nodeId);\r\n            }\r\n          } else if (node.type === 'value' && direction === 'incoming') {\r\n            showCreateLinkForm('outcome-value', undefined, nodeId);\r\n          }\r\n        },\r\n        onSelectNode: (nodeId): void => selectNode(nodeId),\r\n        onEditLink: (linkId): void => {\r\n          const link = findLink(linkId);\r\n          if (link) showEditLinkForm(link);\r\n        },\r\n        onDeleteLink: (linkId): void => handleDeleteLink(linkId),\r\n        onClose: (): void => selectNode(null),\r\n      },\r\n    });\r\n  }\r\n\r\n  // Initialize validation panel\r\n  const validationContainer = document.querySelector('.sidebar-validation-container');\r\n  if (validationContainer) {\r\n    validationPanel = new ValidationPanel(validationContainer as HTMLElement, {\r\n      network: state.network,\r\n      warningState,\r\n      callbacks: {\r\n        onSnooze: (_warningId): void => {\r\n          // Save warning state to localStorage\r\n          saveWarningState();\r\n        },\r\n        onDismiss: (_warningId): void => {\r\n          saveWarningState();\r\n        },\r\n        onUndismiss: (_warningId): void => {\r\n          saveWarningState();\r\n        },\r\n        onNavigateToNode: (nodeId): void => {\r\n          selectNode(nodeId);\r\n          // TODO: Add focusOnNode to NetworkGraph for smooth pan/zoom\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  // Initialize insights panel\r\n  const insightsContainer = document.querySelector('.sidebar-insights-container');\r\n  if (insightsContainer) {\r\n    insightsPanel = new InsightsPanel(insightsContainer as HTMLElement, {\r\n      network: state.network,\r\n      callbacks: {\r\n        onNavigateToNode: (nodeId): void => {\r\n          selectNode(nodeId);\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  // Initialize filter panel\r\n  const filterContainer = document.querySelector('.sidebar-filter-container');\r\n  if (filterContainer) {\r\n    filterPanel = new FilterPanel(filterContainer as HTMLElement, {\r\n      network: state.network,\r\n      callbacks: {\r\n        onFilterChange: (filter: FilterState): void => {\r\n          handleFilterChange(filter);\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  // Fit to view after initial render\r\n  setTimeout((): void => graph?.fitToView(), 100);\r\n\r\n  // Toolbar buttons\r\n  document.getElementById('btn-fit')?.addEventListener('click', (): void => graph?.fitToView());\r\n  document.getElementById('btn-reset')?.addEventListener('click', (): void => graph?.resetZoom());\r\n\r\n  // Export/Import buttons\r\n  document.getElementById('btn-export-json')?.addEventListener('click', handleExportJson);\r\n  document.getElementById('btn-export-report')?.addEventListener('click', handleExportReport);\r\n  document.getElementById('btn-import')?.addEventListener('click', (): void => {\r\n    triggerImportDialog();\r\n  });\r\n  document.getElementById('import-file-input')?.addEventListener('change', handleImportFile);\r\n\r\n  // Graph interaction handlers\r\n  graph.setOnNodeClick((graphNode): void => {\r\n    const node = findNode(graphNode.id);\r\n    if (node) {\r\n      selectNode(node.id);\r\n    }\r\n  });\r\n\r\n  graph.setOnBackgroundClick((): void => {\r\n    selectNode(null);\r\n  });\r\n\r\n  // Handle window resize\r\n  let resizeTimeout: number;\r\n  window.addEventListener('resize', (): void => {\r\n    clearTimeout(resizeTimeout);\r\n    resizeTimeout = window.setTimeout((): void => {\r\n      const newRect = graphContainer.getBoundingClientRect();\r\n      graph?.resize(newRect.width || 800, newRect.height || 600);\r\n    }, 100);\r\n  });\r\n\r\n  // Initial sidebar render\r\n  renderSidebar();\r\n}\r\n\r\n// Initialize app when DOM is ready\r\nif (document.readyState === 'loading') {\r\n  document.addEventListener('DOMContentLoaded', init);\r\n} else {\r\n  init();\r\n}\r\n"],"names":["EmptyState","container","callbacks","addBehaviourBtn","whyLadderBtn","importBtn","createDefaultFilterState","FilterPanel","options","network","nodeTypes","valence","searchQuery","highlightMode","behaviourCount","outcomeCount","valueCount","positiveCount","l","negativeCount","searchInput","e","clearBtn","behaviourCb","outcomeCb","valueCb","positiveCb","negativeCb","radio","resetBtn","text","div","defaultBehaviourFormData","behaviourToFormData","behaviour","defaultOutcomeFormData","outcomeToFormData","outcome","defaultValueFormData","valueToFormData","value","defaultBehaviourOutcomeLinkFormData","defaultOutcomeValueLinkFormData","frequencyOptions","costOptions","importanceOptions","neglectOptions","valenceOptions","reliabilityOptions","strengthOptions","getAutocompleteSuggestions","nodeType","query","excludeIds","normalizedQuery","nodes","node","validateLabel","label","existingLabels","currentLabel","trimmed","normalized","existing","linkExists","sourceId","targetId","link","getLabelsForType","b","o","v","getConnectedNodes","nodeId","connected","target","findNode","source","BehaviourForm","title","submitLabel","opt","form","labelInput","frequencySelect","costSelect","tagsInput","notesTextarea","cancelBtn","deleteBtn","tag","field","error","labelError","OutcomeForm","ValueForm","importanceSelect","neglectSelect","LinkForm","id","sourceTypeLabel","targetTypeLabel","attributeField","sourceInput","targetInput","sourceDropdown","targetDropdown","valenceSelect","clearSourceBtn","clearTargetBtn","reliabilitySelect","strengthSelect","dropdown","item","el","s","sourceError","targetError","srcErr","tgtErr","NodeDetailPanel","updated","connectedNodes","incoming","n","outgoing","typeLabel","typeClass","freqLabel","costLabel","t","impLabel","negLabel","connections","direction","conn","valenceClass","strengthLabel","buttons","type","closeBtn","editBtn","addIncomingBtn","addOutgoingBtn","linkId","normalizeReliability","reliability","normalizeStrength","strength","networkToGraphData","behaviourNodes","outcomeNodes","valueNodes","edges","getConnectedNodeIds","graphData","edge","getConnectedEdgeIds","truncateLabel","maxLength","createDefs","svg","theme","defs","getNodeConfig","renderRectNode","group","config","renderDiamondNode","halfW","halfH","points","p","renderCircleNode","radius","renderNodeShape","d","g","d3.select","renderNodeLabel","getNodeBoundaryPoint","targetX","targetY","nodeX","nodeY","dx","dy","angle","tanAngle","bx","by","absAngle","defaultTheme","defaultLayeredLayout","defaultGraphOptions","edgeWidthScale","edgeOpacityScale","getEdgeWidth","getEdgeOpacity","generateEdgePath","sourceX","sourceY","sourcePoint","targetPoint","len","arrowOffset","adjustedTarget","renderEdges","edgeGroup","edgeSelection","edgeMerge","path","valenceConfig","updateEdgePaths","LAYER_COLUMN","applyLayeredLayout","canvasWidth","canvasHeight","columns","col","totalWidth","startX","columnX","nodesInColumn","columnHeight","startY","index","sortNodesByConnectivity","adjacency","behaviours","outcomes","values","a","aCount","getAverageOutcomeY","sum","count","outId","getAverageOutcomeYForValue","LEGEND_PADDING","LEGEND_ROW_HEIGHT","ICON_SIZE","ICON_TEXT_GAP","SECTION_GAP","renderLegend","legend","bgRect","currentY","renderLegendNodeItem","renderLegendEdgeItem","renderLegendStrengthItem","x","y","iconX","iconY","stroke","dasharray","width","opacity","NetworkGraph","d3.zoom","event","tagName","nodeLookup","sourceNode","targetNode","height","bounds","padding","scale","centerX","centerY","transform","d3.zoomIdentity","selection","callback","visible","nodeIds","_event","nodeEnter","selectedId","nodeTypeVisibility","valenceVisibility","searchActive","nodeById","modeHighlightedIds","hoverHighlightedIds","modeActive","hoverActive","activeHighlightedIds","isSelected","typeEnabled","matchesSearch","isHighlighted","dimByType","dimBySearch","dimByMode","dimByHover","isDimmed","valenceEnabled","sourceTypeEnabled","targetTypeEnabled","isHidden","isConnectedToSelected","isConnectedToActiveHighlight","dimByModeEdge","q","sourceMatchesSearch","targetMatchesSearch","minX","minY","maxX","maxY","RELIABILITY_VALUES","reliabilityToNumber","STRENGTH_VALUES","strengthToNumber","VALENCE_MULTIPLIERS","valenceToMultiplier","COST_VALUES","costToNumber","cost","IMPORTANCE_VALUES","importanceToNumber","importance","NEGLECT_VALUES","neglectToNumber","neglect","getBehaviours","getValues","getBehaviourOutcomeLinks","getOutcomeValueLinks","findValue","computeAllPaths","paths","boLinks","ovLinks","boLink","outcomeId","relatedOVLinks","ovLink","boValence","ovValence","combinedValence","effectiveValence","pathWeight","influence","groupPathsByBehaviour","allPaths","result","summary","groupPathsByValue","INFINITE_FRAGILITY","FRAGILITY_THRESHOLD","CONFLICT_THRESHOLD","TOP_LEVERAGE_COUNT","computeLeverageScore","computeCoverage","computeConflictIndex","computeFragilityScore","support","supportStrength","computeAllBehaviourMetrics","pathsByBehaviour","computeAllValueMetrics","pathsByValue","getTopLeverageBehaviours","behaviourMetrics","_","m","behaviourId","metrics","supportedValues","viaOutcomes","getFragileValues","threshold","valueMetrics","valueId","supportingBehaviours","getConflictBehaviours","positiveValues","negativeValues","analyzeNetwork","InsightsPanel","analysis","hasInsights","insights","isExpanded","isEmpty","html","insight","valueLabels","outcomeLabels","isOrphan","fragilityDisplay","behaviourLabels","positiveLabels","negativeLabels","header","section","createLadderSession","behaviourHasOutgoingLinks","getNextUnexplainedOutcome","session","i","countUnexplainedOutcomes","getSelectableBehaviours","onlyUnexplained","getLinkableOutcomes","linkedOutcomeIds","getLinkableValues","linkedValueIds","WhyLadder","availableOutcomes","addedCount","pendingOutcome","availableValues","remainingCount","unexplainedCount","input","createBtn","list","addBtn","backBtn","exitBtn","nextBtn","btn","valueInput","addValueBtn","chainInput","chainBtn","skipBtn","valueList","anotherBtn","doneBtn","step","newOutcome","next","currentIndex","DEFAULT_SNOOZE_DURATION_MS","generateWarningId","getSeverity","isWarningActive","warning","state","snoozedUntil","createEmptyValidationResult","createEmptyWarningState","findBehaviour","findOutcome","detectOrphanValues","warnings","outcomeIdsWithBehaviours","incomingOutcomeIds","detectUnexplainedBehaviours","behaviourIdsWithLinks","detectFloatingOutcomes","outcomeIdsWithDownstream","detectOutcomeLevelConflicts","negativeByBehaviour","negativeLinks","negativeOutcomes","outcomeNames","computePathsToValues","downstreamLinks","reliabilityWeight","getReliabilityWeight","strengthWeight","getStrengthWeight","valenceMultiplier","weight","detectValueLevelConflicts","behaviourPaths","positiveValueIds","negativeValueIds","positiveNames","negativeNames","validateNetwork","warningState","allWarnings","nodeWarnings","getActiveWarnings","w","ValidationPanel","activeWarnings","_result","activeCount","counts","groups","isDismissed","isSnoozed","warningId","snoozeUntil","WelcomeScreen","startBtn","generateId","prefix","timestamp","random","now","addBehaviour","labelValidation","updateBehaviour","existingIndex","updatedBehaviours","deleteBehaviour","updatedLinks","CURRENT_VERSION","createEmptyNetwork","createNetwork","partial","isNetworkEmpty","STORAGE_KEY","saveNetwork","networkWithVersion","json","loadNetwork","parsed","validation","validateNetworkStructure","data","obj","APP_VERSION","prepareNetworkForExport","serializeNetwork","exportData","generateExportFilename","dateStr","timeStr","downloadNetworkAsJson","blob","url","parseNetworkJson","jsonString","entityValidation","validateEntityStructures","bId","bLabel","oId","oLabel","vId","vLabel","links","lId","lSourceId","lTargetId","linkSourceId","linkTargetId","importNetworkFromFile","file","resolve","reader","content","generateSummaryReportData","topLeverage","orphanValues","conflictBehaviours","suggestions","unexplainedBehaviours","floatingOutcomes","topBehaviour","formatSummaryReportAsMarkdown","lines","suggestion","generateReportFilename","downloadSummaryReport","markdown","addBehaviourOutcomeLink","addOutcomeValueLink","updateBehaviourOutcomeLink","existingLink","narrowedLink","updateOutcomeValueLink","deleteLink","addOutcome","updateOutcome","updatedOutcomes","deleteOutcome","addValue","updateValue","updatedValues","deleteValue","graph","detailPanel","validationPanel","insightsPanel","filterPanel","welcomeScreen","emptyState","messagesContainer","hasDismissedWelcome","WARNING_STATE_KEY","WELCOME_DISMISSED_KEY","MESSAGE_TIMEOUT_MS","loadWarningState","saveWarningState","showAppMessage","message","messageEl","textSpan","dismissButton","loadWelcomeState","setWelcomeDismissed","updateWelcomeVisibility","updateEmptyStateVisibility","triggerImportDialog","handleWelcomeStart","showCreateBehaviourForm","handleWelcomeImport","handleEmptyStateAddBehaviour","handleEmptyStateWhyLadder","showWhyLadder","handleEmptyStateImport","updateNetwork","newNetwork","saveResult","selectNode","findLink","renderSidebar","showCreateOutcomeForm","showCreateValueForm","showCreateLinkForm","linkType","preselectedSourceId","preselectedTargetId","showEditNodeForm","showEditLinkForm","hideForm","handleLadderCreateBehaviour","handleLadderCreateOutcome","outcomeResult","linkResult","handleLadderLinkOutcome","handleLadderCreateValue","valueResult","handleLadderLinkValue","handleLadderChainOutcome","_parentOutcomeId","handleLadderComplete","_session","handleLadderExit","handleSaveBehaviour","handleSaveOutcome","handleSaveValue","handleSaveLink","handleDeleteNode","handleDeleteLink","handleFilterChange","filter","applyHighlightMode","mode","collectDownstreamFromBehaviour","ids","outcomeIds","valueIds","collectUpstreamToValue","behaviourIds","topBehaviours","fragileValues","conflicts","handleExportJson","handleExportReport","handleImportFile","nodeCount","linkCount","sidebar","formContainer","_id","init","app","graphContainer","overlayRoot","rect","detailPanelEl","validationContainer","_warningId","insightsContainer","filterContainer","graphNode","resizeTimeout","newRect"],"mappings":"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"}